<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title><title><no title></title></title>
  <meta http-equiv="content-type" content="text/html; charset=None">
  <link rel="stylesheet" href="..\..\_static\pygments.css" type="text/css">
</head>
<body>
<h2><title><no title></title></h2>

<div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">,</span> <span class="nx">factory</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">typeof</span> <span class="nx">exports</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">module</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;vega-lib&#39;</span><span class="p">),</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;vega-lite&#39;</span><span class="p">))</span> <span class="o">:</span>
  <span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span> <span class="o">?</span> <span class="nx">define</span><span class="p">([</span><span class="s1">&#39;vega-lib&#39;</span><span class="p">,</span> <span class="s1">&#39;vega-lite&#39;</span><span class="p">],</span> <span class="nx">factory</span><span class="p">)</span> <span class="o">:</span>
  <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">vegaEmbed</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">vega</span><span class="p">,</span><span class="nx">global</span><span class="p">.</span><span class="nx">vl</span><span class="p">));</span>
<span class="p">}(</span><span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">vegaImport</span><span class="p">,</span><span class="nx">vlImport</span><span class="p">)</span> <span class="p">{</span> <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">xhtml</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">namespaces</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">svg</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/2000/svg&quot;</span><span class="p">,</span>
    <span class="nx">xhtml</span><span class="o">:</span> <span class="nx">xhtml</span><span class="p">,</span>
    <span class="nx">xlink</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/1999/xlink&quot;</span><span class="p">,</span>
    <span class="nx">xml</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/XML/1998/namespace&quot;</span><span class="p">,</span>
    <span class="nx">xmlns</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/2000/xmlns/&quot;</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">namespace</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">name</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">prefix</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">prefix</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="o">!==</span> <span class="s2">&quot;xmlns&quot;</span><span class="p">)</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">namespaces</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="o">?</span> <span class="p">{</span><span class="nx">space</span><span class="o">:</span> <span class="nx">namespaces</span><span class="p">[</span><span class="nx">prefix</span><span class="p">],</span> <span class="nx">local</span><span class="o">:</span> <span class="nx">name</span><span class="p">}</span> <span class="o">:</span> <span class="nx">name</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">creatorInherit</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">,</span>
          <span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">namespaceURI</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">uri</span> <span class="o">===</span> <span class="nx">xhtml</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">namespaceURI</span> <span class="o">===</span> <span class="nx">xhtml</span>
          <span class="o">?</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
          <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElementNS</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">creatorFixed</span><span class="p">(</span><span class="nx">fullname</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">createElementNS</span><span class="p">(</span><span class="nx">fullname</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">fullname</span><span class="p">.</span><span class="nx">local</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">creator</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fullname</span> <span class="o">=</span> <span class="nx">namespace</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">fullname</span><span class="p">.</span><span class="nx">local</span>
        <span class="o">?</span> <span class="nx">creatorFixed</span>
        <span class="o">:</span> <span class="nx">creatorInherit</span><span class="p">)(</span><span class="nx">fullname</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">none</span><span class="p">()</span> <span class="p">{}</span>

  <span class="kd">function</span> <span class="nx">selector</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">selector</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">none</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_select</span><span class="p">(</span><span class="nx">select</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">select</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="nx">select</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">(</span><span class="nx">select</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_groups</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">subgroups</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">m</span><span class="p">),</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">subgroup</span> <span class="o">=</span> <span class="nx">subgroups</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">subnode</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">subnode</span> <span class="o">=</span> <span class="nx">select</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">group</span><span class="p">)))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;__data__&quot;</span> <span class="k">in</span> <span class="nx">node</span><span class="p">)</span> <span class="nx">subnode</span><span class="p">.</span><span class="nx">__data__</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">;</span>
          <span class="nx">subgroup</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">subnode</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Selection</span><span class="p">(</span><span class="nx">subgroups</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parents</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">empty</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selectorAll</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">selector</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">empty</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_selectAll</span><span class="p">(</span><span class="nx">select</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">select</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="nx">select</span> <span class="o">=</span> <span class="nx">selectorAll</span><span class="p">(</span><span class="nx">select</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_groups</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">subgroups</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">parents</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
          <span class="nx">subgroups</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">select</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">group</span><span class="p">));</span>
          <span class="nx">parents</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Selection</span><span class="p">(</span><span class="nx">subgroups</span><span class="p">,</span> <span class="nx">parents</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">matcher</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">matches</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">document</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">matches</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">vendorMatches</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">webkitMatchesSelector</span>
          <span class="o">||</span> <span class="nx">element</span><span class="p">.</span><span class="nx">msMatchesSelector</span>
          <span class="o">||</span> <span class="nx">element</span><span class="p">.</span><span class="nx">mozMatchesSelector</span>
          <span class="o">||</span> <span class="nx">element</span><span class="p">.</span><span class="nx">oMatchesSelector</span><span class="p">;</span>
      <span class="nx">matcher</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">vendorMatches</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">selector</span><span class="p">);</span>
        <span class="p">};</span>
      <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">matcher$1</span> <span class="o">=</span> <span class="nx">matcher</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">selection_filter</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">match</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">matcher$1</span><span class="p">(</span><span class="nx">match</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_groups</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">subgroups</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">m</span><span class="p">),</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">subgroup</span> <span class="o">=</span> <span class="nx">subgroups</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">match</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">group</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">subgroup</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Selection</span><span class="p">(</span><span class="nx">subgroups</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parents</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">sparse</span><span class="p">(</span><span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_enter</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Selection</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_enter</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">_groups</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">sparse</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parents</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">EnterNode</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">datum</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ownerDocument</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">namespaceURI</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">namespaceURI</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_next</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__data__</span> <span class="o">=</span> <span class="nx">datum</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">EnterNode</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="nx">EnterNode</span><span class="p">,</span>
    <span class="nx">appendChild</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parent</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_next</span><span class="p">);</span> <span class="p">},</span>
    <span class="nx">insertBefore</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parent</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span> <span class="p">},</span>
    <span class="nx">querySelector</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parent</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span> <span class="p">},</span>
    <span class="nx">querySelectorAll</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parent</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">constant</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">keyPrefix</span> <span class="o">=</span> <span class="s2">&quot;$&quot;</span><span class="p">;</span> <span class="c1">// Protect against keys like “__proto__”.</span>

  <span class="kd">function</span> <span class="nx">bindIndex</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">enter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">exit</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">node</span><span class="p">,</span>
        <span class="nx">groupLength</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">dataLength</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="c1">// Put any non-null nodes that fit into update.</span>
    <span class="c1">// Put any null nodes into enter.</span>
    <span class="c1">// Put any remaining data into enter.</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dataLength</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">update</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">enter</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EnterNode</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Put any non-null nodes that don’t fit into exit.</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">groupLength</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">exit</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">bindKey</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">enter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">exit</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span>
        <span class="nx">node</span><span class="p">,</span>
        <span class="nx">nodeByKeyValue</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">groupLength</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">dataLength</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">keyValues</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">groupLength</span><span class="p">),</span>
        <span class="nx">keyValue</span><span class="p">;</span>

    <span class="c1">// Compute the key for each node.</span>
    <span class="c1">// If multiple nodes have the same key, the duplicates are added to exit.</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">groupLength</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">keyValues</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">keyValue</span> <span class="o">=</span> <span class="nx">keyPrefix</span> <span class="o">+</span> <span class="nx">key</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">group</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">keyValue</span> <span class="k">in</span> <span class="nx">nodeByKeyValue</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">exit</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">nodeByKeyValue</span><span class="p">[</span><span class="nx">keyValue</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Compute the key for each datum.</span>
    <span class="c1">// If there a node associated with this key, join and add it to update.</span>
    <span class="c1">// If there is not (or the key is a duplicate), add it to enter.</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dataLength</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">keyValue</span> <span class="o">=</span> <span class="nx">keyPrefix</span> <span class="o">+</span> <span class="nx">key</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">nodeByKeyValue</span><span class="p">[</span><span class="nx">keyValue</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">update</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">nodeByKeyValue</span><span class="p">[</span><span class="nx">keyValue</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">enter</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EnterNode</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Add any remaining nodes that were not bound to data to exit.</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">groupLength</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">nodeByKeyValue</span><span class="p">[</span><span class="nx">keyValues</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">===</span> <span class="nx">node</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">exit</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_data</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">()),</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="nx">data</span><span class="p">[</span><span class="o">++</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span> <span class="p">});</span>
      <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">bind</span> <span class="o">=</span> <span class="nx">key</span> <span class="o">?</span> <span class="nx">bindKey</span> <span class="o">:</span> <span class="nx">bindIndex</span><span class="p">,</span>
        <span class="nx">parents</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parents</span><span class="p">,</span>
        <span class="nx">groups</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_groups</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">constant</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">m</span><span class="p">),</span> <span class="nx">enter</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">m</span><span class="p">),</span> <span class="nx">exit</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">m</span><span class="p">),</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">parents</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span>
          <span class="nx">group</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span>
          <span class="nx">groupLength</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
          <span class="nx">data</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">parents</span><span class="p">),</span>
          <span class="nx">dataLength</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
          <span class="nx">enterGroup</span> <span class="o">=</span> <span class="nx">enter</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">dataLength</span><span class="p">),</span>
          <span class="nx">updateGroup</span> <span class="o">=</span> <span class="nx">update</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">dataLength</span><span class="p">),</span>
          <span class="nx">exitGroup</span> <span class="o">=</span> <span class="nx">exit</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">groupLength</span><span class="p">);</span>

      <span class="nx">bind</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">enterGroup</span><span class="p">,</span> <span class="nx">updateGroup</span><span class="p">,</span> <span class="nx">exitGroup</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>

      <span class="c1">// Now connect the enter nodes to their following update node, such that</span>
      <span class="c1">// appendChild can insert the materialized enter node before this node,</span>
      <span class="c1">// rather than at the end of the parent node.</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">i1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">previous</span><span class="p">,</span> <span class="nx">next</span><span class="p">;</span> <span class="nx">i0</span> <span class="o">&lt;</span> <span class="nx">dataLength</span><span class="p">;</span> <span class="o">++</span><span class="nx">i0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">previous</span> <span class="o">=</span> <span class="nx">enterGroup</span><span class="p">[</span><span class="nx">i0</span><span class="p">])</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i0</span> <span class="o">&gt;=</span> <span class="nx">i1</span><span class="p">)</span> <span class="nx">i1</span> <span class="o">=</span> <span class="nx">i0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">next</span> <span class="o">=</span> <span class="nx">updateGroup</span><span class="p">[</span><span class="nx">i1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="nx">i1</span> <span class="o">&lt;</span> <span class="nx">dataLength</span><span class="p">);</span>
          <span class="nx">previous</span><span class="p">.</span><span class="nx">_next</span> <span class="o">=</span> <span class="nx">next</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Selection</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span> <span class="nx">parents</span><span class="p">);</span>
    <span class="nx">update</span><span class="p">.</span><span class="nx">_enter</span> <span class="o">=</span> <span class="nx">enter</span><span class="p">;</span>
    <span class="nx">update</span><span class="p">.</span><span class="nx">_exit</span> <span class="o">=</span> <span class="nx">exit</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">update</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_exit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Selection</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_exit</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">_groups</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">sparse</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parents</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_merge</span><span class="p">(</span><span class="nx">selection$$1</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">groups0</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_groups</span><span class="p">,</span> <span class="nx">groups1</span> <span class="o">=</span> <span class="nx">selection$$1</span><span class="p">.</span><span class="nx">_groups</span><span class="p">,</span> <span class="nx">m0</span> <span class="o">=</span> <span class="nx">groups0</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">m1</span> <span class="o">=</span> <span class="nx">groups1</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">m0</span><span class="p">,</span> <span class="nx">m1</span><span class="p">),</span> <span class="nx">merges</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">m0</span><span class="p">),</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group0</span> <span class="o">=</span> <span class="nx">groups0</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">group1</span> <span class="o">=</span> <span class="nx">groups1</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group0</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">merge</span> <span class="o">=</span> <span class="nx">merges</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group0</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">||</span> <span class="nx">group1</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
          <span class="nx">merge</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m0</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">merges</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">groups0</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Selection</span><span class="p">(</span><span class="nx">merges</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parents</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_order</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_groups</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">node</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="nx">next</span> <span class="o">!==</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">)</span> <span class="nx">next</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
          <span class="nx">next</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_sort</span><span class="p">(</span><span class="nx">compare</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">compare</span><span class="p">)</span> <span class="nx">compare</span> <span class="o">=</span> <span class="nx">ascending</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">compareNode</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">a</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span> <span class="o">?</span> <span class="nx">compare</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">__data__</span><span class="p">)</span> <span class="o">:</span> <span class="o">!</span><span class="nx">a</span> <span class="o">-</span> <span class="o">!</span><span class="nx">b</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_groups</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">sortgroups</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">m</span><span class="p">),</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">sortgroup</span> <span class="o">=</span> <span class="nx">sortgroups</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
          <span class="nx">sortgroup</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">sortgroup</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">compareNode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Selection</span><span class="p">(</span><span class="nx">sortgroups</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parents</span><span class="p">).</span><span class="nx">order</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">ascending</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">a</span> <span class="o">&gt;=</span> <span class="nx">b</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="kc">NaN</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_call</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_nodes</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">()),</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">nodes</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_node</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_groups</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_size</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="o">++</span><span class="nx">size</span><span class="p">;</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">size</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_empty</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_each</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_groups</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">node</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">group</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrRemove</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrRemoveNS</span><span class="p">(</span><span class="nx">fullname</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">removeAttributeNS</span><span class="p">(</span><span class="nx">fullname</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">fullname</span><span class="p">.</span><span class="nx">local</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrConstant</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrConstantNS</span><span class="p">(</span><span class="nx">fullname</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setAttributeNS</span><span class="p">(</span><span class="nx">fullname</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">fullname</span><span class="p">.</span><span class="nx">local</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrFunction</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrFunctionNS</span><span class="p">(</span><span class="nx">fullname</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">removeAttributeNS</span><span class="p">(</span><span class="nx">fullname</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">fullname</span><span class="p">.</span><span class="nx">local</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">setAttributeNS</span><span class="p">(</span><span class="nx">fullname</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">fullname</span><span class="p">.</span><span class="nx">local</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_attr</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fullname</span> <span class="o">=</span> <span class="nx">namespace</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">fullname</span><span class="p">.</span><span class="nx">local</span>
          <span class="o">?</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttributeNS</span><span class="p">(</span><span class="nx">fullname</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">fullname</span><span class="p">.</span><span class="nx">local</span><span class="p">)</span>
          <span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">fullname</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">((</span><span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span>
        <span class="o">?</span> <span class="p">(</span><span class="nx">fullname</span><span class="p">.</span><span class="nx">local</span> <span class="o">?</span> <span class="nx">attrRemoveNS</span> <span class="o">:</span> <span class="nx">attrRemove</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
        <span class="o">?</span> <span class="p">(</span><span class="nx">fullname</span><span class="p">.</span><span class="nx">local</span> <span class="o">?</span> <span class="nx">attrFunctionNS</span> <span class="o">:</span> <span class="nx">attrFunction</span><span class="p">)</span>
        <span class="o">:</span> <span class="p">(</span><span class="nx">fullname</span><span class="p">.</span><span class="nx">local</span> <span class="o">?</span> <span class="nx">attrConstantNS</span> <span class="o">:</span> <span class="nx">attrConstant</span><span class="p">)))(</span><span class="nx">fullname</span><span class="p">,</span> <span class="nx">value</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">defaultView</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">ownerDocument</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">defaultView</span><span class="p">)</span> <span class="c1">// node is a Node</span>
        <span class="o">||</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nb">document</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">)</span> <span class="c1">// node is a Window</span>
        <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">defaultView</span><span class="p">;</span> <span class="c1">// node is a Document</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">styleRemove</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">removeProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">styleConstant</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">setProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">priority</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">styleFunction</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">removeProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">setProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">priority</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_style</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">((</span><span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span>
              <span class="o">?</span> <span class="nx">styleRemove</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
              <span class="o">?</span> <span class="nx">styleFunction</span>
              <span class="o">:</span> <span class="nx">styleConstant</span><span class="p">)(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">priority</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="nx">priority</span><span class="p">))</span>
        <span class="o">:</span> <span class="nx">styleValue</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">(),</span> <span class="nx">name</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">styleValue</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
        <span class="o">||</span> <span class="nx">defaultView</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">propertyRemove</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">propertyConstant</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">propertyFunction</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">delete</span> <span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
      <span class="k">else</span> <span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_property</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">((</span><span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span>
            <span class="o">?</span> <span class="nx">propertyRemove</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
            <span class="o">?</span> <span class="nx">propertyFunction</span>
            <span class="o">:</span> <span class="nx">propertyConstant</span><span class="p">)(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">))</span>
        <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">()[</span><span class="nx">name</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">classArray</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="sr">/^|\s+/</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">classList</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">classList</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">ClassList</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">ClassList</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_names</span> <span class="o">=</span> <span class="nx">classArray</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">ClassList</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_names</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_names</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_node</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_names</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_names</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_names</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_node</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_names</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">contains</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_names</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">classedAdd</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">names</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">classList</span><span class="p">(</span><span class="nx">node</span><span class="p">),</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">classedRemove</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">names</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">classList</span><span class="p">(</span><span class="nx">node</span><span class="p">),</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">list</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">classedTrue</span><span class="p">(</span><span class="nx">names</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">classedAdd</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">names</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">classedFalse</span><span class="p">(</span><span class="nx">names</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">classedRemove</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">names</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">classedFunction</span><span class="p">(</span><span class="nx">names</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">?</span> <span class="nx">classedAdd</span> <span class="o">:</span> <span class="nx">classedRemove</span><span class="p">)(</span><span class="k">this</span><span class="p">,</span> <span class="nx">names</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_classed</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">names</span> <span class="o">=</span> <span class="nx">classArray</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">classList</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">()),</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">((</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
        <span class="o">?</span> <span class="nx">classedFunction</span> <span class="o">:</span> <span class="nx">value</span>
        <span class="o">?</span> <span class="nx">classedTrue</span>
        <span class="o">:</span> <span class="nx">classedFalse</span><span class="p">)(</span><span class="nx">names</span><span class="p">,</span> <span class="nx">value</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">textRemove</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">textConstant</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">textFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="nx">v</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_text</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span>
        <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span>
            <span class="o">?</span> <span class="nx">textRemove</span> <span class="o">:</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
            <span class="o">?</span> <span class="nx">textFunction</span>
            <span class="o">:</span> <span class="nx">textConstant</span><span class="p">)(</span><span class="nx">value</span><span class="p">))</span>
        <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">textContent</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">htmlRemove</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">htmlConstant</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">htmlFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="nx">v</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_html</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span>
        <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span>
            <span class="o">?</span> <span class="nx">htmlRemove</span> <span class="o">:</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
            <span class="o">?</span> <span class="nx">htmlFunction</span>
            <span class="o">:</span> <span class="nx">htmlConstant</span><span class="p">)(</span><span class="nx">value</span><span class="p">))</span>
        <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">innerHTML</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">raise</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_raise</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">raise</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">lower</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">previousSibling</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_lower</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">lower</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_append</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">create</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">name</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">name</span> <span class="o">:</span> <span class="nx">creator</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">create</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">constantNull</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_insert</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">before</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">create</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">name</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">name</span> <span class="o">:</span> <span class="nx">creator</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span>
        <span class="nx">select</span> <span class="o">=</span> <span class="nx">before</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">constantNull</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nx">before</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">before</span> <span class="o">:</span> <span class="nx">selector</span><span class="p">(</span><span class="nx">before</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">create</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span> <span class="nx">select</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">||</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">remove</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_remove</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">remove</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_cloneShallow</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_cloneDeep</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_clone</span><span class="p">(</span><span class="nx">deep</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">deep</span> <span class="o">?</span> <span class="nx">selection_cloneDeep</span> <span class="o">:</span> <span class="nx">selection_cloneShallow</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_datum</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span>
        <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s2">&quot;__data__&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
        <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">__data__</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">filterEvents</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="kd">var</span> <span class="nx">event</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">document</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">element$1</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s2">&quot;onmouseenter&quot;</span> <span class="k">in</span> <span class="nx">element$1</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">filterEvents</span> <span class="o">=</span> <span class="p">{</span><span class="nx">mouseenter</span><span class="o">:</span> <span class="s2">&quot;mouseover&quot;</span><span class="p">,</span> <span class="nx">mouseleave</span><span class="o">:</span> <span class="s2">&quot;mouseout&quot;</span><span class="p">};</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">filterContextListener</span><span class="p">(</span><span class="nx">listener</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">listener</span> <span class="o">=</span> <span class="nx">contextListener</span><span class="p">(</span><span class="nx">listener</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">group</span><span class="p">);</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">related</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">relatedTarget</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">related</span> <span class="o">||</span> <span class="p">(</span><span class="nx">related</span> <span class="o">!==</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">related</span><span class="p">.</span><span class="nx">compareDocumentPosition</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
        <span class="nx">listener</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">event</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">contextListener</span><span class="p">(</span><span class="nx">listener</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event1</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">event0</span> <span class="o">=</span> <span class="nx">event</span><span class="p">;</span> <span class="c1">// Events can be reentrant (e.g., focus).</span>
      <span class="nx">event</span> <span class="o">=</span> <span class="nx">event1</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">listener</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">group</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="nx">event</span> <span class="o">=</span> <span class="nx">event0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">parseTypenames</span><span class="p">(</span><span class="nx">typenames</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">typenames</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="sr">/^|\s+/</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">};</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">onRemove</span><span class="p">(</span><span class="nx">typename</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">on</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__on</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">on</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">on</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">o</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">o</span> <span class="o">=</span> <span class="nx">on</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="p">(</span><span class="o">!</span><span class="nx">typename</span><span class="p">.</span><span class="nx">type</span> <span class="o">||</span> <span class="nx">o</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">typename</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">typename</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">listener</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">capture</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">on</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">on</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">__on</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">onAdd</span><span class="p">(</span><span class="nx">typename</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">capture</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">wrap</span> <span class="o">=</span> <span class="nx">filterEvents</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">typename</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="o">?</span> <span class="nx">filterContextListener</span> <span class="o">:</span> <span class="nx">contextListener</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">on</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__on</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">listener</span> <span class="o">=</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">group</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">on</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">on</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">o</span> <span class="o">=</span> <span class="nx">on</span><span class="p">[</span><span class="nx">j</span><span class="p">]).</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">typename</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">typename</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">listener</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">capture</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">listener</span> <span class="o">=</span> <span class="nx">listener</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">capture</span> <span class="o">=</span> <span class="nx">capture</span><span class="p">);</span>
          <span class="nx">o</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">typename</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">,</span> <span class="nx">capture</span><span class="p">);</span>
      <span class="nx">o</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="nx">typename</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">typename</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">listener</span><span class="o">:</span> <span class="nx">listener</span><span class="p">,</span> <span class="nx">capture</span><span class="o">:</span> <span class="nx">capture</span><span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">on</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">__on</span> <span class="o">=</span> <span class="p">[</span><span class="nx">o</span><span class="p">];</span>
      <span class="k">else</span> <span class="nx">on</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">o</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_on</span><span class="p">(</span><span class="nx">typename</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">capture</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">typenames</span> <span class="o">=</span> <span class="nx">parseTypenames</span><span class="p">(</span><span class="nx">typename</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">typenames</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">t</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">on</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">__on</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">on</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">on</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">o</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">on</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">((</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">typenames</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">o</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">o</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">on</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">?</span> <span class="nx">onAdd</span> <span class="o">:</span> <span class="nx">onRemove</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">capture</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">capture</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">on</span><span class="p">(</span><span class="nx">typenames</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">capture</span><span class="p">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nb">window</span> <span class="o">=</span> <span class="nx">defaultView</span><span class="p">(</span><span class="nx">node</span><span class="p">),</span>
        <span class="nx">event</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">CustomEvent</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">event</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">event</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">event</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">event</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">(</span><span class="s2">&quot;Event&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="nx">event</span><span class="p">.</span><span class="nx">initEvent</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">bubbles</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">cancelable</span><span class="p">),</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">detail</span><span class="p">;</span>
      <span class="k">else</span> <span class="nx">event</span><span class="p">.</span><span class="nx">initEvent</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">node</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">dispatchConstant</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">dispatchEvent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">dispatchFunction</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">dispatchEvent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection_dispatch</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">((</span><span class="k">typeof</span> <span class="nx">params</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
        <span class="o">?</span> <span class="nx">dispatchFunction</span>
        <span class="o">:</span> <span class="nx">dispatchConstant</span><span class="p">)(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">params</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="p">[</span><span class="kc">null</span><span class="p">];</span>

  <span class="kd">function</span> <span class="nx">Selection</span><span class="p">(</span><span class="nx">groups</span><span class="p">,</span> <span class="nx">parents</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_groups</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_parents</span> <span class="o">=</span> <span class="nx">parents</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selection</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Selection</span><span class="p">([[</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">]],</span> <span class="nx">root</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">Selection</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="nx">Selection</span><span class="p">,</span>
    <span class="nx">select</span><span class="o">:</span> <span class="nx">selection_select</span><span class="p">,</span>
    <span class="nx">selectAll</span><span class="o">:</span> <span class="nx">selection_selectAll</span><span class="p">,</span>
    <span class="nx">filter</span><span class="o">:</span> <span class="nx">selection_filter</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="nx">selection_data</span><span class="p">,</span>
    <span class="nx">enter</span><span class="o">:</span> <span class="nx">selection_enter</span><span class="p">,</span>
    <span class="nx">exit</span><span class="o">:</span> <span class="nx">selection_exit</span><span class="p">,</span>
    <span class="nx">merge</span><span class="o">:</span> <span class="nx">selection_merge</span><span class="p">,</span>
    <span class="nx">order</span><span class="o">:</span> <span class="nx">selection_order</span><span class="p">,</span>
    <span class="nx">sort</span><span class="o">:</span> <span class="nx">selection_sort</span><span class="p">,</span>
    <span class="nx">call</span><span class="o">:</span> <span class="nx">selection_call</span><span class="p">,</span>
    <span class="nx">nodes</span><span class="o">:</span> <span class="nx">selection_nodes</span><span class="p">,</span>
    <span class="nx">node</span><span class="o">:</span> <span class="nx">selection_node</span><span class="p">,</span>
    <span class="nx">size</span><span class="o">:</span> <span class="nx">selection_size</span><span class="p">,</span>
    <span class="nx">empty</span><span class="o">:</span> <span class="nx">selection_empty</span><span class="p">,</span>
    <span class="nx">each</span><span class="o">:</span> <span class="nx">selection_each</span><span class="p">,</span>
    <span class="nx">attr</span><span class="o">:</span> <span class="nx">selection_attr</span><span class="p">,</span>
    <span class="nx">style</span><span class="o">:</span> <span class="nx">selection_style</span><span class="p">,</span>
    <span class="nx">property</span><span class="o">:</span> <span class="nx">selection_property</span><span class="p">,</span>
    <span class="nx">classed</span><span class="o">:</span> <span class="nx">selection_classed</span><span class="p">,</span>
    <span class="nx">text</span><span class="o">:</span> <span class="nx">selection_text</span><span class="p">,</span>
    <span class="nx">html</span><span class="o">:</span> <span class="nx">selection_html</span><span class="p">,</span>
    <span class="nx">raise</span><span class="o">:</span> <span class="nx">selection_raise</span><span class="p">,</span>
    <span class="nx">lower</span><span class="o">:</span> <span class="nx">selection_lower</span><span class="p">,</span>
    <span class="nx">append</span><span class="o">:</span> <span class="nx">selection_append</span><span class="p">,</span>
    <span class="nx">insert</span><span class="o">:</span> <span class="nx">selection_insert</span><span class="p">,</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="nx">selection_remove</span><span class="p">,</span>
    <span class="nx">clone</span><span class="o">:</span> <span class="nx">selection_clone</span><span class="p">,</span>
    <span class="nx">datum</span><span class="o">:</span> <span class="nx">selection_datum</span><span class="p">,</span>
    <span class="nx">on</span><span class="o">:</span> <span class="nx">selection_on</span><span class="p">,</span>
    <span class="nx">dispatch</span><span class="o">:</span> <span class="nx">selection_dispatch</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">select</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">typeof</span> <span class="nx">selector</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span>
        <span class="o">?</span> <span class="k">new</span> <span class="nx">Selection</span><span class="p">([[</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="nx">selector</span><span class="p">)]],</span> <span class="p">[</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">])</span>
        <span class="o">:</span> <span class="k">new</span> <span class="nx">Selection</span><span class="p">([[</span><span class="nx">selector</span><span class="p">]],</span> <span class="nx">root</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">accessor</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fn</span><span class="p">.</span><span class="nx">fields</span> <span class="o">=</span> <span class="nx">fields</span> <span class="o">||</span> <span class="p">[];</span>
    <span class="nx">fn</span><span class="p">.</span><span class="nx">fname</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">fn</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">error</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">splitAccessPath</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">q</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">c</span><span class="p">;</span>

    <span class="nx">p</span> <span class="o">=</span> <span class="nx">p</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">push</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">s</span> <span class="o">+</span> <span class="nx">p</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">));</span>
      <span class="nx">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">===</span> <span class="s1">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">s</span> <span class="o">+=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">);</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">++</span><span class="nx">j</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">===</span> <span class="nx">q</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">push</span><span class="p">();</span>
        <span class="nx">q</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">q</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">b</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span> <span class="o">===</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">q</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">b</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span> <span class="o">===</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">q</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&gt;</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">push</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">===</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&gt;</span> <span class="nx">i</span><span class="p">)</span> <span class="nx">push</span><span class="p">();</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">===</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">b</span><span class="p">)</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Access path missing open bracket: &#39;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">push</span><span class="p">();</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Access path missing closing bracket: &#39;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">q</span><span class="p">)</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Access path missing closing quote: &#39;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&gt;</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">j</span><span class="o">++</span><span class="p">;</span>
      <span class="nx">push</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">path</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">isArray</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">isObject</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span> <span class="o">===</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">_</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isString</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">typeof</span> <span class="nx">_</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">$</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">x</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
      <span class="o">:</span> <span class="nx">isObject</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isString</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">?</span>
        <span class="c1">// Output valid JSON and JS source strings.</span>
        <span class="c1">// See http://timelessrepo.com/json-isnt-a-javascript-subset</span>
        <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;\u2028&#39;</span><span class="p">,</span><span class="s1">&#39;\\u2028&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;\u2029&#39;</span><span class="p">,</span> <span class="s1">&#39;\\u2029&#39;</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">x</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">field</span><span class="p">(</span><span class="nx">field</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">splitAccessPath</span><span class="p">(</span><span class="nx">field</span><span class="p">),</span>
        <span class="nx">code</span> <span class="o">=</span> <span class="s1">&#39;return _[&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">$</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;][&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;];&#39;</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">accessor</span><span class="p">(</span>
      <span class="nb">Function</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="nx">code</span><span class="p">),</span>
      <span class="p">[(</span><span class="nx">field</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">===</span><span class="mi">1</span> <span class="o">?</span> <span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">field</span><span class="p">)],</span>
      <span class="nx">name</span> <span class="o">||</span> <span class="nx">field</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">empty$1</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">field</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">identity</span> <span class="o">=</span> <span class="nx">accessor</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_</span><span class="p">;</span> <span class="p">},</span> <span class="nx">empty$1</span><span class="p">,</span> <span class="s1">&#39;identity&#39;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">zero</span> <span class="o">=</span> <span class="nx">accessor</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">},</span> <span class="nx">empty$1</span><span class="p">,</span> <span class="s1">&#39;zero&#39;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">one</span> <span class="o">=</span> <span class="nx">accessor</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="p">},</span> <span class="nx">empty$1</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">truthy</span> <span class="o">=</span> <span class="nx">accessor</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">},</span> <span class="nx">empty$1</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">falsy</span> <span class="o">=</span> <span class="nx">accessor</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">},</span> <span class="nx">empty$1</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">);</span>

  <span class="cm">/*! *****************************************************************************</span>
<span class="cm">  Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="cm">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use</span>
<span class="cm">  this file except in compliance with the License. You may obtain a copy of the</span>
<span class="cm">  License at http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="cm">  THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span class="cm">  KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED</span>
<span class="cm">  WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,</span>
<span class="cm">  MERCHANTABLITY OR NON-INFRINGEMENT.</span>

<span class="cm">  See the Apache Version 2.0 License for specific language governing permissions</span>
<span class="cm">  and limitations under the License.</span>
<span class="cm">  ***************************************************************************** */</span>

  <span class="kd">var</span> <span class="nx">__assign</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span> <span class="o">||</span> <span class="kd">function</span> <span class="nx">__assign</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">s</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">s</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">p</span><span class="p">))</span> <span class="nx">t</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s</span><span class="p">[</span><span class="nx">p</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">__rest</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">s</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
          <span class="nx">t</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s</span><span class="p">[</span><span class="nx">p</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">s</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertySymbols</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">p</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertySymbols</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
              <span class="nx">t</span><span class="p">[</span><span class="nx">p</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">s</span><span class="p">[</span><span class="nx">p</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
      <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">__awaiter</span><span class="p">(</span><span class="nx">thisArg</span><span class="p">,</span> <span class="nx">_arguments</span><span class="p">,</span> <span class="nx">P</span><span class="p">,</span> <span class="nx">generator</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="p">(</span><span class="nx">P</span> <span class="o">||</span> <span class="p">(</span><span class="nx">P</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">))(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">function</span> <span class="nx">fulfilled</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">try</span> <span class="p">{</span> <span class="nx">step</span><span class="p">(</span><span class="nx">generator</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span> <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="p">}</span> <span class="p">}</span>
          <span class="kd">function</span> <span class="nx">rejected</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">try</span> <span class="p">{</span> <span class="nx">step</span><span class="p">(</span><span class="nx">generator</span><span class="p">[</span><span class="s2">&quot;throw&quot;</span><span class="p">](</span><span class="nx">value</span><span class="p">));</span> <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="p">}</span> <span class="p">}</span>
          <span class="kd">function</span> <span class="nx">step</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span> <span class="nx">result</span><span class="p">.</span><span class="nx">done</span> <span class="o">?</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">P</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">fulfilled</span><span class="p">,</span> <span class="nx">rejected</span><span class="p">);</span> <span class="p">}</span>
          <span class="nx">step</span><span class="p">((</span><span class="nx">generator</span> <span class="o">=</span> <span class="nx">generator</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">thisArg</span><span class="p">,</span> <span class="nx">_arguments</span> <span class="o">||</span> <span class="p">[])).</span><span class="nx">next</span><span class="p">());</span>
      <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">__generator</span><span class="p">(</span><span class="nx">thisArg</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">label</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">sent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="k">return</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="p">},</span> <span class="nx">trys</span><span class="o">:</span> <span class="p">[],</span> <span class="nx">ops</span><span class="o">:</span> <span class="p">[]</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">g</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">g</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">next</span><span class="o">:</span> <span class="nx">verb</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;throw&quot;</span><span class="o">:</span> <span class="nx">verb</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;return&quot;</span><span class="o">:</span> <span class="nx">verb</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">},</span> <span class="k">typeof</span> <span class="nx">Symbol</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">g</span><span class="p">[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span> <span class="p">}),</span> <span class="nx">g</span><span class="p">;</span>
      <span class="kd">function</span> <span class="nx">verb</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">step</span><span class="p">([</span><span class="nx">n</span><span class="p">,</span> <span class="nx">v</span><span class="p">]);</span> <span class="p">};</span> <span class="p">}</span>
      <span class="kd">function</span> <span class="nx">step</span><span class="p">(</span><span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s2">&quot;Generator is already executing.&quot;</span><span class="p">);</span>
          <span class="k">while</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="k">try</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">f</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">y</span><span class="p">[</span><span class="nx">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">?</span> <span class="s2">&quot;return&quot;</span> <span class="o">:</span> <span class="nx">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="s2">&quot;throw&quot;</span> <span class="o">:</span> <span class="s2">&quot;next&quot;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])).</span><span class="nx">done</span><span class="p">)</span> <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="nx">op</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">value</span><span class="p">];</span>
              <span class="k">switch</span> <span class="p">(</span><span class="nx">op</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                  <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">op</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
                  <span class="k">case</span> <span class="mi">4</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">label</span><span class="o">++</span><span class="p">;</span> <span class="k">return</span> <span class="p">{</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">op</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span> <span class="p">};</span>
                  <span class="k">case</span> <span class="mi">5</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">label</span><span class="o">++</span><span class="p">;</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">op</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="nx">op</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="k">continue</span><span class="p">;</span>
                  <span class="k">case</span> <span class="mi">7</span><span class="o">:</span> <span class="nx">op</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">ops</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span> <span class="nx">_</span><span class="p">.</span><span class="nx">trys</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span> <span class="k">continue</span><span class="p">;</span>
                  <span class="k">default</span><span class="o">:</span>
                      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">trys</span><span class="p">,</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">[</span><span class="nx">t</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="mi">6</span> <span class="o">||</span> <span class="nx">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span> <span class="nx">_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">continue</span><span class="p">;</span> <span class="p">}</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">t</span> <span class="o">||</span> <span class="p">(</span><span class="nx">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])))</span> <span class="p">{</span> <span class="nx">_</span><span class="p">.</span><span class="nx">label</span> <span class="o">=</span> <span class="nx">op</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">label</span> <span class="o">&lt;</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span> <span class="nx">_</span><span class="p">.</span><span class="nx">label</span> <span class="o">=</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">op</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">label</span> <span class="o">&lt;</span> <span class="nx">t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="nx">_</span><span class="p">.</span><span class="nx">label</span> <span class="o">=</span> <span class="nx">t</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="nx">_</span><span class="p">.</span><span class="nx">ops</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">op</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="nx">_</span><span class="p">.</span><span class="nx">ops</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                      <span class="nx">_</span><span class="p">.</span><span class="nx">trys</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span> <span class="k">continue</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="nx">op</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">thisArg</span><span class="p">,</span> <span class="nx">_</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">op</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="nx">e</span><span class="p">];</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">5</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">op</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="k">return</span> <span class="p">{</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="nx">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="k">void</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">true</span> <span class="p">};</span>
      <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">stringify</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">indent</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">get</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="s1">&#39;indent&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">addMargin</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="s1">&#39;margins&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">maxLength</span> <span class="o">=</span> <span class="p">(</span><span class="nx">indent</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="o">?</span> <span class="kc">Infinity</span> <span class="o">:</span> <span class="nx">get</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="s1">&#39;maxLength&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">));</span>

    <span class="k">return</span> <span class="p">(</span><span class="kd">function</span> <span class="nx">_stringify</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">currentIndent</span><span class="p">,</span> <span class="nx">reserved</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">obj</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">string</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">string</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">string</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">maxLength</span> <span class="o">-</span> <span class="nx">currentIndent</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">reserved</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">prettified</span> <span class="o">=</span> <span class="nx">prettify</span><span class="p">(</span><span class="nx">string</span><span class="p">,</span> <span class="nx">addMargin</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">prettified</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">prettified</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">nextIndent</span> <span class="o">=</span> <span class="nx">currentIndent</span> <span class="o">+</span> <span class="nx">indent</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="kd">var</span> <span class="nx">delimiters</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">comma</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">};</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">items</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
              <span class="nx">_stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">index</span><span class="p">],</span> <span class="nx">nextIndent</span><span class="p">,</span> <span class="nx">comma</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">index</span><span class="p">))</span> <span class="o">||</span> <span class="s1">&#39;null&#39;</span>
            <span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">delimiters</span> <span class="o">=</span> <span class="s1">&#39;[]&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">keyPart</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">_stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">nextIndent</span><span class="p">,</span>
                                   <span class="nx">keyPart</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">comma</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">index</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">items</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">keyPart</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">});</span>
          <span class="nx">delimiters</span> <span class="o">=</span> <span class="s1">&#39;{}&#39;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">[</span>
            <span class="nx">delimiters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="nx">indent</span> <span class="o">+</span> <span class="nx">items</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,\n&#39;</span> <span class="o">+</span> <span class="nx">nextIndent</span><span class="p">),</span>
            <span class="nx">delimiters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span> <span class="o">+</span> <span class="nx">currentIndent</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">string</span>
    <span class="p">}(</span><span class="nx">obj</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="c1">// Note: This regex matches even invalid JSON strings, but since we’re</span>
  <span class="c1">// working on the output of `JSON.stringify` we know that only valid strings</span>
  <span class="c1">// are present (unless the user supplied a weird `options.indent` but in</span>
  <span class="c1">// that case we don’t care since the output would be invalid anyway).</span>
  <span class="kd">var</span> <span class="nx">stringOrChar</span> <span class="o">=</span> <span class="sr">/(&quot;(?:[^\\&quot;]|\\.)*&quot;)|[:,\][}{]/g</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">prettify</span> <span class="p">(</span><span class="nx">string</span><span class="p">,</span> <span class="nx">addMargin</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">addMargin</span> <span class="o">?</span> <span class="s1">&#39; &#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;{&#39;</span><span class="o">:</span> <span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="nx">m</span><span class="p">,</span>
      <span class="s1">&#39;[&#39;</span><span class="o">:</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">m</span><span class="p">,</span>
      <span class="s1">&#39;}&#39;</span><span class="o">:</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">,</span>
      <span class="s1">&#39;]&#39;</span><span class="o">:</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span>
      <span class="s1">&#39;,&#39;</span><span class="o">:</span> <span class="s1">&#39;, &#39;</span><span class="p">,</span>
      <span class="s1">&#39;:&#39;</span><span class="o">:</span> <span class="s1">&#39;: &#39;</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">stringOrChar</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">string</span> <span class="o">?</span> <span class="nx">match</span> <span class="o">:</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">match</span><span class="p">]</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">get</span> <span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">defaultValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">options</span> <span class="o">?</span> <span class="nx">options</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">:</span> <span class="nx">defaultValue</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">jsonStringifyPrettyCompact</span> <span class="o">=</span> <span class="nx">stringify</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">stringify_</span> <span class="o">=</span> <span class="cm">/*#__PURE__*/</span><span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">({</span>
    <span class="k">default</span><span class="o">:</span> <span class="nx">jsonStringifyPrettyCompact</span><span class="p">,</span>
    <span class="nx">__moduleExports</span><span class="o">:</span> <span class="nx">jsonStringifyPrettyCompact</span>
  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">unwrapExports</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  	<span class="k">return</span> <span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">__esModule</span> <span class="o">&amp;&amp;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">x</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="nx">x</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">createCommonjsModule</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
  	<span class="k">return</span> <span class="nx">module</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">exports</span><span class="o">:</span> <span class="p">{}</span> <span class="p">},</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">),</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">semver</span> <span class="o">=</span> <span class="nx">createCommonjsModule</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">exports</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">SemVer</span><span class="p">;</span>

  <span class="c1">// The debug function is excluded entirely from the minified version.</span>
  <span class="cm">/* nomin */</span> <span class="kd">var</span> <span class="nx">debug</span><span class="p">;</span>
  <span class="cm">/* nomin */</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">process</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span>
      <span class="cm">/* nomin */</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span> <span class="o">&amp;&amp;</span>
      <span class="cm">/* nomin */</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_DEBUG</span> <span class="o">&amp;&amp;</span>
      <span class="cm">/* nomin */</span> <span class="sr">/\bsemver\b/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_DEBUG</span><span class="p">))</span>
    <span class="cm">/* nomin */</span> <span class="nx">debug</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="cm">/* nomin */</span> <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="cm">/* nomin */</span> <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="s1">&#39;SEMVER&#39;</span><span class="p">);</span>
      <span class="cm">/* nomin */</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
      <span class="cm">/* nomin */</span> <span class="p">};</span>
  <span class="cm">/* nomin */</span> <span class="k">else</span>
    <span class="cm">/* nomin */</span> <span class="nx">debug</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

  <span class="c1">// Note: this is the semver.org version of the spec that it implements</span>
  <span class="c1">// Not necessarily the package version of this code.</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">SEMVER_SPEC_VERSION</span> <span class="o">=</span> <span class="s1">&#39;2.0.0&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">MAX_SAFE_INTEGER</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_SAFE_INTEGER</span> <span class="o">||</span> <span class="mi">9007199254740991</span><span class="p">;</span>

  <span class="c1">// Max safe segment length for coercion.</span>
  <span class="kd">var</span> <span class="nx">MAX_SAFE_COMPONENT_LENGTH</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

  <span class="c1">// The actual regexps go on exports.re</span>
  <span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">re</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">src</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">// The following Regular Expressions can be used for tokenizing,</span>
  <span class="c1">// validating, and parsing SemVer version strings.</span>

  <span class="c1">// ## Numeric Identifier</span>
  <span class="c1">// A single `0`, or a non-zero digit followed by zero or more digits.</span>

  <span class="kd">var</span> <span class="nx">NUMERICIDENTIFIER</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">NUMERICIDENTIFIER</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0|[1-9]\\d*&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">NUMERICIDENTIFIERLOOSE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">NUMERICIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[0-9]+&#39;</span><span class="p">;</span>


  <span class="c1">// ## Non-numeric Identifier</span>
  <span class="c1">// Zero or more digits, followed by a letter or hyphen, and then zero or</span>
  <span class="c1">// more letters, digits, or hyphens.</span>

  <span class="kd">var</span> <span class="nx">NONNUMERICIDENTIFIER</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">NONNUMERICIDENTIFIER</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;\\d*[a-zA-Z-][a-zA-Z0-9-]*&#39;</span><span class="p">;</span>


  <span class="c1">// ## Main Version</span>
  <span class="c1">// Three dot-separated numeric identifiers.</span>

  <span class="kd">var</span> <span class="nx">MAINVERSION</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">MAINVERSION</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">NUMERICIDENTIFIER</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)\\.&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">NUMERICIDENTIFIER</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)\\.&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">NUMERICIDENTIFIER</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">MAINVERSIONLOOSE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">MAINVERSIONLOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">NUMERICIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)\\.&#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">NUMERICIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)\\.&#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">NUMERICIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>

  <span class="c1">// ## Pre-release Version Identifier</span>
  <span class="c1">// A numeric identifier, or a non-numeric identifier.</span>

  <span class="kd">var</span> <span class="nx">PRERELEASEIDENTIFIER</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">PRERELEASEIDENTIFIER</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(?:&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">NUMERICIDENTIFIER</span><span class="p">]</span> <span class="o">+</span>
                              <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">NONNUMERICIDENTIFIER</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">PRERELEASEIDENTIFIERLOOSE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">PRERELEASEIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(?:&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">NUMERICIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">+</span>
                                   <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">NONNUMERICIDENTIFIER</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>


  <span class="c1">// ## Pre-release Version</span>
  <span class="c1">// Hyphen, followed by one or more dot-separated pre-release version</span>
  <span class="c1">// identifiers.</span>

  <span class="kd">var</span> <span class="nx">PRERELEASE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">PRERELEASE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(?:-(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">PRERELEASEIDENTIFIER</span><span class="p">]</span> <span class="o">+</span>
                    <span class="s1">&#39;(?:\\.&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">PRERELEASEIDENTIFIER</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)*))&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">PRERELEASELOOSE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">PRERELEASELOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(?:-?(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">PRERELEASEIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">+</span>
                         <span class="s1">&#39;(?:\\.&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">PRERELEASEIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)*))&#39;</span><span class="p">;</span>

  <span class="c1">// ## Build Metadata Identifier</span>
  <span class="c1">// Any combination of digits, letters, or hyphens.</span>

  <span class="kd">var</span> <span class="nx">BUILDIDENTIFIER</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">BUILDIDENTIFIER</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[0-9A-Za-z-]+&#39;</span><span class="p">;</span>

  <span class="c1">// ## Build Metadata</span>
  <span class="c1">// Plus sign, followed by one or more period-separated build metadata</span>
  <span class="c1">// identifiers.</span>

  <span class="kd">var</span> <span class="nx">BUILD</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">BUILD</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(?:\\+(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">BUILDIDENTIFIER</span><span class="p">]</span> <span class="o">+</span>
               <span class="s1">&#39;(?:\\.&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">BUILDIDENTIFIER</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)*))&#39;</span><span class="p">;</span>


  <span class="c1">// ## Full Version String</span>
  <span class="c1">// A main version, followed optionally by a pre-release version and</span>
  <span class="c1">// build metadata.</span>

  <span class="c1">// Note that the only major, minor, patch, and pre-release sections of</span>
  <span class="c1">// the version string are capturing groups.  The build metadata is not a</span>
  <span class="c1">// capturing group, because it should not ever be used in version</span>
  <span class="c1">// comparison.</span>

  <span class="kd">var</span> <span class="nx">FULL</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">FULLPLAIN</span> <span class="o">=</span> <span class="s1">&#39;v?&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">MAINVERSION</span><span class="p">]</span> <span class="o">+</span>
                  <span class="nx">src</span><span class="p">[</span><span class="nx">PRERELEASE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span>
                  <span class="nx">src</span><span class="p">[</span><span class="nx">BUILD</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span><span class="p">;</span>

  <span class="nx">src</span><span class="p">[</span><span class="nx">FULL</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">FULLPLAIN</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">;</span>

  <span class="c1">// like full, but allows v1.2.3 and =1.2.3, which people do sometimes.</span>
  <span class="c1">// also, 1.0.0alpha1 (prerelease without the hyphen) which is pretty</span>
  <span class="c1">// common in the npm registry.</span>
  <span class="kd">var</span> <span class="nx">LOOSEPLAIN</span> <span class="o">=</span> <span class="s1">&#39;[v=\\s]*&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">MAINVERSIONLOOSE</span><span class="p">]</span> <span class="o">+</span>
                   <span class="nx">src</span><span class="p">[</span><span class="nx">PRERELEASELOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span>
                   <span class="nx">src</span><span class="p">[</span><span class="nx">BUILD</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">LOOSE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">LOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">LOOSEPLAIN</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">GTLT</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">GTLT</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;((?:&lt;|&gt;)?=?)&#39;</span><span class="p">;</span>

  <span class="c1">// Something like &quot;2.*&quot; or &quot;1.2.x&quot;.</span>
  <span class="c1">// Note that &quot;x.x&quot; is a valid xRange identifer, meaning &quot;any version&quot;</span>
  <span class="c1">// Only the first item is strictly required.</span>
  <span class="kd">var</span> <span class="nx">XRANGEIDENTIFIERLOOSE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="nx">src</span><span class="p">[</span><span class="nx">NUMERICIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|x|X|\\*&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">XRANGEIDENTIFIER</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEIDENTIFIER</span><span class="p">]</span> <span class="o">=</span> <span class="nx">src</span><span class="p">[</span><span class="nx">NUMERICIDENTIFIER</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|x|X|\\*&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">XRANGEPLAIN</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAIN</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[v=\\s]*(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEIDENTIFIER</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;(?:\\.(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEIDENTIFIER</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;(?:\\.(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEIDENTIFIER</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;(?:&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">PRERELEASE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)?&#39;</span> <span class="o">+</span>
                     <span class="nx">src</span><span class="p">[</span><span class="nx">BUILD</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;)?)?&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">XRANGEPLAINLOOSE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAINLOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[v=\\s]*(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;(?:\\.(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;(?:\\.(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEIDENTIFIERLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;(?:&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">PRERELEASELOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)?&#39;</span> <span class="o">+</span>
                          <span class="nx">src</span><span class="p">[</span><span class="nx">BUILD</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;)?)?&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">XRANGE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">GTLT</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;\\s*&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAIN</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">XRANGELOOSE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGELOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">GTLT</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;\\s*&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAINLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">;</span>

  <span class="c1">// Coercion.</span>
  <span class="c1">// Extract anything that could conceivably be a part of a valid semver</span>
  <span class="kd">var</span> <span class="nx">COERCE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">COERCE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(?:^|[^\\d])&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;(\\d{1,&#39;</span> <span class="o">+</span> <span class="nx">MAX_SAFE_COMPONENT_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;})&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;(?:\\.(\\d{1,&#39;</span> <span class="o">+</span> <span class="nx">MAX_SAFE_COMPONENT_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;}))?&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;(?:\\.(\\d{1,&#39;</span> <span class="o">+</span> <span class="nx">MAX_SAFE_COMPONENT_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;}))?&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;(?:$|[^\\d])&#39;</span><span class="p">;</span>

  <span class="c1">// Tilde ranges.</span>
  <span class="c1">// Meaning is &quot;reasonably at or greater than&quot;</span>
  <span class="kd">var</span> <span class="nx">LONETILDE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">LONETILDE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(?:~&gt;?)&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">TILDETRIM</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">TILDETRIM</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(\\s*)&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">LONETILDE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;\\s+&#39;</span><span class="p">;</span>
  <span class="nx">re</span><span class="p">[</span><span class="nx">TILDETRIM</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="nx">TILDETRIM</span><span class="p">],</span> <span class="s1">&#39;g&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">tildeTrimReplace</span> <span class="o">=</span> <span class="s1">&#39;$1~&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">TILDE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">TILDE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">LONETILDE</span><span class="p">]</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAIN</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">TILDELOOSE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">TILDELOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">LONETILDE</span><span class="p">]</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAINLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">;</span>

  <span class="c1">// Caret ranges.</span>
  <span class="c1">// Meaning is &quot;at least and backwards compatible with&quot;</span>
  <span class="kd">var</span> <span class="nx">LONECARET</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">LONECARET</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(?:\\^)&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">CARETTRIM</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">CARETTRIM</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(\\s*)&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">LONECARET</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;\\s+&#39;</span><span class="p">;</span>
  <span class="nx">re</span><span class="p">[</span><span class="nx">CARETTRIM</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="nx">CARETTRIM</span><span class="p">],</span> <span class="s1">&#39;g&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">caretTrimReplace</span> <span class="o">=</span> <span class="s1">&#39;$1^&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">CARET</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">CARET</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">LONECARET</span><span class="p">]</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAIN</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">CARETLOOSE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">CARETLOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">LONECARET</span><span class="p">]</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAINLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">;</span>

  <span class="c1">// A simple gt/lt/eq thing, or just &quot;&quot; to indicate &quot;any version&quot;</span>
  <span class="kd">var</span> <span class="nx">COMPARATORLOOSE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">COMPARATORLOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">GTLT</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;\\s*(&#39;</span> <span class="o">+</span> <span class="nx">LOOSEPLAIN</span> <span class="o">+</span> <span class="s1">&#39;)$|^$&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">COMPARATOR</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">COMPARATOR</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">GTLT</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;\\s*(&#39;</span> <span class="o">+</span> <span class="nx">FULLPLAIN</span> <span class="o">+</span> <span class="s1">&#39;)$|^$&#39;</span><span class="p">;</span>


  <span class="c1">// An expression to strip any whitespace between the gtlt and the thing</span>
  <span class="c1">// it modifies, so that `&gt; 1.2.3` ==&gt; `&gt;1.2.3`</span>
  <span class="kd">var</span> <span class="nx">COMPARATORTRIM</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">COMPARATORTRIM</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(\\s*)&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">GTLT</span><span class="p">]</span> <span class="o">+</span>
                        <span class="s1">&#39;\\s*(&#39;</span> <span class="o">+</span> <span class="nx">LOOSEPLAIN</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAIN</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>

  <span class="c1">// this one has to use the /g flag</span>
  <span class="nx">re</span><span class="p">[</span><span class="nx">COMPARATORTRIM</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="nx">COMPARATORTRIM</span><span class="p">],</span> <span class="s1">&#39;g&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">comparatorTrimReplace</span> <span class="o">=</span> <span class="s1">&#39;$1$2$3&#39;</span><span class="p">;</span>


  <span class="c1">// Something like `1.2.3 - 1.2.4`</span>
  <span class="c1">// Note that these all use the loose form, because they&#39;ll be</span>
  <span class="c1">// checked against either the strict or loose comparator form</span>
  <span class="c1">// later.</span>
  <span class="kd">var</span> <span class="nx">HYPHENRANGE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">HYPHENRANGE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;^\\s*(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAIN</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;\\s+-\\s+&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAIN</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;\\s*$&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">HYPHENRANGELOOSE</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">HYPHENRANGELOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;^\\s*(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAINLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;\\s+-\\s+&#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">src</span><span class="p">[</span><span class="nx">XRANGEPLAINLOOSE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;\\s*$&#39;</span><span class="p">;</span>

  <span class="c1">// Star ranges basically just allow anything at all.</span>
  <span class="kd">var</span> <span class="nx">STAR</span> <span class="o">=</span> <span class="nx">R</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">src</span><span class="p">[</span><span class="nx">STAR</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(&lt;|&gt;)?=?\\s*\\*&#39;</span><span class="p">;</span>

  <span class="c1">// Compile to actual regexp objects.</span>
  <span class="c1">// All are flag-free, unless they were created above with a flag.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">R</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">src</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">re</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
      <span class="nx">re</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="k">instanceof</span> <span class="nx">SemVer</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">version</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">version</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">version</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">MAX_LENGTH</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">loose</span> <span class="o">?</span> <span class="nx">re</span><span class="p">[</span><span class="nx">LOOSE</span><span class="p">]</span> <span class="o">:</span> <span class="nx">re</span><span class="p">[</span><span class="nx">FULL</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">r</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">version</span><span class="p">))</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">er</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">valid</span> <span class="o">=</span> <span class="nx">valid</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">valid</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">v</span> <span class="o">?</span> <span class="nx">v</span><span class="p">.</span><span class="nx">version</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="nx">exports</span><span class="p">.</span><span class="nx">clean</span> <span class="o">=</span> <span class="nx">clean</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">clean</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">version</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[=v]+/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">s</span> <span class="o">?</span> <span class="nx">s</span><span class="p">.</span><span class="nx">version</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">SemVer</span> <span class="o">=</span> <span class="nx">SemVer</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="k">instanceof</span> <span class="nx">SemVer</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">version</span><span class="p">.</span><span class="nx">loose</span> <span class="o">===</span> <span class="nx">loose</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">version</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="nx">version</span> <span class="o">=</span> <span class="nx">version</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">version</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid Version: &#39;</span> <span class="o">+</span> <span class="nx">version</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">version</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">MAX_LENGTH</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;version is longer than &#39;</span> <span class="o">+</span> <span class="nx">MAX_LENGTH</span> <span class="o">+</span> <span class="s1">&#39; characters&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">SemVer</span><span class="p">))</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>

    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;SemVer&#39;</span><span class="p">,</span> <span class="nx">version</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">loose</span> <span class="o">=</span> <span class="nx">loose</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">version</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="nx">loose</span> <span class="o">?</span> <span class="nx">re</span><span class="p">[</span><span class="nx">LOOSE</span><span class="p">]</span> <span class="o">:</span> <span class="nx">re</span><span class="p">[</span><span class="nx">FULL</span><span class="p">]);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">m</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid Version: &#39;</span> <span class="o">+</span> <span class="nx">version</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">raw</span> <span class="o">=</span> <span class="nx">version</span><span class="p">;</span>

    <span class="c1">// these are actually numbers</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">major</span> <span class="o">=</span> <span class="o">+</span><span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">minor</span> <span class="o">=</span> <span class="o">+</span><span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">patch</span> <span class="o">=</span> <span class="o">+</span><span class="nx">m</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">major</span> <span class="o">&gt;</span> <span class="nx">MAX_SAFE_INTEGER</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">major</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid major version&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">minor</span> <span class="o">&gt;</span> <span class="nx">MAX_SAFE_INTEGER</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">minor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid minor version&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">patch</span> <span class="o">&gt;</span> <span class="nx">MAX_SAFE_INTEGER</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">patch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid patch version&#39;</span><span class="p">)</span>

    <span class="c1">// numberify any prerelease numeric ids</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">m</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">else</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="sr">/^[0-9]+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">num</span> <span class="o">=</span> <span class="o">+</span><span class="nx">id</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">num</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">num</span> <span class="o">&lt;</span> <span class="nx">MAX_SAFE_INTEGER</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">num</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
      <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">build</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">?</span> <span class="nx">m</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">SemVer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">major</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">minor</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">patch</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">version</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">SemVer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">SemVer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">compare</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;SemVer.compare&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">loose</span><span class="p">,</span> <span class="nx">other</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">SemVer</span><span class="p">))</span>
      <span class="nx">other</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">other</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">loose</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">compareMain</span><span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">comparePre</span><span class="p">(</span><span class="nx">other</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">SemVer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">compareMain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">SemVer</span><span class="p">))</span>
      <span class="nx">other</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">other</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">loose</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">compareIdentifiers</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">major</span><span class="p">,</span> <span class="nx">other</span><span class="p">.</span><span class="nx">major</span><span class="p">)</span> <span class="o">||</span>
           <span class="nx">compareIdentifiers</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">minor</span><span class="p">,</span> <span class="nx">other</span><span class="p">.</span><span class="nx">minor</span><span class="p">)</span> <span class="o">||</span>
           <span class="nx">compareIdentifiers</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">patch</span><span class="p">,</span> <span class="nx">other</span><span class="p">.</span><span class="nx">patch</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">SemVer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">comparePre</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">other</span> <span class="k">instanceof</span> <span class="nx">SemVer</span><span class="p">))</span>
      <span class="nx">other</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">other</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">loose</span><span class="p">);</span>

    <span class="c1">// NOT having a prerelease is &gt; having one</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">other</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">other</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;prerelease compare&#39;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span><span class="p">)</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">compareIdentifiers</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="c1">// preminor will bump the version up to the next minor release, and immediately</span>
  <span class="c1">// down to pre-release. premajor and prepatch work the same way.</span>
  <span class="nx">SemVer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">release</span><span class="p">,</span> <span class="nx">identifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">release</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;premajor&#39;</span><span class="o">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">patch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">major</span><span class="o">++</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">inc</span><span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="nx">identifier</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;preminor&#39;</span><span class="o">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">patch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">minor</span><span class="o">++</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">inc</span><span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="nx">identifier</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;prepatch&#39;</span><span class="o">:</span>
        <span class="c1">// If this is already a prerelease, it will bump to the next version</span>
        <span class="c1">// drop any prereleases that might already exist, since they are not</span>
        <span class="c1">// relevant at this point.</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">inc</span><span class="p">(</span><span class="s1">&#39;patch&#39;</span><span class="p">,</span> <span class="nx">identifier</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">inc</span><span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="nx">identifier</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="c1">// If the input is a non-prerelease version, this acts the same as</span>
      <span class="c1">// prepatch.</span>
      <span class="k">case</span> <span class="s1">&#39;prerelease&#39;</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">inc</span><span class="p">(</span><span class="s1">&#39;patch&#39;</span><span class="p">,</span> <span class="nx">identifier</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">inc</span><span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="nx">identifier</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="s1">&#39;major&#39;</span><span class="o">:</span>
        <span class="c1">// If this is a pre-major version, bump up to the same major version.</span>
        <span class="c1">// Otherwise increment major.</span>
        <span class="c1">// 1.0.0-5 bumps to 1.0.0</span>
        <span class="c1">// 1.1.0 bumps to 2.0.0</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">minor</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">patch</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">major</span><span class="o">++</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">patch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;minor&#39;</span><span class="o">:</span>
        <span class="c1">// If this is a pre-minor version, bump up to the same minor version.</span>
        <span class="c1">// Otherwise increment minor.</span>
        <span class="c1">// 1.2.0-5 bumps to 1.2.0</span>
        <span class="c1">// 1.2.1 bumps to 1.3.0</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">patch</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">minor</span><span class="o">++</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">patch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;patch&#39;</span><span class="o">:</span>
        <span class="c1">// If this is not a pre-release version, it will increment the patch.</span>
        <span class="c1">// If it is a pre-release it will bump up to the same patch version.</span>
        <span class="c1">// 1.2.0-5 patches to 1.2.0</span>
        <span class="c1">// 1.2.0 patches to 1.2.1</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">patch</span><span class="o">++</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="c1">// This probably shouldn&#39;t be used publicly.</span>
      <span class="c1">// 1.0.0 &quot;pre&quot; would become 1.0.0-0 which is the wrong direction.</span>
      <span class="k">case</span> <span class="s1">&#39;pre&#39;</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
              <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">// didn&#39;t increment anything</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">identifier</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// 1.2.0-beta.1 bumps to 1.2.0-beta.2,</span>
          <span class="c1">// 1.2.0-beta.fooblz or 1.2.0-beta bumps to 1.2.0-beta.0</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">identifier</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span> <span class="o">=</span> <span class="p">[</span><span class="nx">identifier</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>
          <span class="p">}</span> <span class="k">else</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">prerelease</span> <span class="o">=</span> <span class="p">[</span><span class="nx">identifier</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">default</span><span class="o">:</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;invalid increment argument: &#39;</span> <span class="o">+</span> <span class="nx">release</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">raw</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">inc</span> <span class="o">=</span> <span class="nx">inc</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">inc</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">release</span><span class="p">,</span> <span class="nx">loose</span><span class="p">,</span> <span class="nx">identifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">loose</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">identifier</span> <span class="o">=</span> <span class="nx">loose</span><span class="p">;</span>
      <span class="nx">loose</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">loose</span><span class="p">).</span><span class="nx">inc</span><span class="p">(</span><span class="nx">release</span><span class="p">,</span> <span class="nx">identifier</span><span class="p">).</span><span class="nx">version</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">er</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">diff</span> <span class="o">=</span> <span class="nx">diff</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">diff</span><span class="p">(</span><span class="nx">version1</span><span class="p">,</span> <span class="nx">version2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">eq</span><span class="p">(</span><span class="nx">version1</span><span class="p">,</span> <span class="nx">version2</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">v1</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">version1</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">v2</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">version2</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">v1</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">v1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;major&#39;</span> <span class="o">||</span> <span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;minor&#39;</span> <span class="o">||</span> <span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;patch&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">v1</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">v2</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
              <span class="k">return</span> <span class="s1">&#39;pre&#39;</span><span class="o">+</span><span class="nx">key</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s1">&#39;prerelease&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">v1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;major&#39;</span> <span class="o">||</span> <span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;minor&#39;</span> <span class="o">||</span> <span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;patch&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">v1</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">v2</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">key</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">compareIdentifiers</span> <span class="o">=</span> <span class="nx">compareIdentifiers</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">numeric</span> <span class="o">=</span> <span class="sr">/^[0-9]+$/</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">compareIdentifiers</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">anum</span> <span class="o">=</span> <span class="nx">numeric</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">bnum</span> <span class="o">=</span> <span class="nx">numeric</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">anum</span> <span class="o">&amp;&amp;</span> <span class="nx">bnum</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="o">+</span><span class="nx">a</span><span class="p">;</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="o">+</span><span class="nx">b</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="nx">anum</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">bnum</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span>
           <span class="p">(</span><span class="nx">bnum</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">anum</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
           <span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span>
           <span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
           <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">rcompareIdentifiers</span> <span class="o">=</span> <span class="nx">rcompareIdentifiers</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">rcompareIdentifiers</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">compareIdentifiers</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">major</span> <span class="o">=</span> <span class="nx">major</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">major</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">loose</span><span class="p">).</span><span class="nx">major</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">minor</span> <span class="o">=</span> <span class="nx">minor</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">minor</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">loose</span><span class="p">).</span><span class="nx">minor</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">patch</span> <span class="o">=</span> <span class="nx">patch</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">patch</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">loose</span><span class="p">).</span><span class="nx">patch</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">compare</span> <span class="o">=</span> <span class="nx">compare</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">compare</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">loose</span><span class="p">).</span><span class="nx">compare</span><span class="p">(</span><span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">compareLoose</span> <span class="o">=</span> <span class="nx">compareLoose</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">compareLoose</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">compare</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">rcompare</span> <span class="o">=</span> <span class="nx">rcompare</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">rcompare</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">compare</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">sort</span> <span class="o">=</span> <span class="nx">sort</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">sort</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">list</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">rsort</span> <span class="o">=</span> <span class="nx">rsort</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">rsort</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">list</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">rcompare</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">gt</span> <span class="o">=</span> <span class="nx">gt</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">gt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">compare</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">lt</span> <span class="o">=</span> <span class="nx">lt</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">lt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">compare</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">eq</span> <span class="o">=</span> <span class="nx">eq</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">eq</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">compare</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">neq</span> <span class="o">=</span> <span class="nx">neq</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">neq</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">compare</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">gte</span> <span class="o">=</span> <span class="nx">gte</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">gte</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">compare</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">lte</span> <span class="o">=</span> <span class="nx">lte</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">lte</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">compare</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">cmp</span> <span class="o">=</span> <span class="nx">cmp</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">cmp</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">op</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ret</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;===&#39;</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;!==&#39;</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">!==</span> <span class="nx">b</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;&#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;=&#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;==&#39;</span><span class="o">:</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">eq</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;!=&#39;</span><span class="o">:</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">neq</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;&gt;&#39;</span><span class="o">:</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">gt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;&gt;=&#39;</span><span class="o">:</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">gte</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;&lt;&#39;</span><span class="o">:</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">lt</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;&lt;=&#39;</span><span class="o">:</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">lte</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid operator: &#39;</span> <span class="o">+</span> <span class="nx">op</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">Comparator</span> <span class="o">=</span> <span class="nx">Comparator</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">Comparator</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">comp</span> <span class="k">instanceof</span> <span class="nx">Comparator</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">loose</span> <span class="o">===</span> <span class="nx">loose</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">comp</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="nx">comp</span> <span class="o">=</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Comparator</span><span class="p">))</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Comparator</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>

    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;comparator&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">loose</span> <span class="o">=</span> <span class="nx">loose</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">comp</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">semver</span> <span class="o">===</span> <span class="nx">ANY</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">semver</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>

    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">ANY</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">Comparator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">comp</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loose</span> <span class="o">?</span> <span class="nx">re</span><span class="p">[</span><span class="nx">COMPARATORLOOSE</span><span class="p">]</span> <span class="o">:</span> <span class="nx">re</span><span class="p">[</span><span class="nx">COMPARATOR</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">m</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid comparator: &#39;</span> <span class="o">+</span> <span class="nx">comp</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;=&#39;</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

    <span class="c1">// if it literally is just &#39;&gt;&#39; or &#39;&#39; then allow anything.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">semver</span> <span class="o">=</span> <span class="nx">ANY</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">semver</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">loose</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Comparator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Comparator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">test</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">version</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Comparator.test&#39;</span><span class="p">,</span> <span class="nx">version</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">loose</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">semver</span> <span class="o">===</span> <span class="nx">ANY</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">version</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">loose</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">cmp</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">operator</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">semver</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">loose</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Comparator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">intersects</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">comp</span> <span class="k">instanceof</span> <span class="nx">Comparator</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;a Comparator is required&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">rangeTmp</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rangeTmp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">satisfies</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">rangeTmp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rangeTmp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">satisfies</span><span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">semver</span><span class="p">,</span> <span class="nx">rangeTmp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">sameDirectionIncreasing</span> <span class="o">=</span>
      <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">||</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">sameDirectionDecreasing</span> <span class="o">=</span>
      <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&lt;=&#39;</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&lt;=&#39;</span> <span class="o">||</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">sameSemVer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">semver</span><span class="p">.</span><span class="nx">version</span> <span class="o">===</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">semver</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">differentDirectionsInclusive</span> <span class="o">=</span>
      <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">||</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">oppositeDirectionsLessThan</span> <span class="o">=</span>
      <span class="nx">cmp</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">semver</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">semver</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&lt;=&#39;</span> <span class="o">||</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">oppositeDirectionsGreaterThan</span> <span class="o">=</span>
      <span class="nx">cmp</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">semver</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">semver</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&lt;=&#39;</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">||</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">));</span>

    <span class="k">return</span> <span class="nx">sameDirectionIncreasing</span> <span class="o">||</span> <span class="nx">sameDirectionDecreasing</span> <span class="o">||</span>
      <span class="p">(</span><span class="nx">sameSemVer</span> <span class="o">&amp;&amp;</span> <span class="nx">differentDirectionsInclusive</span><span class="p">)</span> <span class="o">||</span>
      <span class="nx">oppositeDirectionsLessThan</span> <span class="o">||</span> <span class="nx">oppositeDirectionsGreaterThan</span><span class="p">;</span>
  <span class="p">};</span>


  <span class="nx">exports</span><span class="p">.</span><span class="nx">Range</span> <span class="o">=</span> <span class="nx">Range</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">range</span> <span class="k">instanceof</span> <span class="nx">Range</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">loose</span> <span class="o">===</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">range</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">raw</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">range</span> <span class="k">instanceof</span> <span class="nx">Comparator</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Range</span><span class="p">))</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">loose</span> <span class="o">=</span> <span class="nx">loose</span><span class="p">;</span>

    <span class="c1">// First, split based on boolean or ||</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">raw</span> <span class="o">=</span> <span class="nx">range</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s*\|\|\s*/</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">range</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseRange</span><span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">trim</span><span class="p">());</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// throw out any that are not relevant for whatever reason</span>
      <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid SemVer Range: &#39;</span> <span class="o">+</span> <span class="nx">range</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">Range</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">comps</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">comps</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
    <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;||&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Range</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Range</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parseRange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">range</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">loose</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loose</span><span class="p">;</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="c1">// `1.2.3 - 1.2.4` =&gt; `&gt;=1.2.3 &lt;=1.2.4`</span>
    <span class="kd">var</span> <span class="nx">hr</span> <span class="o">=</span> <span class="nx">loose</span> <span class="o">?</span> <span class="nx">re</span><span class="p">[</span><span class="nx">HYPHENRANGELOOSE</span><span class="p">]</span> <span class="o">:</span> <span class="nx">re</span><span class="p">[</span><span class="nx">HYPHENRANGE</span><span class="p">];</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">hr</span><span class="p">,</span> <span class="nx">hyphenReplace</span><span class="p">);</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;hyphen replace&#39;</span><span class="p">,</span> <span class="nx">range</span><span class="p">);</span>
    <span class="c1">// `&gt; 1.2.3 &lt; 1.2.5` =&gt; `&gt;1.2.3 &lt;1.2.5`</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">[</span><span class="nx">COMPARATORTRIM</span><span class="p">],</span> <span class="nx">comparatorTrimReplace</span><span class="p">);</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;comparator trim&#39;</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">re</span><span class="p">[</span><span class="nx">COMPARATORTRIM</span><span class="p">]);</span>

    <span class="c1">// `~ 1.2.3` =&gt; `~1.2.3`</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">[</span><span class="nx">TILDETRIM</span><span class="p">],</span> <span class="nx">tildeTrimReplace</span><span class="p">);</span>

    <span class="c1">// `^ 1.2.3` =&gt; `^1.2.3`</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">[</span><span class="nx">CARETTRIM</span><span class="p">],</span> <span class="nx">caretTrimReplace</span><span class="p">);</span>

    <span class="c1">// normalize spaces</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>

    <span class="c1">// At this point, the range is completely trimmed and</span>
    <span class="c1">// ready to be split into comparators.</span>

    <span class="kd">var</span> <span class="nx">compRe</span> <span class="o">=</span> <span class="nx">loose</span> <span class="o">?</span> <span class="nx">re</span><span class="p">[</span><span class="nx">COMPARATORLOOSE</span><span class="p">]</span> <span class="o">:</span> <span class="nx">re</span><span class="p">[</span><span class="nx">COMPARATOR</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">set</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">comp</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">parseComparator</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// in loose mode, throw out any that are not valid comparators</span>
      <span class="nx">set</span> <span class="o">=</span> <span class="nx">set</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">comp</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!!</span><span class="nx">comp</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">compRe</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">set</span> <span class="o">=</span> <span class="nx">set</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">comp</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Comparator</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">set</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Range</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">intersects</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">range</span> <span class="k">instanceof</span> <span class="nx">Range</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;a Range is required&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">thisComparators</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">thisComparators</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">thisComparator</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">range</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">rangeComparators</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">rangeComparators</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">rangeComparator</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">thisComparator</span><span class="p">.</span><span class="nx">intersects</span><span class="p">(</span><span class="nx">rangeComparator</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="c1">// Mostly just for testing and legacy API reasons</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">toComparators</span> <span class="o">=</span> <span class="nx">toComparators</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">toComparators</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">).</span><span class="nx">set</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">comp</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// comprised of xranges, tildes, stars, and gtlt&#39;s at this point.</span>
  <span class="c1">// already replaced the hyphen ranges</span>
  <span class="c1">// turn into a set of JUST comparators.</span>
  <span class="kd">function</span> <span class="nx">parseComparator</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">);</span>
    <span class="nx">comp</span> <span class="o">=</span> <span class="nx">replaceCarets</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;caret&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">);</span>
    <span class="nx">comp</span> <span class="o">=</span> <span class="nx">replaceTildes</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;tildes&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">);</span>
    <span class="nx">comp</span> <span class="o">=</span> <span class="nx">replaceXRanges</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;xrange&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">);</span>
    <span class="nx">comp</span> <span class="o">=</span> <span class="nx">replaceStars</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;stars&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">comp</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isX</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="nx">id</span> <span class="o">||</span> <span class="nx">id</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;x&#39;</span> <span class="o">||</span> <span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// ~, ~&gt; --&gt; * (any, kinda silly)</span>
  <span class="c1">// ~2, ~2.x, ~2.x.x, ~&gt;2, ~&gt;2.x ~&gt;2.x.x --&gt; &gt;=2.0.0 &lt;3.0.0</span>
  <span class="c1">// ~2.0, ~2.0.x, ~&gt;2.0, ~&gt;2.0.x --&gt; &gt;=2.0.0 &lt;2.1.0</span>
  <span class="c1">// ~1.2, ~1.2.x, ~&gt;1.2, ~&gt;1.2.x --&gt; &gt;=1.2.0 &lt;1.3.0</span>
  <span class="c1">// ~1.2.3, ~&gt;1.2.3 --&gt; &gt;=1.2.3 &lt;1.3.0</span>
  <span class="c1">// ~1.2.0, ~&gt;1.2.0 --&gt; &gt;=1.2.0 &lt;1.3.0</span>
  <span class="kd">function</span> <span class="nx">replaceTildes</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">comp</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">replaceTilde</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">replaceTilde</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">loose</span> <span class="o">?</span> <span class="nx">re</span><span class="p">[</span><span class="nx">TILDELOOSE</span><span class="p">]</span> <span class="o">:</span> <span class="nx">re</span><span class="p">[</span><span class="nx">TILDE</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">M</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">pr</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;tilde&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">M</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">pr</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">ret</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">isX</span><span class="p">(</span><span class="nx">M</span><span class="p">))</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isX</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.0.0 &lt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0.0&#39;</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isX</span><span class="p">(</span><span class="nx">p</span><span class="p">))</span>
        <span class="c1">// ~1.2 == &gt;=1.2.0 &lt;1.3.0</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.0 &lt;&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0&#39;</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;replaceTilde pr&#39;</span><span class="p">,</span> <span class="nx">pr</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pr</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
          <span class="nx">pr</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">pr</span><span class="p">;</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">p</span> <span class="o">+</span> <span class="nx">pr</span> <span class="o">+</span>
              <span class="s1">&#39; &lt;&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span>
        <span class="c1">// ~1.2.3 == &gt;=1.2.3 &lt;1.3.0</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">p</span> <span class="o">+</span>
              <span class="s1">&#39; &lt;&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0&#39;</span><span class="p">;</span>

      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;tilde return&#39;</span><span class="p">,</span> <span class="nx">ret</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// ^ --&gt; * (any, kinda silly)</span>
  <span class="c1">// ^2, ^2.x, ^2.x.x --&gt; &gt;=2.0.0 &lt;3.0.0</span>
  <span class="c1">// ^2.0, ^2.0.x --&gt; &gt;=2.0.0 &lt;3.0.0</span>
  <span class="c1">// ^1.2, ^1.2.x --&gt; &gt;=1.2.0 &lt;2.0.0</span>
  <span class="c1">// ^1.2.3 --&gt; &gt;=1.2.3 &lt;2.0.0</span>
  <span class="c1">// ^1.2.0 --&gt; &gt;=1.2.0 &lt;2.0.0</span>
  <span class="kd">function</span> <span class="nx">replaceCarets</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">comp</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">replaceCaret</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">replaceCaret</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;caret&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">loose</span> <span class="o">?</span> <span class="nx">re</span><span class="p">[</span><span class="nx">CARETLOOSE</span><span class="p">]</span> <span class="o">:</span> <span class="nx">re</span><span class="p">[</span><span class="nx">CARET</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">M</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">pr</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;caret&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">M</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">pr</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">ret</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">isX</span><span class="p">(</span><span class="nx">M</span><span class="p">))</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isX</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.0.0 &lt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0.0&#39;</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isX</span><span class="p">(</span><span class="nx">p</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">M</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
          <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.0 &lt;&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0&#39;</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.0 &lt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0.0&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;replaceCaret pr&#39;</span><span class="p">,</span> <span class="nx">pr</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pr</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
          <span class="nx">pr</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">pr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">M</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">m</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
            <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">p</span> <span class="o">+</span> <span class="nx">pr</span> <span class="o">+</span>
                  <span class="s1">&#39; &lt;&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">else</span>
            <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">p</span> <span class="o">+</span> <span class="nx">pr</span> <span class="o">+</span>
                  <span class="s1">&#39; &lt;&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span>
          <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">p</span> <span class="o">+</span> <span class="nx">pr</span> <span class="o">+</span>
                <span class="s1">&#39; &lt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0.0&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;no pr&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">M</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">m</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
            <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">p</span> <span class="o">+</span>
                  <span class="s1">&#39; &lt;&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">else</span>
            <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">p</span> <span class="o">+</span>
                  <span class="s1">&#39; &lt;&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span>
          <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">p</span> <span class="o">+</span>
                <span class="s1">&#39; &lt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0.0&#39;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;caret return&#39;</span><span class="p">,</span> <span class="nx">ret</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">replaceXRanges</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;replaceXRanges&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">comp</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">replaceXRange</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">replaceXRange</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">comp</span> <span class="o">=</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">loose</span> <span class="o">?</span> <span class="nx">re</span><span class="p">[</span><span class="nx">XRANGELOOSE</span><span class="p">]</span> <span class="o">:</span> <span class="nx">re</span><span class="p">[</span><span class="nx">XRANGE</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">gtlt</span><span class="p">,</span> <span class="nx">M</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">pr</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;xRange&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">,</span> <span class="nx">ret</span><span class="p">,</span> <span class="nx">gtlt</span><span class="p">,</span> <span class="nx">M</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">pr</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">xM</span> <span class="o">=</span> <span class="nx">isX</span><span class="p">(</span><span class="nx">M</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">xm</span> <span class="o">=</span> <span class="nx">xM</span> <span class="o">||</span> <span class="nx">isX</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">xp</span> <span class="o">=</span> <span class="nx">xm</span> <span class="o">||</span> <span class="nx">isX</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">anyX</span> <span class="o">=</span> <span class="nx">xp</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">gtlt</span> <span class="o">===</span> <span class="s1">&#39;=&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">anyX</span><span class="p">)</span>
        <span class="nx">gtlt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">xM</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">gtlt</span> <span class="o">===</span> <span class="s1">&#39;&gt;&#39;</span> <span class="o">||</span> <span class="nx">gtlt</span> <span class="o">===</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// nothing is allowed</span>
          <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&lt;0.0.0&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// nothing is forbidden</span>
          <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">gtlt</span> <span class="o">&amp;&amp;</span> <span class="nx">anyX</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// replace X with 0</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">xm</span><span class="p">)</span>
          <span class="nx">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">xp</span><span class="p">)</span>
          <span class="nx">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">gtlt</span> <span class="o">===</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// &gt;1 =&gt; &gt;=2.0.0</span>
          <span class="c1">// &gt;1.2 =&gt; &gt;=1.3.0</span>
          <span class="c1">// &gt;1.2.3 =&gt; &gt;= 1.2.4</span>
          <span class="nx">gtlt</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">xm</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">M</span> <span class="o">=</span> <span class="o">+</span><span class="nx">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nx">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="nx">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">xp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">m</span> <span class="o">=</span> <span class="o">+</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nx">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">gtlt</span> <span class="o">===</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// &lt;=0.7.x is actually &lt;0.8.0, since any 0.7.x should</span>
          <span class="c1">// pass.  Similarly, &lt;=7.x is actually &lt;8.0.0, etc.</span>
          <span class="nx">gtlt</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">xm</span><span class="p">)</span>
            <span class="nx">M</span> <span class="o">=</span> <span class="o">+</span><span class="nx">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">else</span>
            <span class="nx">m</span> <span class="o">=</span> <span class="o">+</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">gtlt</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">xm</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.0.0 &lt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0.0&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">xp</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">m</span> <span class="o">+</span> <span class="s1">&#39;.0 &lt;&#39;</span> <span class="o">+</span> <span class="nx">M</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0&#39;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;xRange return&#39;</span><span class="p">,</span> <span class="nx">ret</span><span class="p">);</span>

      <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// Because * is AND-ed with everything else in the comparator,</span>
  <span class="c1">// and &#39;&#39; means &quot;any version&quot;, just remove the *s entirely.</span>
  <span class="kd">function</span> <span class="nx">replaceStars</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;replaceStars&#39;</span><span class="p">,</span> <span class="nx">comp</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="c1">// Looseness is ignored here.  star is always as loose as it gets!</span>
    <span class="k">return</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">[</span><span class="nx">STAR</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// This function is passed to string.replace(re[HYPHENRANGE])</span>
  <span class="c1">// M, m, patch, prerelease, build</span>
  <span class="c1">// 1.2 - 3.4.5 =&gt; &gt;=1.2.0 &lt;=3.4.5</span>
  <span class="c1">// 1.2.3 - 3.4 =&gt; &gt;=1.2.0 &lt;3.5.0 Any 3.4.x will do</span>
  <span class="c1">// 1.2 - 3.4 =&gt; &gt;=1.2.0 &lt;3.5.0</span>
  <span class="kd">function</span> <span class="nx">hyphenReplace</span><span class="p">(</span><span class="nx">$0</span><span class="p">,</span>
                         <span class="nx">from</span><span class="p">,</span> <span class="nx">fM</span><span class="p">,</span> <span class="nx">fm</span><span class="p">,</span> <span class="nx">fp</span><span class="p">,</span> <span class="nx">fpr</span><span class="p">,</span> <span class="nx">fb</span><span class="p">,</span>
                         <span class="nx">to</span><span class="p">,</span> <span class="nx">tM</span><span class="p">,</span> <span class="nx">tm</span><span class="p">,</span> <span class="nx">tp</span><span class="p">,</span> <span class="nx">tpr</span><span class="p">,</span> <span class="nx">tb</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isX</span><span class="p">(</span><span class="nx">fM</span><span class="p">))</span>
      <span class="nx">from</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isX</span><span class="p">(</span><span class="nx">fm</span><span class="p">))</span>
      <span class="nx">from</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">fM</span> <span class="o">+</span> <span class="s1">&#39;.0.0&#39;</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isX</span><span class="p">(</span><span class="nx">fp</span><span class="p">))</span>
      <span class="nx">from</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">fM</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">fm</span> <span class="o">+</span> <span class="s1">&#39;.0&#39;</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="nx">from</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="o">+</span> <span class="nx">from</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isX</span><span class="p">(</span><span class="nx">tM</span><span class="p">))</span>
      <span class="nx">to</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isX</span><span class="p">(</span><span class="nx">tm</span><span class="p">))</span>
      <span class="nx">to</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">tM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0.0&#39;</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isX</span><span class="p">(</span><span class="nx">tp</span><span class="p">))</span>
      <span class="nx">to</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">tM</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="nx">tm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.0&#39;</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">tpr</span><span class="p">)</span>
      <span class="nx">to</span> <span class="o">=</span> <span class="s1">&#39;&lt;=&#39;</span> <span class="o">+</span> <span class="nx">tM</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">tm</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">tp</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">tpr</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="nx">to</span> <span class="o">=</span> <span class="s1">&#39;&lt;=&#39;</span> <span class="o">+</span> <span class="nx">to</span><span class="p">;</span>

    <span class="k">return</span> <span class="p">(</span><span class="nx">from</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">to</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
  <span class="p">}</span>


  <span class="c1">// if ANY of the sets match ALL of its comparators, then pass</span>
  <span class="nx">Range</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">test</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">version</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">version</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">version</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
      <span class="nx">version</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">loose</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">testSet</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">version</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">testSet</span><span class="p">(</span><span class="nx">set</span><span class="p">,</span> <span class="nx">version</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">set</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">set</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">test</span><span class="p">(</span><span class="nx">version</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">version</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Find the set of versions that are allowed to have prereleases</span>
      <span class="c1">// For example, ^1.2.3-pr.1 desugars to &gt;=1.2.3-pr.1 &lt;2.0.0</span>
      <span class="c1">// That should allow `1.2.3-pr.2` to pass.</span>
      <span class="c1">// However, `1.2.4-alpha.notready` should NOT be allowed,</span>
      <span class="c1">// even though it&#39;s within the range set by the comparators.</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">set</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="nx">set</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">semver</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">set</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">semver</span> <span class="o">===</span> <span class="nx">ANY</span><span class="p">)</span>
          <span class="k">continue</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">set</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">semver</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">allowed</span> <span class="o">=</span> <span class="nx">set</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">semver</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">allowed</span><span class="p">.</span><span class="nx">major</span> <span class="o">===</span> <span class="nx">version</span><span class="p">.</span><span class="nx">major</span> <span class="o">&amp;&amp;</span>
              <span class="nx">allowed</span><span class="p">.</span><span class="nx">minor</span> <span class="o">===</span> <span class="nx">version</span><span class="p">.</span><span class="nx">minor</span> <span class="o">&amp;&amp;</span>
              <span class="nx">allowed</span><span class="p">.</span><span class="nx">patch</span> <span class="o">===</span> <span class="nx">version</span><span class="p">.</span><span class="nx">patch</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// Version has a -pre, but it&#39;s not one of the ones we like.</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">satisfies</span> <span class="o">=</span> <span class="nx">satisfies</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">satisfies</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">range</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">er</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">range</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">version</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">maxSatisfying</span> <span class="o">=</span> <span class="nx">maxSatisfying</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">maxSatisfying</span><span class="p">(</span><span class="nx">versions</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">max</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">maxSV</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">rangeObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">er</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">versions</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">rangeObj</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// satisfies(v, range, loose)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">max</span> <span class="o">||</span> <span class="nx">maxSV</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// compare(max, v, true)</span>
          <span class="nx">max</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
          <span class="nx">maxSV</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">max</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">max</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">minSatisfying</span> <span class="o">=</span> <span class="nx">minSatisfying</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">minSatisfying</span><span class="p">(</span><span class="nx">versions</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">min</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">minSV</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">rangeObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">er</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">versions</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">rangeObj</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// satisfies(v, range, loose)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">min</span> <span class="o">||</span> <span class="nx">minSV</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// compare(min, v, true)</span>
          <span class="nx">min</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
          <span class="nx">minSV</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">min</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">min</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">validRange</span> <span class="o">=</span> <span class="nx">validRange</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">validRange</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// Return &#39;*&#39; instead of &#39;&#39; so that truthiness works.</span>
      <span class="c1">// This will throw if it&#39;s invalid anyway</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">).</span><span class="nx">range</span> <span class="o">||</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">er</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Determine if version is less than all the versions possible in the range</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">ltr</span> <span class="o">=</span> <span class="nx">ltr</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">ltr</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">outside</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Determine if version is greater than all the versions possible in the range.</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">gtr</span> <span class="o">=</span> <span class="nx">gtr</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">gtr</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">outside</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">outside</span> <span class="o">=</span> <span class="nx">outside</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">outside</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">hilo</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">version</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SemVer</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">gtfn</span><span class="p">,</span> <span class="nx">ltefn</span><span class="p">,</span> <span class="nx">ltfn</span><span class="p">,</span> <span class="nx">comp</span><span class="p">,</span> <span class="nx">ecomp</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">hilo</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;&gt;&#39;</span><span class="o">:</span>
        <span class="nx">gtfn</span> <span class="o">=</span> <span class="nx">gt</span><span class="p">;</span>
        <span class="nx">ltefn</span> <span class="o">=</span> <span class="nx">lte</span><span class="p">;</span>
        <span class="nx">ltfn</span> <span class="o">=</span> <span class="nx">lt</span><span class="p">;</span>
        <span class="nx">comp</span> <span class="o">=</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">;</span>
        <span class="nx">ecomp</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;&lt;&#39;</span><span class="o">:</span>
        <span class="nx">gtfn</span> <span class="o">=</span> <span class="nx">lt</span><span class="p">;</span>
        <span class="nx">ltefn</span> <span class="o">=</span> <span class="nx">gte</span><span class="p">;</span>
        <span class="nx">ltfn</span> <span class="o">=</span> <span class="nx">gt</span><span class="p">;</span>
        <span class="nx">comp</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">;</span>
        <span class="nx">ecomp</span> <span class="o">=</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Must provide a hilo val of &quot;&lt;&quot; or &quot;&gt;&quot;&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// If it satisifes the range it is not outside</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">satisfies</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">loose</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// From now on, variable terms are as if we&#39;re in &quot;gtr&quot; mode.</span>
    <span class="c1">// but note that everything is flipped for the &quot;ltr&quot; function.</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">range</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">comparators</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">set</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

      <span class="kd">var</span> <span class="nx">high</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">low</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

      <span class="nx">comparators</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">comparator</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">comparator</span><span class="p">.</span><span class="nx">semver</span> <span class="o">===</span> <span class="nx">ANY</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">comparator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comparator</span><span class="p">(</span><span class="s1">&#39;&gt;=0.0.0&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">high</span> <span class="o">=</span> <span class="nx">high</span> <span class="o">||</span> <span class="nx">comparator</span><span class="p">;</span>
        <span class="nx">low</span> <span class="o">=</span> <span class="nx">low</span> <span class="o">||</span> <span class="nx">comparator</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">gtfn</span><span class="p">(</span><span class="nx">comparator</span><span class="p">.</span><span class="nx">semver</span><span class="p">,</span> <span class="nx">high</span><span class="p">.</span><span class="nx">semver</span><span class="p">,</span> <span class="nx">loose</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">high</span> <span class="o">=</span> <span class="nx">comparator</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ltfn</span><span class="p">(</span><span class="nx">comparator</span><span class="p">.</span><span class="nx">semver</span><span class="p">,</span> <span class="nx">low</span><span class="p">.</span><span class="nx">semver</span><span class="p">,</span> <span class="nx">loose</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">low</span> <span class="o">=</span> <span class="nx">comparator</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// If the edge version comparator has a operator then our version</span>
      <span class="c1">// isn&#39;t outside it</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">high</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="nx">comp</span> <span class="o">||</span> <span class="nx">high</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="nx">ecomp</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// If the lowest version comparator has an operator and our version</span>
      <span class="c1">// is less than it then it isn&#39;t higher than the range</span>
      <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="nx">low</span><span class="p">.</span><span class="nx">operator</span> <span class="o">||</span> <span class="nx">low</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="nx">comp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="nx">ltefn</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">low</span><span class="p">.</span><span class="nx">semver</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">low</span><span class="p">.</span><span class="nx">operator</span> <span class="o">===</span> <span class="nx">ecomp</span> <span class="o">&amp;&amp;</span> <span class="nx">ltfn</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">low</span><span class="p">.</span><span class="nx">semver</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">prerelease</span> <span class="o">=</span> <span class="nx">prerelease</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">prerelease</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">version</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">parsed</span> <span class="o">&amp;&amp;</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">?</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">prerelease</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">intersects</span> <span class="o">=</span> <span class="nx">intersects</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">intersects</span><span class="p">(</span><span class="nx">r1</span><span class="p">,</span> <span class="nx">r2</span><span class="p">,</span> <span class="nx">loose</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">r1</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="nx">r2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Range</span><span class="p">(</span><span class="nx">r2</span><span class="p">,</span> <span class="nx">loose</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">r1</span><span class="p">.</span><span class="nx">intersects</span><span class="p">(</span><span class="nx">r2</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">coerce</span> <span class="o">=</span> <span class="nx">coerce</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">coerce</span><span class="p">(</span><span class="nx">version</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="k">instanceof</span> <span class="nx">SemVer</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">version</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">version</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">version</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">re</span><span class="p">[</span><span class="nx">COERCE</span><span class="p">]);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">match</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">parse</span><span class="p">((</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;0&#39;</span><span class="p">));</span> 
  <span class="p">}</span>
  <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">semver_1</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">SEMVER_SPEC_VERSION</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_2</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">re</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_3</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">src</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_4</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">parse</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_5</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">valid</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_6</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">clean</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_7</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">SemVer</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_8</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">inc</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_9</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">diff</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_10</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">compareIdentifiers</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_11</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">rcompareIdentifiers</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_12</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">major</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_13</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">minor</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_14</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">patch</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_15</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">compare</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_16</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">compareLoose</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_17</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">rcompare</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_18</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">sort</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_19</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">rsort</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_20</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">gt</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_21</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">lt</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_22</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">eq</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_23</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">neq</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_24</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">gte</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_25</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">lte</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_26</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">cmp</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_27</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">Comparator</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_28</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">Range</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_29</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">toComparators</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_30</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">satisfies</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_31</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">maxSatisfying</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_32</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">minSatisfying</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_33</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">validRange</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_34</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">ltr</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_35</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">gtr</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_36</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">outside</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_37</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">prerelease</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_38</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">intersects</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">semver_39</span> <span class="o">=</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">coerce</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">vegaSchemaUrlParser</span> <span class="o">=</span> <span class="nx">createCommonjsModule</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="s2">&quot;__esModule&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">value</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
  <span class="cm">/**</span>
<span class="cm">   * Parse a vega schema url into library and version.</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">default_1</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">regex</span> <span class="o">=</span> <span class="sr">/\/schema\/([\w-]+)\/([\w\.\-]+)\.json$/g</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">_a</span> <span class="o">=</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nx">library</span> <span class="o">=</span> <span class="nx">_a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">version</span> <span class="o">=</span> <span class="nx">_a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">return</span> <span class="p">{</span> <span class="nx">library</span><span class="o">:</span> <span class="nx">library</span><span class="p">,</span> <span class="nx">version</span><span class="o">:</span> <span class="nx">version</span> <span class="p">};</span>
  <span class="p">}</span>
  <span class="nx">exports</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="nx">default_1</span><span class="p">;</span>

  <span class="p">});</span>

  <span class="kd">var</span> <span class="nx">schemaParser</span> <span class="o">=</span> <span class="nx">unwrapExports</span><span class="p">(</span><span class="nx">vegaSchemaUrlParser</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">markColor</span> <span class="o">=</span> <span class="s1">&#39;#4572a7&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">excelTheme</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">background</span><span class="o">:</span> <span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
      <span class="nx">arc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor</span> <span class="p">},</span>
      <span class="nx">area</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor</span> <span class="p">},</span>
      <span class="nx">line</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor</span><span class="p">,</span> <span class="nx">strokeWidth</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
      <span class="nx">path</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor</span> <span class="p">},</span>
      <span class="nx">rect</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor</span> <span class="p">},</span>
      <span class="nx">shape</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor</span> <span class="p">},</span>
      <span class="nx">symbol</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor</span><span class="p">,</span> <span class="nx">strokeWidth</span><span class="o">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="nx">size</span><span class="o">:</span> <span class="mi">50</span> <span class="p">},</span>
      <span class="nx">axis</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">bandPosition</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span>
          <span class="nx">grid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">gridColor</span><span class="o">:</span> <span class="s1">&#39;#000000&#39;</span><span class="p">,</span>
          <span class="nx">gridOpacity</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">gridWidth</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span>
          <span class="nx">labelPadding</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
          <span class="nx">tickSize</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
          <span class="nx">tickWidth</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">axisBand</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">grid</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">tickExtra</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">legend</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">labelBaseline</span><span class="o">:</span> <span class="s1">&#39;middle&#39;</span><span class="p">,</span>
          <span class="nx">labelFontSize</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span>
          <span class="nx">symbolSize</span><span class="o">:</span> <span class="mi">50</span><span class="p">,</span>
          <span class="nx">symbolType</span><span class="o">:</span> <span class="s1">&#39;square&#39;</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">range</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">category</span><span class="o">:</span> <span class="p">[</span>
              <span class="s1">&#39;#4572a7&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#aa4643&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#8aa453&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#71598e&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#4598ae&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#d98445&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#94aace&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#d09393&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#b9cc98&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#a99cbc&#39;</span><span class="p">,</span>
          <span class="p">],</span>
      <span class="p">},</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">markColor$1</span> <span class="o">=</span> <span class="s1">&#39;#000&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ggplot2Theme</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">group</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">fill</span><span class="o">:</span> <span class="s1">&#39;#e5e5e5&#39;</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">arc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$1</span> <span class="p">},</span>
      <span class="nx">area</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$1</span> <span class="p">},</span>
      <span class="nx">line</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor$1</span> <span class="p">},</span>
      <span class="nx">path</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor$1</span> <span class="p">},</span>
      <span class="nx">rect</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$1</span> <span class="p">},</span>
      <span class="nx">shape</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor$1</span> <span class="p">},</span>
      <span class="nx">symbol</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$1</span><span class="p">,</span> <span class="nx">size</span><span class="o">:</span> <span class="mi">40</span> <span class="p">},</span>
      <span class="nx">axis</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">domain</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">grid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">gridColor</span><span class="o">:</span> <span class="s1">&#39;#FFFFFF&#39;</span><span class="p">,</span>
          <span class="nx">gridOpacity</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">labelColor</span><span class="o">:</span> <span class="s1">&#39;#7F7F7F&#39;</span><span class="p">,</span>
          <span class="nx">labelPadding</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
          <span class="nx">tickColor</span><span class="o">:</span> <span class="s1">&#39;#7F7F7F&#39;</span><span class="p">,</span>
          <span class="nx">tickSize</span><span class="o">:</span> <span class="mf">5.67</span><span class="p">,</span>
          <span class="nx">titleFontSize</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
          <span class="nx">titleFontWeight</span><span class="o">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">legend</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">labelBaseline</span><span class="o">:</span> <span class="s1">&#39;middle&#39;</span><span class="p">,</span>
          <span class="nx">labelFontSize</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span>
          <span class="nx">symbolSize</span><span class="o">:</span> <span class="mi">40</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">range</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">category</span><span class="o">:</span> <span class="p">[</span>
              <span class="s1">&#39;#000000&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#7F7F7F&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#1A1A1A&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#999999&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#333333&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#B0B0B0&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#4D4D4D&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#C9C9C9&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#666666&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#DCDCDC&#39;</span><span class="p">,</span>
          <span class="p">],</span>
      <span class="p">},</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">markColor$2</span> <span class="o">=</span> <span class="s1">&#39;#ab5787&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">axisColor</span> <span class="o">=</span> <span class="s1">&#39;#979797&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">quartzTheme</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">background</span><span class="o">:</span> <span class="s1">&#39;#f9f9f9&#39;</span><span class="p">,</span>
      <span class="nx">arc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$2</span> <span class="p">},</span>
      <span class="nx">area</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$2</span> <span class="p">},</span>
      <span class="nx">line</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor$2</span> <span class="p">},</span>
      <span class="nx">path</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor$2</span> <span class="p">},</span>
      <span class="nx">rect</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$2</span> <span class="p">},</span>
      <span class="nx">shape</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor$2</span> <span class="p">},</span>
      <span class="nx">symbol</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$2</span><span class="p">,</span> <span class="nx">size</span><span class="o">:</span> <span class="mi">30</span> <span class="p">},</span>
      <span class="nx">axis</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">domainColor</span><span class="o">:</span> <span class="nx">axisColor</span><span class="p">,</span>
          <span class="nx">domainWidth</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span>
          <span class="nx">gridWidth</span><span class="o">:</span> <span class="mf">0.2</span><span class="p">,</span>
          <span class="nx">labelColor</span><span class="o">:</span> <span class="nx">axisColor</span><span class="p">,</span>
          <span class="nx">tickColor</span><span class="o">:</span> <span class="nx">axisColor</span><span class="p">,</span>
          <span class="nx">tickWidth</span><span class="o">:</span> <span class="mf">0.2</span><span class="p">,</span>
          <span class="nx">titleColor</span><span class="o">:</span> <span class="nx">axisColor</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">axisBand</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">grid</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">axisX</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">grid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">tickSize</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">axisY</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">domain</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">grid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">tickSize</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">legend</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">labelFontSize</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span>
          <span class="nx">padding</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">symbolSize</span><span class="o">:</span> <span class="mi">30</span><span class="p">,</span>
          <span class="nx">symbolType</span><span class="o">:</span> <span class="s1">&#39;square&#39;</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">range</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">category</span><span class="o">:</span> <span class="p">[</span>
              <span class="s1">&#39;#ab5787&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#51b2e5&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#703c5c&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#168dd9&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#d190b6&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#00609f&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#d365ba&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#154866&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#666666&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#c4c4c4&#39;</span><span class="p">,</span>
          <span class="p">],</span>
      <span class="p">},</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">markColor$3</span> <span class="o">=</span> <span class="s1">&#39;#3e5c69&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">voxTheme</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">background</span><span class="o">:</span> <span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
      <span class="nx">arc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$3</span> <span class="p">},</span>
      <span class="nx">area</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$3</span> <span class="p">},</span>
      <span class="nx">line</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor$3</span> <span class="p">},</span>
      <span class="nx">path</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor$3</span> <span class="p">},</span>
      <span class="nx">rect</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$3</span> <span class="p">},</span>
      <span class="nx">shape</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor$3</span> <span class="p">},</span>
      <span class="nx">symbol</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$3</span> <span class="p">},</span>
      <span class="nx">axis</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">domainWidth</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span>
          <span class="nx">grid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">labelPadding</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
          <span class="nx">tickSize</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
          <span class="nx">tickWidth</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span>
          <span class="nx">titleFontWeight</span><span class="o">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">axisBand</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">grid</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">axisX</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">gridWidth</span><span class="o">:</span> <span class="mf">0.2</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">axisY</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">gridDash</span><span class="o">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>
          <span class="nx">gridWidth</span><span class="o">:</span> <span class="mf">0.4</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">legend</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">labelFontSize</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span>
          <span class="nx">padding</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">symbolType</span><span class="o">:</span> <span class="s1">&#39;square&#39;</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">range</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">category</span><span class="o">:</span> <span class="p">[</span>
              <span class="s1">&#39;#3e5c69&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#6793a6&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#182429&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#0570b0&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#3690c0&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#74a9cf&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#a6bddb&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#e2ddf2&#39;</span><span class="p">,</span>
          <span class="p">],</span>
      <span class="p">},</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">lightColor</span> <span class="o">=</span> <span class="s1">&#39;#fff&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">medColor</span> <span class="o">=</span> <span class="s1">&#39;#aaa&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">darkTheme</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">background</span><span class="o">:</span> <span class="s1">&#39;#333&#39;</span><span class="p">,</span>
      <span class="nx">title</span><span class="o">:</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="nx">lightColor</span> <span class="p">},</span>
      <span class="nx">style</span><span class="o">:</span> <span class="p">{</span>
          <span class="s1">&#39;guide-label&#39;</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">fill</span><span class="o">:</span> <span class="nx">lightColor</span><span class="p">,</span>
          <span class="p">},</span>
          <span class="s1">&#39;guide-title&#39;</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">fill</span><span class="o">:</span> <span class="nx">lightColor</span><span class="p">,</span>
          <span class="p">},</span>
      <span class="p">},</span>
      <span class="nx">axis</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">domainColor</span><span class="o">:</span> <span class="nx">lightColor</span><span class="p">,</span>
          <span class="nx">gridColor</span><span class="o">:</span> <span class="nx">medColor</span><span class="p">,</span>
          <span class="nx">tickColor</span><span class="o">:</span> <span class="nx">lightColor</span><span class="p">,</span>
      <span class="p">},</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">markColor$4</span> <span class="o">=</span> <span class="s1">&#39;#30a2da&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">axisColor$1</span> <span class="o">=</span> <span class="s1">&#39;#cbcbcb&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s1">&#39;#f0f0f0&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">fivethirtyeighttheme</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">arc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$4</span> <span class="p">},</span>
      <span class="nx">area</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$4</span> <span class="p">},</span>
      <span class="nx">axisBand</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">grid</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">axisBottom</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">domain</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">domainColor</span><span class="o">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
          <span class="nx">domainWidth</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
          <span class="nx">grid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">gridColor</span><span class="o">:</span> <span class="nx">axisColor$1</span><span class="p">,</span>
          <span class="nx">gridWidth</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">labelFontSize</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span>
          <span class="nx">labelPadding</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
          <span class="nx">tickColor</span><span class="o">:</span> <span class="nx">axisColor$1</span><span class="p">,</span>
          <span class="nx">tickSize</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
          <span class="nx">titleFontSize</span><span class="o">:</span> <span class="mi">14</span><span class="p">,</span>
          <span class="nx">titlePadding</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">axisLeft</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">domainColor</span><span class="o">:</span> <span class="nx">axisColor$1</span><span class="p">,</span>
          <span class="nx">domainWidth</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">gridColor</span><span class="o">:</span> <span class="nx">axisColor$1</span><span class="p">,</span>
          <span class="nx">gridWidth</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">labelFontSize</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span>
          <span class="nx">labelPadding</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
          <span class="nx">tickColor</span><span class="o">:</span> <span class="nx">axisColor$1</span><span class="p">,</span>
          <span class="nx">tickSize</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
          <span class="nx">ticks</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">titleFontSize</span><span class="o">:</span> <span class="mi">14</span><span class="p">,</span>
          <span class="nx">titlePadding</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">axisRight</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">domainColor</span><span class="o">:</span> <span class="nx">axisColor$1</span><span class="p">,</span>
          <span class="nx">domainWidth</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">gridColor</span><span class="o">:</span> <span class="nx">axisColor$1</span><span class="p">,</span>
          <span class="nx">gridWidth</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">labelFontSize</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span>
          <span class="nx">labelPadding</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
          <span class="nx">tickColor</span><span class="o">:</span> <span class="nx">axisColor$1</span><span class="p">,</span>
          <span class="nx">tickSize</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
          <span class="nx">ticks</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">titleFontSize</span><span class="o">:</span> <span class="mi">14</span><span class="p">,</span>
          <span class="nx">titlePadding</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">axisTop</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">domain</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">domainColor</span><span class="o">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
          <span class="nx">domainWidth</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
          <span class="nx">grid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">gridColor</span><span class="o">:</span> <span class="nx">axisColor$1</span><span class="p">,</span>
          <span class="nx">gridWidth</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">labelFontSize</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span>
          <span class="nx">labelPadding</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
          <span class="nx">tickColor</span><span class="o">:</span> <span class="nx">axisColor$1</span><span class="p">,</span>
          <span class="nx">tickSize</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
          <span class="nx">titleFontSize</span><span class="o">:</span> <span class="mi">14</span><span class="p">,</span>
          <span class="nx">titlePadding</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">background</span><span class="o">:</span> <span class="nx">backgroundColor</span><span class="p">,</span>
      <span class="nx">group</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">fill</span><span class="o">:</span> <span class="nx">backgroundColor</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">legend</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">labelFontSize</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span>
          <span class="nx">padding</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">symbolSize</span><span class="o">:</span> <span class="mi">30</span><span class="p">,</span>
          <span class="nx">symbolType</span><span class="o">:</span> <span class="s1">&#39;square&#39;</span><span class="p">,</span>
          <span class="nx">titleFontSize</span><span class="o">:</span> <span class="mi">14</span><span class="p">,</span>
          <span class="nx">titlePadding</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">line</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor$4</span><span class="p">,</span>
          <span class="nx">strokeWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">path</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor$4</span><span class="p">,</span> <span class="nx">strokeWidth</span><span class="o">:</span> <span class="mf">0.5</span> <span class="p">},</span>
      <span class="nx">rect</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$4</span> <span class="p">},</span>
      <span class="nx">range</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">category</span><span class="o">:</span> <span class="p">[</span>
              <span class="s1">&#39;#30a2da&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#fc4f30&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#e5ae38&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#6d904f&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#8b8b8b&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#b96db8&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#ff9e27&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#56cc60&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#52d2ca&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#52689e&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#545454&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#9fe4f8&#39;</span><span class="p">,</span>
          <span class="p">],</span>
          <span class="nx">diverging</span><span class="o">:</span> <span class="p">[</span>
              <span class="s1">&#39;#cc0020&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#e77866&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#f6e7e1&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#d6e8ed&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#91bfd9&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#1d78b5&#39;</span><span class="p">,</span>
          <span class="p">],</span>
          <span class="nx">heatmap</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;#d6e8ed&#39;</span><span class="p">,</span> <span class="s1">&#39;#cee0e5&#39;</span><span class="p">,</span> <span class="s1">&#39;#91bfd9&#39;</span><span class="p">,</span> <span class="s1">&#39;#549cc6&#39;</span><span class="p">,</span> <span class="s1">&#39;#1d78b5&#39;</span><span class="p">],</span>
      <span class="p">},</span>
      <span class="nx">symbol</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">opacity</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">shape</span><span class="o">:</span> <span class="s1">&#39;circle&#39;</span><span class="p">,</span>
          <span class="nx">size</span><span class="o">:</span> <span class="mi">40</span><span class="p">,</span>
          <span class="nx">strokeWidth</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">shape</span><span class="o">:</span> <span class="p">{</span> <span class="nx">stroke</span><span class="o">:</span> <span class="nx">markColor$4</span> <span class="p">},</span>
      <span class="nx">style</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">bar</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">binSpacing</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="nx">fill</span><span class="o">:</span> <span class="nx">markColor$4</span><span class="p">,</span>
              <span class="nx">stroke</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
          <span class="p">},</span>
      <span class="p">},</span>
      <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">anchor</span><span class="o">:</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span>
          <span class="nx">fontSize</span><span class="o">:</span> <span class="mi">24</span><span class="p">,</span>
          <span class="nx">fontWeight</span><span class="o">:</span> <span class="mi">600</span><span class="p">,</span>
          <span class="nx">offset</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
      <span class="p">},</span>
  <span class="p">};</span>



  <span class="kd">var</span> <span class="nx">themes</span> <span class="o">=</span> <span class="cm">/*#__PURE__*/</span><span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">({</span>
    <span class="nx">excel</span><span class="o">:</span> <span class="nx">excelTheme</span><span class="p">,</span>
    <span class="nx">ggplot2</span><span class="o">:</span> <span class="nx">ggplot2Theme</span><span class="p">,</span>
    <span class="nx">quartz</span><span class="o">:</span> <span class="nx">quartzTheme</span><span class="p">,</span>
    <span class="nx">vox</span><span class="o">:</span> <span class="nx">voxTheme</span><span class="p">,</span>
    <span class="nx">dark</span><span class="o">:</span> <span class="nx">darkTheme</span><span class="p">,</span>
    <span class="nx">fivethirtyeight</span><span class="o">:</span> <span class="nx">fivethirtyeighttheme</span>
  <span class="p">});</span>

  <span class="c1">// generated with build-style.sh</span>
  <span class="kd">var</span> <span class="nx">defaultStyle</span> <span class="o">=</span> <span class="s2">&quot;#vg-tooltip-element {\n  visibility: hidden;\n  padding: 8px;\n  position: fixed;\n  z-index: 1000;\n  font-family: sans-serif;\n  font-size: 11px;\n  border-radius: 3px;\n  box-shadow: 2px 2px 4px rgba(0,0,0,0.1);\n\n  /* The default theme is the light theme. */\n  background-color: rgba(255, 255, 255, 0.95);\n  border: 1px solid #d9d9d9;\n  color: black;\n}\n#vg-tooltip-element.visible {\n  visibility: visible;\n}\n#vg-tooltip-element h2 {\n  margin-top: 0;\n  margin-bottom: 10px;\n  font-size: 13px;\n}\n#vg-tooltip-element table {\n  border-spacing: 0;\n}\n#vg-tooltip-element td {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  padding-top: 2px;\n  padding-bottom: 2px;\n}\n#vg-tooltip-element td.key {\n  color: #808080;\n  max-width: 150px;\n  text-align: right;\n  padding-right: 4px;\n}\n#vg-tooltip-element td.value {\n  display: block;\n  max-width: 300px;\n  max-height: 7em;\n  text-align: left;\n}\n\n/* Dark and light color themes */\n#vg-tooltip-element.dark-theme {\n  background-color: rgba(32, 32, 32, 0.9);\n  border: 1px solid #f5f5f5;\n  color: white;\n}\n#vg-tooltip-element.dark-theme td.key {\n  color: #bfbfbf;\n}\n\n#vg-tooltip-element.light-theme {\n  background-color: rgba(255, 255, 255, 0.95);\n  border: 1px solid #d9d9d9;\n  color: black;\n}\n#vg-tooltip-element.light-theme td.key {\n  color: #808080;\n}&quot;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">EL_ID</span> <span class="o">=</span> <span class="s1">&#39;vg-tooltip-element&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">DEFAULT_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
      <span class="cm">/**</span>
<span class="cm">       * X offset.</span>
<span class="cm">       */</span>
      <span class="nx">offsetX</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="cm">/**</span>
<span class="cm">       * Y offset.</span>
<span class="cm">       */</span>
      <span class="nx">offsetY</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="cm">/**</span>
<span class="cm">       * ID of the tooltip element.</span>
<span class="cm">       */</span>
      <span class="nx">id</span><span class="o">:</span> <span class="nx">EL_ID</span><span class="p">,</span>
      <span class="cm">/**</span>
<span class="cm">       * ID of the tooltip CSS style.</span>
<span class="cm">       */</span>
      <span class="nx">styleId</span><span class="o">:</span> <span class="s1">&#39;vega-tooltip-style&#39;</span><span class="p">,</span>
      <span class="cm">/**</span>
<span class="cm">       * The name of the theme. You can use the CSS class called [THEME]-theme to style the tooltips.</span>
<span class="cm">       *</span>
<span class="cm">       * There are two predefined themes: &quot;light&quot; (default) and &quot;dark&quot;.</span>
<span class="cm">       */</span>
      <span class="nx">theme</span><span class="o">:</span> <span class="s1">&#39;light&#39;</span><span class="p">,</span>
      <span class="cm">/**</span>
<span class="cm">       * Do not use the default styles provided by Vega Tooltip. If you enable this option, you need to use your own styles. It is not necessary to disable the default style when using a custom theme.</span>
<span class="cm">       */</span>
      <span class="nx">disableDefaultStyle</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="cm">/**</span>
<span class="cm">       * HTML sanitizer function that removes dangerous HTML to prevent XSS.</span>
<span class="cm">       *</span>
<span class="cm">       * This should be a function from string to string. You may replace it with a formatter such as a markdown formatter.</span>
<span class="cm">       */</span>
      <span class="nx">sanitize</span><span class="o">:</span> <span class="nx">escapeHTML</span><span class="p">,</span>
      <span class="cm">/**</span>
<span class="cm">       * The maximum recursion depth when printing objects in the tooltip.</span>
<span class="cm">       */</span>
      <span class="nx">maxDepth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="p">};</span>
  <span class="cm">/**</span>
<span class="cm">   * Escape special HTML characters.</span>
<span class="cm">   *</span>
<span class="cm">   * @param value A value to convert to string and HTML-escape.</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">escapeHTML</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;amp;&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">createDefaultStyle</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Just in case this id comes from a user, ensure these is no security issues</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^[A-Za-z]+[-:.\w]*$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid HTML ID&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">defaultStyle</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="nx">EL_ID</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Format the value to be shown in the toolip.</span>
<span class="cm">   *</span>
<span class="cm">   * @param value The value to show in the tooltip.</span>
<span class="cm">   * @param valueToHtml Function to convert a single cell value to an HTML string</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">formatValue</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">valueToHtml</span><span class="p">,</span> <span class="nx">maxDepth</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">valueToHtml</span><span class="p">(</span><span class="nx">isString</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">?</span> <span class="nx">v</span> <span class="o">:</span> <span class="nx">stringify$1</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">maxDepth</span><span class="p">));</span> <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">_a</span> <span class="o">=</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">_a</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">rest</span> <span class="o">=</span> <span class="nx">__rest</span><span class="p">(</span><span class="nx">_a</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">content</span> <span class="o">+=</span> <span class="s2">&quot;&lt;h2&gt;&quot;</span> <span class="o">+</span> <span class="nx">valueToHtml</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/h2&gt;&quot;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">rest</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">content</span> <span class="o">+=</span> <span class="s1">&#39;&lt;table&gt;&#39;</span><span class="p">;</span>
              <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">keys_1</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">keys_1</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">key$$1</span> <span class="o">=</span> <span class="nx">keys_1</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
                  <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">rest</span><span class="p">[</span><span class="nx">key$$1</span><span class="p">];</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span> <span class="p">{</span>
                      <span class="nx">val</span> <span class="o">=</span> <span class="nx">stringify$1</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">maxDepth</span><span class="p">);</span>
                  <span class="p">}</span>
                  <span class="nx">content</span> <span class="o">+=</span> <span class="s2">&quot;&lt;tr&gt;&lt;td class=\&quot;key\&quot;&gt;&quot;</span> <span class="o">+</span> <span class="nx">valueToHtml</span><span class="p">(</span><span class="nx">key$$1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&lt;/td&gt;&lt;td class=\&quot;value\&quot;&gt;&quot;</span> <span class="o">+</span> <span class="nx">valueToHtml</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/td&gt;&lt;/tr&gt;&quot;</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="nx">content</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/table&gt;&quot;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">content</span> <span class="o">||</span> <span class="s1">&#39;{}&#39;</span><span class="p">;</span> <span class="c1">// show empty object if there are no properties</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">valueToHtml</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">replacer</span><span class="p">(</span><span class="nx">maxDepth</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">stack</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key$$1</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">maxDepth</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="s1">&#39;[Object]&#39;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="s1">&#39;[Circular]&#39;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">};</span>
  <span class="p">}</span>
  <span class="cm">/**</span>
<span class="cm">   * Stringify any JS object to valid JSON</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">stringify$1</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">maxDepth</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">replacer</span><span class="p">(</span><span class="nx">maxDepth</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Position the tooltip</span>
<span class="cm">   *</span>
<span class="cm">   * @param event The mouse event.</span>
<span class="cm">   * @param tooltipBox</span>
<span class="cm">   * @param offsetX Horizontal offset.</span>
<span class="cm">   * @param offsetY Vertical offset.</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">calculatePosition</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">tooltipBox</span><span class="p">,</span> <span class="nx">offsetX</span><span class="p">,</span> <span class="nx">offsetY</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">+</span> <span class="nx">offsetX</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">tooltipBox</span><span class="p">.</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">x</span> <span class="o">=</span> <span class="o">+</span><span class="nx">event</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">-</span> <span class="nx">offsetX</span> <span class="o">-</span> <span class="nx">tooltipBox</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">+</span> <span class="nx">offsetY</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">tooltipBox</span><span class="p">.</span><span class="nx">height</span> <span class="o">&gt;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">y</span> <span class="o">=</span> <span class="o">+</span><span class="nx">event</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">-</span> <span class="nx">offsetY</span> <span class="o">-</span> <span class="nx">tooltipBox</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span> <span class="p">};</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * The tooltip handler class.</span>
<span class="cm">   */</span>
  <span class="kd">var</span> <span class="nx">Handler</span> <span class="o">=</span> <span class="cm">/** @class */</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="cm">/**</span>
<span class="cm">       * Create the tooltip handler and initialize the element and style.</span>
<span class="cm">       *</span>
<span class="cm">       * @param options Tooltip Options</span>
<span class="cm">       */</span>
      <span class="kd">function</span> <span class="nx">Handler</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">__assign</span><span class="p">({},</span> <span class="nx">DEFAULT_OPTIONS</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">elementId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
          <span class="c1">// bind this to call</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">call</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tooltip_handler</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
          <span class="c1">// prepend a default stylesheet for tooltips to the head</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">disableDefaultStyle</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">styleId</span><span class="p">))</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">);</span>
              <span class="nx">style</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">styleId</span><span class="p">);</span>
              <span class="nx">style</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">createDefaultStyle</span><span class="p">(</span><span class="nx">elementId</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">style</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="p">{</span>
                  <span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">style</span><span class="p">);</span>
              <span class="p">}</span>
          <span class="p">}</span>
          <span class="c1">// append a div element that we use as a tooltip unless it already exists</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">elementId</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">elementId</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;vg-tooltip&#39;</span><span class="p">);</span>
              <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">}</span>
      <span class="cm">/**</span>
<span class="cm">       * The tooltip handler function.</span>
<span class="cm">       */</span>
      <span class="nx">Handler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">tooltip_handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// console.log(handler, event, item, value);</span>
          <span class="c1">// hide tooltip for null, undefined, or empty string values</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;visible&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">theme</span> <span class="o">+</span> <span class="s2">&quot;-theme&quot;</span><span class="p">);</span>
              <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="c1">// set the tooltip content</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">formatValue</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">escapeHTML</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">maxDepth</span><span class="p">);</span>
          <span class="c1">// make the tooltip visible</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;visible&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">theme</span> <span class="o">+</span> <span class="s2">&quot;-theme&quot;</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">_a</span> <span class="o">=</span> <span class="nx">calculatePosition</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">offsetY</span><span class="p">),</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">_a</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">_a</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s2">&quot;top: &quot;</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">+</span> <span class="s2">&quot;px; left: &quot;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">);</span>
      <span class="p">};</span>
      <span class="k">return</span> <span class="nx">Handler</span><span class="p">;</span>
  <span class="p">}());</span>

  <span class="cm">/**</span>
<span class="cm">   * Open editor url in a new window, and pass a message.</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">post</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">editor</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">wait</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="o">~~</span><span class="p">(</span><span class="nx">wait</span> <span class="o">/</span> <span class="nx">step</span><span class="p">);</span>
      <span class="kd">function</span> <span class="nx">listen</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">source</span> <span class="o">===</span> <span class="nx">editor</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
              <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">listen</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">}</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">listen</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="c1">// send message</span>
      <span class="c1">// periodically resend until ack received or timeout</span>
      <span class="kd">function</span> <span class="nx">send</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">editor</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">);</span>
          <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">send</span><span class="p">,</span> <span class="nx">step</span><span class="p">);</span>
          <span class="nx">count</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">send</span><span class="p">,</span> <span class="nx">step</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// generated with build-style.sh</span>
  <span class="kd">var</span> <span class="nx">embedStyle</span> <span class="o">=</span> <span class="s2">&quot;.vega-embed {\n  position: relative;\n  display: inline-block;\n  padding-right: 38px;\n}\n\n.vega-embed .vega-actions-wrapper {\n  display: inline-flex;\n  position: absolute;\n  top: 0;\n  right: 0;\n  padding: 6px;\n  z-index: 1000;\n\n  opacity: 0.2;\n  background: white;\n  box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);\n  color: #1b1e23;\n  border: 1px solid #aaa;\n  border-radius: 999px;\n  transition: opacity 0.4s ease-in;\n}\n\n.vega-embed:hover .vega-actions-wrapper {\n  transition: opacity 0.2s ease;\n  opacity: 1;\n}\n\n.vega-embed .vega-actions {\n  position: absolute;\n  top: 0;\n  right: 0;\n  display: none;\n  flex-direction: column;\n\n  padding-bottom: 8px;\n  padding-top: 8px;\n  border-radius: 4px;\n  box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.2);\n  border: 1px solid #d9d9d9;\n  background: white;\n}\n\n.vega-embed .vega-actions-wrapper:hover {\n  background: transparent;\n  color: transparent;\n  border: none;\n  box-shadow: none;\n}\n\n.vega-embed .vega-actions-wrapper:hover .vega-actions {\n  display: flex;\n}\n\n.vega-embed .vega-actions a {\n  padding: 8px 16px;\n  font-family: sans-serif;\n  font-size: 14px;\n  font-weight: 600;\n  white-space: nowrap;\n  color: #434a56;\n  text-decoration: none;\n}\n\n.vega-embed .vega-actions a:hover {\n  background-color: #f7f7f9;\n  color: #1b1e23;\n}&quot;</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * From vega-lite</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">mergeDeep</span><span class="p">(</span><span class="nx">dest</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">src</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">src</span><span class="p">[</span><span class="nx">_i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">src_1</span> <span class="o">=</span> <span class="nx">src</span><span class="p">;</span> <span class="nx">_a</span> <span class="o">&lt;</span> <span class="nx">src_1</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_a</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">src_1</span><span class="p">[</span><span class="nx">_a</span><span class="p">];</span>
          <span class="nx">dest</span> <span class="o">=</span> <span class="nx">deepMerge_</span><span class="p">(</span><span class="nx">dest</span><span class="p">,</span> <span class="nx">s</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">dest</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">deepMerge_</span><span class="p">(</span><span class="nx">dest</span><span class="p">,</span> <span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">src</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span> <span class="nx">src</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">dest</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">src</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">p</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">])</span> <span class="o">||</span> <span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span> <span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mergeDeep</span><span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">].</span><span class="nx">constructor</span><span class="p">)</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="p">{},</span> <span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">]);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
              <span class="nx">mergeDeep</span><span class="p">(</span><span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">],</span> <span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">]);</span>
          <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">dest</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">isURL</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">s</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">s</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// https://github.com/rollup/rollup/issues/670</span>
  <span class="kd">var</span> <span class="nx">stringify$2</span> <span class="o">=</span> <span class="nx">jsonStringifyPrettyCompact</span> <span class="o">||</span> <span class="nx">stringify_</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">vega</span> <span class="o">=</span> <span class="nx">vegaImport</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">vl</span> <span class="o">=</span> <span class="nx">vlImport</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">NAMES</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">vega</span><span class="o">:</span> <span class="s1">&#39;Vega&#39;</span><span class="p">,</span>
      <span class="s1">&#39;vega-lite&#39;</span><span class="o">:</span> <span class="s1">&#39;Vega-Lite&#39;</span><span class="p">,</span>
  <span class="p">};</span>
  <span class="kd">var</span> <span class="nx">VERSION</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">vega</span><span class="o">:</span> <span class="nx">vega</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span>
      <span class="s1">&#39;vega-lite&#39;</span><span class="o">:</span> <span class="nx">vl</span> <span class="o">?</span> <span class="nx">vl</span><span class="p">.</span><span class="nx">version</span> <span class="o">:</span> <span class="s1">&#39;not available&#39;</span><span class="p">,</span>
  <span class="p">};</span>
  <span class="kd">var</span> <span class="nx">PREPROCESSOR</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">vega</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">vgjson</span><span class="p">,</span> <span class="nx">_</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">vgjson</span><span class="p">;</span> <span class="p">},</span>
      <span class="s1">&#39;vega-lite&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">vljson</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">vl</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">vljson</span><span class="p">,</span> <span class="p">{</span> <span class="nx">config</span><span class="o">:</span> <span class="nx">config</span> <span class="p">}).</span><span class="nx">spec</span><span class="p">;</span> <span class="p">},</span>
  <span class="p">};</span>
  <span class="kd">var</span> <span class="nx">SVG_CIRCLES</span> <span class="o">=</span> <span class="s2">&quot;\n&lt;svg viewBox=\&quot;0 0 16 16\&quot; fill=\&quot;currentColor\&quot; stroke=\&quot;none\&quot; stroke-width=\&quot;1\&quot; stroke-linecap=\&quot;round\&quot; stroke-linejoin=\&quot;round\&quot; width=\&quot;14\&quot; height=\&quot;14\&quot;&gt;\n  &lt;circle r=\&quot;2\&quot; cy=\&quot;8\&quot; cx=\&quot;2\&quot;&gt;&lt;/circle&gt;\n  &lt;circle r=\&quot;2\&quot; cy=\&quot;8\&quot; cx=\&quot;8\&quot;&gt;&lt;/circle&gt;\n  &lt;circle r=\&quot;2\&quot; cy=\&quot;8\&quot; cx=\&quot;14\&quot;&gt;&lt;/circle&gt;\n&lt;/svg&gt;&quot;</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">isTooltipHandler</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">typeof</span> <span class="nx">h</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">viewSource</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">sourceHeader</span><span class="p">,</span> <span class="nx">sourceFooter</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">header</span> <span class="o">=</span> <span class="s2">&quot;&lt;html&gt;&lt;head&gt;&quot;</span> <span class="o">+</span> <span class="nx">sourceHeader</span> <span class="o">+</span> <span class="s2">&quot;&lt;/head&gt;&lt;body&gt;&lt;pre&gt;&lt;code class=\&quot;json\&quot;&gt;&quot;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">footer</span> <span class="o">=</span> <span class="s2">&quot;&lt;/code&gt;&lt;/pre&gt;&quot;</span> <span class="o">+</span> <span class="nx">sourceFooter</span> <span class="o">+</span> <span class="s2">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">win</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="nx">win</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">header</span> <span class="o">+</span> <span class="nx">source</span> <span class="o">+</span> <span class="nx">footer</span><span class="p">);</span>
      <span class="nx">win</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">NAMES</span><span class="p">[</span><span class="nx">mode</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; JSON Source&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="cm">/**</span>
<span class="cm">   * Try to guess the type of spec.</span>
<span class="cm">   *</span>
<span class="cm">   * @param spec Vega or Vega-Lite spec.</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">guessMode</span><span class="p">(</span><span class="nx">spec</span><span class="p">,</span> <span class="nx">providedMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Decide mode</span>
      <span class="kd">var</span> <span class="nx">parsed</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">$schema</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">schemaParser</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">$schema</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">providedMode</span> <span class="o">&amp;&amp;</span> <span class="nx">providedMode</span> <span class="o">!==</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">library</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;The given visualization spec is written in &quot;</span> <span class="o">+</span> <span class="nx">NAMES</span><span class="p">[</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">library</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;, but mode argument sets &quot;</span> <span class="o">+</span> <span class="nx">NAMES</span><span class="p">[</span><span class="nx">providedMode</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="kd">var</span> <span class="nx">mode</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">library</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">semver_30</span><span class="p">(</span><span class="nx">VERSION</span><span class="p">[</span><span class="nx">mode</span><span class="p">],</span> <span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">version</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;The input spec uses &quot;</span> <span class="o">+</span> <span class="nx">mode</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s2">&quot;, but the current version of &quot;</span> <span class="o">+</span> <span class="nx">NAMES</span><span class="p">[</span><span class="nx">mode</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; is &quot;</span> <span class="o">+</span> <span class="nx">VERSION</span><span class="p">[</span><span class="nx">mode</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">mode</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// try to guess from the provided spec</span>
          <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mark&#39;</span> <span class="k">in</span> <span class="nx">spec</span> <span class="o">||</span>
              <span class="s1">&#39;encoding&#39;</span> <span class="k">in</span> <span class="nx">spec</span> <span class="o">||</span>
              <span class="s1">&#39;layer&#39;</span> <span class="k">in</span> <span class="nx">spec</span> <span class="o">||</span>
              <span class="s1">&#39;hconcat&#39;</span> <span class="k">in</span> <span class="nx">spec</span> <span class="o">||</span>
              <span class="s1">&#39;vconcat&#39;</span> <span class="k">in</span> <span class="nx">spec</span> <span class="o">||</span>
              <span class="s1">&#39;facet&#39;</span> <span class="k">in</span> <span class="nx">spec</span> <span class="o">||</span>
              <span class="s1">&#39;repeat&#39;</span> <span class="k">in</span> <span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="s1">&#39;vega-lite&#39;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;marks&#39;</span> <span class="k">in</span> <span class="nx">spec</span> <span class="o">||</span> <span class="s1">&#39;signals&#39;</span> <span class="k">in</span> <span class="nx">spec</span> <span class="o">||</span> <span class="s1">&#39;scales&#39;</span> <span class="k">in</span> <span class="nx">spec</span> <span class="o">||</span> <span class="s1">&#39;axes&#39;</span> <span class="k">in</span> <span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="s1">&#39;vega&#39;</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">providedMode</span> <span class="o">||</span> <span class="s1">&#39;vega&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="cm">/**</span>
<span class="cm">   * Embed a Vega visualization component in a web page. This function returns a promise.</span>
<span class="cm">   *</span>
<span class="cm">   * @param el        DOM element in which to place component (DOM node or CSS selector).</span>
<span class="cm">   * @param spec      String : A URL string from which to load the Vega specification.</span>
<span class="cm">   *                  Object : The Vega/Vega-Lite specification as a parsed JSON object.</span>
<span class="cm">   * @param opt       A JavaScript object containing options for embedding.</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">embed</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">spec</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span> <span class="o">===</span> <span class="k">void</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">opt</span> <span class="o">=</span> <span class="p">{};</span> <span class="p">}</span>
      <span class="k">return</span> <span class="nx">__awaiter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">void</span> <span class="mi">0</span><span class="p">,</span> <span class="k">void</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">actions</span><span class="p">,</span> <span class="nx">loader</span><span class="p">,</span> <span class="nx">renderer</span><span class="p">,</span> <span class="nx">logLevel</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">ID</span><span class="p">,</span> <span class="nx">style</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">vgSpec</span><span class="p">,</span> <span class="nx">parsed</span><span class="p">,</span> <span class="nx">div</span><span class="p">,</span> <span class="nx">runtime</span><span class="p">,</span> <span class="nx">view</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">wrapper</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">,</span> <span class="nx">_loop_1</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_a</span><span class="p">,</span> <span class="nx">ext</span><span class="p">,</span> <span class="nx">editorUrl_1</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">__generator</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_b</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">switch</span> <span class="p">(</span><span class="nx">_b</span><span class="p">.</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
                      <span class="nx">opt</span> <span class="o">=</span> <span class="nx">opt</span> <span class="o">||</span> <span class="p">{};</span>
                      <span class="nx">actions</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">actions</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">actions</span> <span class="o">===</span> <span class="kc">false</span>
                          <span class="o">?</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">actions</span>
                          <span class="o">:</span> <span class="nx">mergeDeep</span><span class="p">({},</span> <span class="p">{</span> <span class="kr">export</span><span class="o">:</span> <span class="p">{</span> <span class="nx">svg</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">png</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span> <span class="nx">source</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">compiled</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">editor</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">actions</span> <span class="o">||</span> <span class="p">{});</span>
                      <span class="nx">loader</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">loader</span> <span class="o">||</span> <span class="nx">vega</span><span class="p">.</span><span class="nx">loader</span><span class="p">();</span>
                      <span class="nx">renderer</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">renderer</span> <span class="o">||</span> <span class="s1">&#39;canvas&#39;</span><span class="p">;</span>
                      <span class="nx">logLevel</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">logLevel</span> <span class="o">||</span> <span class="nx">vega</span><span class="p">.</span><span class="nx">Warn</span><span class="p">;</span>
                      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">vega</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">spec</span><span class="p">))</span> <span class="k">return</span> <span class="p">[</span><span class="mi">3</span> <span class="cm">/*break*/</span><span class="p">,</span> <span class="mi">2</span><span class="p">];</span>
                      <span class="k">return</span> <span class="p">[</span><span class="mi">4</span> <span class="cm">/*yield*/</span><span class="p">,</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">spec</span><span class="p">)];</span>
                  <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
                      <span class="nx">data</span> <span class="o">=</span> <span class="nx">_b</span><span class="p">.</span><span class="nx">sent</span><span class="p">();</span>
                      <span class="k">return</span> <span class="p">[</span><span class="mi">2</span> <span class="cm">/*return*/</span><span class="p">,</span> <span class="nx">embed</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="nx">opt</span><span class="p">)];</span>
                  <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
                      <span class="nx">config</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">config</span> <span class="o">||</span> <span class="p">{};</span>
                      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">vega</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span> <span class="k">return</span> <span class="p">[</span><span class="mi">3</span> <span class="cm">/*break*/</span><span class="p">,</span> <span class="mi">4</span><span class="p">];</span>
                      <span class="k">return</span> <span class="p">[</span><span class="mi">4</span> <span class="cm">/*yield*/</span><span class="p">,</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">config</span><span class="p">)];</span>
                  <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
                      <span class="nx">data</span> <span class="o">=</span> <span class="nx">_b</span><span class="p">.</span><span class="nx">sent</span><span class="p">();</span>
                      <span class="k">return</span> <span class="p">[</span><span class="mi">2</span> <span class="cm">/*return*/</span><span class="p">,</span> <span class="nx">embed</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">spec</span><span class="p">,</span> <span class="nx">__assign</span><span class="p">({},</span> <span class="nx">opt</span><span class="p">,</span> <span class="p">{</span> <span class="nx">config</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">}))];</span>
                  <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">defaultStyle</span><span class="p">)</span> <span class="p">{</span>
                          <span class="nx">ID</span> <span class="o">=</span> <span class="s1">&#39;vega-embed-style&#39;</span><span class="p">;</span>
                          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">ID</span><span class="p">))</span> <span class="p">{</span>
                              <span class="nx">style</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">);</span>
                              <span class="nx">style</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">ID</span><span class="p">;</span>
                              <span class="nx">style</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">defaultStyle</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">?</span> <span class="p">(</span><span class="nx">embedStyle</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span> <span class="o">:</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">defaultStyle</span><span class="p">;</span>
                              <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">style</span><span class="p">);</span>
                          <span class="p">}</span>
                      <span class="p">}</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">theme</span><span class="p">)</span> <span class="p">{</span>
                          <span class="nx">config</span> <span class="o">=</span> <span class="nx">mergeDeep</span><span class="p">({},</span> <span class="nx">themes</span><span class="p">[</span><span class="nx">opt</span><span class="p">.</span><span class="nx">theme</span><span class="p">],</span> <span class="nx">config</span><span class="p">);</span>
                      <span class="p">}</span>
                      <span class="nx">mode</span> <span class="o">=</span> <span class="nx">guessMode</span><span class="p">(</span><span class="nx">spec</span><span class="p">,</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">mode</span><span class="p">);</span>
                      <span class="nx">vgSpec</span> <span class="o">=</span> <span class="nx">PREPROCESSOR</span><span class="p">[</span><span class="nx">mode</span><span class="p">](</span><span class="nx">spec</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="s1">&#39;vega-lite&#39;</span><span class="p">)</span> <span class="p">{</span>
                          <span class="k">if</span> <span class="p">(</span><span class="nx">vgSpec</span><span class="p">.</span><span class="nx">$schema</span><span class="p">)</span> <span class="p">{</span>
                              <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">schemaParser</span><span class="p">(</span><span class="nx">vgSpec</span><span class="p">.</span><span class="nx">$schema</span><span class="p">);</span>
                              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">semver_30</span><span class="p">(</span><span class="nx">VERSION</span><span class="p">.</span><span class="nx">vega</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">version</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
                                  <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;The compiled spec uses Vega &quot;</span> <span class="o">+</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s2">&quot;, but current version is &quot;</span> <span class="o">+</span> <span class="nx">VERSION</span><span class="p">.</span><span class="nx">vega</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">);</span>
                              <span class="p">}</span>
                          <span class="p">}</span>
                      <span class="p">}</span>
                      <span class="nx">div</span> <span class="o">=</span> <span class="nx">select</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="c1">// d3.select supports elements and strings</span>
                          <span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s1">&#39;vega-embed&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
                          <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">onBeforeParse</span><span class="p">)</span> <span class="p">{</span>
                          <span class="c1">// Allow Vega spec to be modified before being used</span>
                          <span class="nx">vgSpec</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">onBeforeParse</span><span class="p">(</span><span class="nx">vgSpec</span><span class="p">);</span>
                      <span class="p">}</span>
                      <span class="nx">runtime</span> <span class="o">=</span> <span class="nx">vega</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">vgSpec</span><span class="p">,</span> <span class="nx">mode</span> <span class="o">===</span> <span class="s1">&#39;vega-lite&#39;</span> <span class="o">?</span> <span class="p">{}</span> <span class="o">:</span> <span class="nx">config</span><span class="p">);</span>
                      <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">vega</span><span class="p">.</span><span class="nx">View</span><span class="p">(</span><span class="nx">runtime</span><span class="p">,</span> <span class="p">{</span>
                          <span class="nx">loader</span><span class="o">:</span> <span class="nx">loader</span><span class="p">,</span>
                          <span class="nx">logLevel</span><span class="o">:</span> <span class="nx">logLevel</span><span class="p">,</span>
                          <span class="nx">renderer</span><span class="o">:</span> <span class="nx">renderer</span><span class="p">,</span>
                      <span class="p">}).</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">tooltip</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                          <span class="nx">handler</span> <span class="o">=</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
                          <span class="k">if</span> <span class="p">(</span><span class="nx">isTooltipHandler</span><span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">tooltip</span><span class="p">))</span> <span class="p">{</span>
                              <span class="nx">handler</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">tooltip</span><span class="p">;</span>
                          <span class="p">}</span>
                          <span class="k">else</span> <span class="p">{</span>
                              <span class="c1">// user provided boolean true or tooltip options</span>
                              <span class="nx">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Handler</span><span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">tooltip</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">?</span> <span class="p">{}</span> <span class="o">:</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">tooltip</span><span class="p">).</span><span class="nx">call</span><span class="p">;</span>
                          <span class="p">}</span>
                          <span class="nx">view</span><span class="p">.</span><span class="nx">tooltip</span><span class="p">(</span><span class="nx">handler</span><span class="p">);</span>
                      <span class="p">}</span>
                      <span class="c1">// do not automatically enable hover for Vega-Lite.</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">hover</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="nx">mode</span> <span class="o">!==</span> <span class="s1">&#39;vega-lite&#39;</span> <span class="o">:</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">hover</span><span class="p">)</span> <span class="p">{</span>
                          <span class="nx">view</span><span class="p">.</span><span class="nx">hover</span><span class="p">();</span>
                      <span class="p">}</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
                          <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span> <span class="p">{</span>
                              <span class="nx">view</span><span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
                          <span class="p">}</span>
                          <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
                              <span class="nx">view</span><span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
                          <span class="p">}</span>
                          <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">padding</span><span class="p">)</span> <span class="p">{</span>
                              <span class="nx">view</span><span class="p">.</span><span class="nx">padding</span><span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">padding</span><span class="p">);</span>
                          <span class="p">}</span>
                      <span class="p">}</span>
                      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">opt</span><span class="p">.</span><span class="nx">runAsync</span><span class="p">)</span> <span class="k">return</span> <span class="p">[</span><span class="mi">3</span> <span class="cm">/*break*/</span><span class="p">,</span> <span class="mi">6</span><span class="p">];</span>
                      <span class="k">return</span> <span class="p">[</span><span class="mi">4</span> <span class="cm">/*yield*/</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">runAsync</span><span class="p">()];</span>
                  <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
                      <span class="nx">_b</span><span class="p">.</span><span class="nx">sent</span><span class="p">();</span>
                      <span class="k">return</span> <span class="p">[</span><span class="mi">3</span> <span class="cm">/*break*/</span><span class="p">,</span> <span class="mi">7</span><span class="p">];</span>
                  <span class="k">case</span> <span class="mi">6</span><span class="o">:</span>
                      <span class="nx">view</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
                      <span class="nx">_b</span><span class="p">.</span><span class="nx">label</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
                  <span class="k">case</span> <span class="mi">7</span><span class="o">:</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">actions</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                          <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">div</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;vega-actions-wrapper&#39;</span><span class="p">);</span>
                          <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">defaultStyle</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                              <span class="nx">wrapper</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">SVG_CIRCLES</span><span class="p">);</span>
                          <span class="p">}</span>
                          <span class="nx">ctrl</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;vega-actions&#39;</span><span class="p">);</span>
                          <span class="c1">// add &#39;Export&#39; action</span>
                          <span class="k">if</span> <span class="p">(</span><span class="nx">actions</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">actions</span><span class="p">.</span><span class="kr">export</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                              <span class="nx">_loop_1</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ext</span><span class="p">)</span> <span class="p">{</span>
                                  <span class="k">if</span> <span class="p">(</span><span class="nx">actions</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">actions</span><span class="p">.</span><span class="kr">export</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">actions</span><span class="p">.</span><span class="kr">export</span><span class="p">[</span><span class="nx">ext</span><span class="p">])</span> <span class="p">{</span>
                                      <span class="nx">ctrl</span>
                                          <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
                                          <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;Export as &quot;</span> <span class="o">+</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">())</span>
                                          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span>
                                          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;_blank&#39;</span><span class="p">)</span>
                                          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;download&#39;</span><span class="p">,</span> <span class="s2">&quot;visualization.&quot;</span> <span class="o">+</span> <span class="nx">ext</span><span class="p">)</span>
                                          <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                                          <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
                                          <span class="nx">view</span>
                                              <span class="p">.</span><span class="nx">toImageURL</span><span class="p">(</span><span class="nx">ext</span><span class="p">,</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">scaleFactor</span><span class="p">)</span>
                                              <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
                                              <span class="nx">_this</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
                                          <span class="p">})</span>
                                              <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                                              <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
                                          <span class="p">});</span>
                                          <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                                      <span class="p">});</span>
                                  <span class="p">}</span>
                              <span class="p">};</span>
                              <span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_a</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;svg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">];</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                  <span class="nx">ext</span> <span class="o">=</span> <span class="nx">_a</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
                                  <span class="nx">_loop_1</span><span class="p">(</span><span class="nx">ext</span><span class="p">);</span>
                              <span class="p">}</span>
                          <span class="p">}</span>
                          <span class="c1">// add &#39;View Source&#39; action</span>
                          <span class="k">if</span> <span class="p">(</span><span class="nx">actions</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">actions</span><span class="p">.</span><span class="nx">source</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                              <span class="nx">ctrl</span>
                                  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;View Source&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                                  <span class="nx">viewSource</span><span class="p">(</span><span class="nx">stringify$2</span><span class="p">(</span><span class="nx">spec</span><span class="p">),</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">sourceHeader</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">sourceFooter</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">mode</span><span class="p">);</span>
                                  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                              <span class="p">});</span>
                          <span class="p">}</span>
                          <span class="c1">// add &#39;View Compiled&#39; action</span>
                          <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="s1">&#39;vega-lite&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">actions</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">actions</span><span class="p">.</span><span class="nx">compiled</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">))</span> <span class="p">{</span>
                              <span class="nx">ctrl</span>
                                  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;View Vega&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                                  <span class="nx">viewSource</span><span class="p">(</span><span class="nx">stringify$2</span><span class="p">(</span><span class="nx">vgSpec</span><span class="p">),</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">sourceHeader</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">sourceFooter</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;vega&#39;</span><span class="p">);</span>
                                  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                              <span class="p">});</span>
                          <span class="p">}</span>
                          <span class="c1">// add &#39;Open in Vega Editor&#39; action</span>
                          <span class="k">if</span> <span class="p">(</span><span class="nx">actions</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">actions</span><span class="p">.</span><span class="nx">editor</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                              <span class="nx">editorUrl_1</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">editorUrl</span> <span class="o">||</span> <span class="s1">&#39;https://vega.github.io/editor/&#39;</span><span class="p">;</span>
                              <span class="nx">ctrl</span>
                                  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;Open in Vega Editor&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                                  <span class="nx">post</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="nx">editorUrl_1</span><span class="p">,</span> <span class="p">{</span>
                                      <span class="nx">config</span><span class="o">:</span> <span class="nx">config</span><span class="p">,</span>
                                      <span class="nx">mode</span><span class="o">:</span> <span class="nx">mode</span><span class="p">,</span>
                                      <span class="nx">renderer</span><span class="o">:</span> <span class="nx">renderer</span><span class="p">,</span>
                                      <span class="nx">spec</span><span class="o">:</span> <span class="nx">stringify$2</span><span class="p">(</span><span class="nx">spec</span><span class="p">),</span>
                                  <span class="p">});</span>
                                  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                              <span class="p">});</span>
                          <span class="p">}</span>
                      <span class="p">}</span>
                      <span class="k">return</span> <span class="p">[</span><span class="mi">2</span> <span class="cm">/*return*/</span><span class="p">,</span> <span class="p">{</span> <span class="nx">view</span><span class="o">:</span> <span class="nx">view</span><span class="p">,</span> <span class="nx">spec</span><span class="o">:</span> <span class="nx">spec</span> <span class="p">}];</span>
              <span class="p">}</span>
          <span class="p">});</span>
      <span class="p">});</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Create a promise to an HTML Div element with an embedded Vega-Lite or Vega visualization.</span>
<span class="cm">   * The element has a value property with the view. By default all actions except for the editor action are disabled.</span>
<span class="cm">   *</span>
<span class="cm">   * The main use case is in [Observable](https://observablehq.com/).</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">container</span><span class="p">(</span><span class="nx">spec</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span> <span class="o">===</span> <span class="k">void</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">opt</span> <span class="o">=</span> <span class="p">{};</span> <span class="p">}</span>
      <span class="k">return</span> <span class="nx">__awaiter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">void</span> <span class="mi">0</span><span class="p">,</span> <span class="k">void</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">div</span><span class="p">,</span> <span class="nx">actions</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">__generator</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_a</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
              <span class="nx">actions</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">actions</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">actions</span> <span class="o">===</span> <span class="kc">false</span>
                  <span class="o">?</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">actions</span>
                  <span class="o">:</span> <span class="nx">__assign</span><span class="p">({</span> <span class="kr">export</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">source</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">compiled</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">editor</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">actions</span> <span class="o">||</span> <span class="p">{}));</span>
              <span class="k">return</span> <span class="p">[</span><span class="mi">2</span> <span class="cm">/*return*/</span><span class="p">,</span> <span class="nx">embed</span><span class="p">(</span><span class="nx">div</span><span class="p">,</span> <span class="nx">spec</span><span class="p">,</span> <span class="nx">__assign</span><span class="p">({</span> <span class="nx">actions</span><span class="o">:</span> <span class="nx">actions</span><span class="p">,</span> <span class="nx">defaultStyle</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">runAsync</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span> <span class="p">(</span><span class="nx">opt</span> <span class="o">||</span> <span class="p">{}))).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                      <span class="nx">div</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">view</span><span class="p">;</span>
                      <span class="k">return</span> <span class="nx">div</span><span class="p">;</span>
                  <span class="p">})];</span>
          <span class="p">});</span>
      <span class="p">});</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Returns true of the object is an HTML element.</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">isElement</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">selection</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">HTMLElement</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span>
          <span class="o">?</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">HTMLElement</span> <span class="c1">// DOM2</span>
          <span class="o">:</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">args</span><span class="p">[</span><span class="nx">_i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">isString</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isURL</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">||</span> <span class="nx">isElement</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">embed</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">container</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">};</span>
  <span class="nx">wrapper</span><span class="p">.</span><span class="nx">vl</span> <span class="o">=</span> <span class="nx">vl</span><span class="p">;</span>
  <span class="nx">wrapper</span><span class="p">.</span><span class="nx">container</span> <span class="o">=</span> <span class="nx">container</span><span class="p">;</span>
  <span class="nx">wrapper</span><span class="p">.</span><span class="nx">embed</span> <span class="o">=</span> <span class="nx">embed</span><span class="p">;</span>
  <span class="nx">wrapper</span><span class="p">.</span><span class="nx">vega</span> <span class="o">=</span> <span class="nx">vega</span><span class="p">;</span>
  <span class="nx">wrapper</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="nx">embed</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">wrapper</span><span class="p">;</span>

<span class="p">})));</span>
<span class="c1">//# sourceMappingURL=vega-embed.js.map</span>
</pre></div>
</body>
</html>
