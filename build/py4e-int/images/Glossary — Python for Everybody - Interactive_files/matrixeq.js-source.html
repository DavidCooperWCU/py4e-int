<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title><title><no title></title></title>
  <meta http-equiv="content-type" content="text/html; charset=None">
  <link rel="stylesheet" href="..\..\_static\pygments.css" type="text/css">
</head>
<body>
<h2><title><no title></title></h2>

<div class="highlight"><pre><span></span><span class="c1">// matrixeq.js - By: Dr. Wayne Brown, Fall 2015, revised Fall 2017</span>
<span class="c1">// Description: functions to manipulate matrices on a web page</span>

<span class="cm">/**</span>
<span class="cm"> * The MIT License (MIT)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2015 C. Wayne Brown</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm"> * of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm"> * in the Software without restriction, including without limitation the rights</span>
<span class="cm"> * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm"> * copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm"> * furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in all</span>
<span class="cm"> * copies or substantial portions of the Software.</span>

<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm"> * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm"> * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="c1">// Require all variables to be defined before they are used.</span>
<span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

<span class="c1">//=========================================================================</span>
<span class="c1">// Manipulate the matrixeq_container elements from a matrixeq directive:</span>
<span class="c1">//  - performs matrix operations: multiply and assignment</span>
<span class="c1">//  - removes generated matrixeq_container elements when the &quot;X&quot; button is selected</span>
<span class="c1">//  - simplifies matrix_table elements when the &quot;-&quot; button is selected</span>
<span class="c1">//=========================================================================</span>

<span class="kd">function</span> <span class="nx">Matrixeq_directive</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_getMatrix</span><span class="p">(</span><span class="nx">theSpan</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">columns</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">rows</span><span class="p">,</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">number_rows</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">matrix</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">value_text</span><span class="p">,</span> <span class="nx">input_box</span><span class="p">;</span>

    <span class="c1">// The matrix is organized by columns</span>
    <span class="nx">columns</span> <span class="o">=</span> <span class="nx">theSpan</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>

    <span class="nx">number_rows</span> <span class="o">=</span> <span class="nx">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="c1">// Create an empty matrix that has the correct number of rows</span>
    <span class="nx">matrix</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">r</span> <span class="o">&lt;</span> <span class="nx">number_rows</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">row</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">matrix</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">columns</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">c</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rows</span> <span class="o">=</span> <span class="nx">columns</span><span class="p">[</span><span class="nx">c</span><span class="p">].</span><span class="nx">children</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">r</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span> <span class="o">=</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">r</span><span class="p">];</span>
        <span class="nx">text</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;&lt;input&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">input_box</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
          <span class="nx">value_text</span> <span class="o">=</span> <span class="nx">input_box</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
          <span class="nx">value_text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Reduce numbers to their least digit format</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">value_text</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">value_text</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">value_text</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">// If there is a HTML &lt;sup&gt;, replace with a unique marker (qqqq)</span>
        <span class="nx">value_text</span> <span class="o">=</span> <span class="nx">value_text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;sup&gt;(.*?)&lt;\/sup&gt;/g</span><span class="p">,</span> <span class="s2">&quot;qqqq&quot;</span><span class="p">);</span>

        <span class="nx">matrix</span><span class="p">[</span><span class="nx">r</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">value_text</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">matrix</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/** ---------------------------------------------------------------------</span>
<span class="cm">   * If an expression starts and ends with ()&#39;s, remove the parentheses.</span>
<span class="cm">   * @param ex {string} the expression to evaluate</span>
<span class="cm">   * @returns {string} the original string with unnneeded ()&#39;s removed.</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_removeParentheses</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ex</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">_findMatching</span><span class="p">(</span><span class="nx">ex</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ex</span> <span class="o">=</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">ex</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ex</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_findMatching</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">start_ch</span><span class="p">,</span> <span class="nx">end_ch</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">nested</span><span class="p">,</span> <span class="nx">j</span><span class="p">;</span>

    <span class="nx">end</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="nx">j</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">nested</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">j</span><span class="p">)</span> <span class="o">===</span> <span class="nx">start_ch</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">nested</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">j</span><span class="p">)</span> <span class="o">===</span> <span class="nx">end_ch</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nested</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">end</span> <span class="o">=</span> <span class="nx">j</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">nested</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">end</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">v</span> <span class="o">=</span> <span class="nx">_removeParentheses</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">trim</span><span class="p">());</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">v</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">v</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">v</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">v</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">v</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_matrixMultiply</span><span class="p">(</span><span class="nx">m1</span><span class="p">,</span> <span class="nx">m2</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">r1</span><span class="p">,</span> <span class="nx">c1</span><span class="p">,</span> <span class="nx">c2</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">value_text</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">v1</span><span class="p">,</span> <span class="nx">v2</span><span class="p">,</span> <span class="nx">row</span><span class="p">;</span>

    <span class="nx">r1</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">c1</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">c2</span> <span class="o">=</span> <span class="nx">m2</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>

    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">r</span> <span class="o">&lt;</span> <span class="nx">r1</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">row</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">c2</span><span class="p">;</span> <span class="nx">c</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">value_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">c1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">v1</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">[</span><span class="nx">r</span><span class="p">][</span><span class="nx">j</span><span class="p">];</span>
          <span class="nx">v2</span> <span class="o">=</span> <span class="nx">m2</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="nx">c</span><span class="p">];</span>
          <span class="nx">value_text</span> <span class="o">+=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">v1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">v2</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">c1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">value_text</span> <span class="o">+=</span> <span class="s2">&quot; + &quot;</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value_text</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_buildHTMLmatrix</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">id1</span><span class="p">,</span> <span class="nx">id2</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">str</span><span class="p">,</span> <span class="nx">nRows</span><span class="p">,</span> <span class="nx">nCols</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">randomInt</span><span class="p">;</span>

    <span class="c1">// Build the HTML for the matrix</span>
    <span class="nx">randomInt</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">);</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="s2">&quot;M&quot;</span> <span class="o">+</span> <span class="nx">randomInt</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>

    <span class="nx">str</span> <span class="o">=</span> <span class="s1">&#39;&lt;span id=&quot;&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;&quot; class=&quot;matrix_table&quot;&gt; &lt;!-- &#39;</span> <span class="o">+</span> <span class="nx">id1</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="nx">id2</span> <span class="o">+</span> <span class="s1">&#39; --&gt;&#39;</span><span class="p">;</span>

    <span class="nx">nRows</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">nCols</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>

    <span class="c1">// Create the HTML code for the matrix</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">nCols</span><span class="p">;</span> <span class="nx">c</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">str</span> <span class="o">+=</span> <span class="s1">&#39;&lt;span class=&quot;matrix_column&quot;&gt;&#39;</span><span class="p">;</span> <span class="c1">// start column</span>

      <span class="k">for</span> <span class="p">(</span><span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">r</span> <span class="o">&lt;</span> <span class="nx">nRows</span><span class="p">;</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">str</span> <span class="o">+=</span> <span class="s1">&#39;&lt;span onmouseover=&quot;Matrixeq_show(this, true);&quot; onmouseleave=&quot;Matrixeq_show(this, false);&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">m</span><span class="p">[</span><span class="nx">r</span><span class="p">][</span><span class="nx">c</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;br /&gt;&lt;/span&gt;&#39;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">str</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="p">;</span> <span class="c1">// ends &quot;matrix_column&quot;</span>
    <span class="p">}</span>
    <span class="nx">str</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="p">;</span> <span class="c1">// ends &quot;matrix_table&quot;</span>

    <span class="c1">// Replace all &#39;qqqq&#39; text values with a superscript HTML tag</span>
    <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replaceAll</span><span class="p">(</span><span class="s1">&#39;qqqq&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;sup&gt;-1&lt;/sup&gt;&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_multiplyMatrix</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">equation</span><span class="p">,</span> <span class="nx">m1</span><span class="p">,</span> <span class="nx">m2</span><span class="p">,</span> <span class="nx">M1</span><span class="p">,</span> <span class="nx">M2</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">result_element</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">num_children</span><span class="p">,</span> <span class="nx">new_equation</span><span class="p">,</span> <span class="nx">next_element</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">matches</span><span class="p">,</span> <span class="nx">background_color</span><span class="p">,</span> <span class="nx">text_color</span><span class="p">;</span>

    <span class="nx">equation</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="nx">m1</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">previousSibling</span><span class="p">;</span>
    <span class="nx">m2</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>

    <span class="nx">M1</span> <span class="o">=</span> <span class="nx">_getMatrix</span><span class="p">(</span><span class="nx">m1</span><span class="p">);</span>
    <span class="nx">M2</span> <span class="o">=</span> <span class="nx">_getMatrix</span><span class="p">(</span><span class="nx">m2</span><span class="p">);</span>

    <span class="nx">result</span> <span class="o">=</span> <span class="nx">_matrixMultiply</span><span class="p">(</span><span class="nx">M1</span><span class="p">,</span> <span class="nx">M2</span><span class="p">);</span>

    <span class="nx">background_color</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">m1</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;background-color&#39;</span><span class="p">);</span>
    <span class="nx">text_color</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">m1</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">);</span>

    <span class="nx">result_element</span> <span class="o">=</span> <span class="nx">_buildHTMLmatrix</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nx">m1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="nx">$</span><span class="p">(</span><span class="nx">m2</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span>

    <span class="c1">// Combine the original equation, replacing the two matrices with the result</span>
    <span class="nx">new_equation</span> <span class="o">=</span> <span class="s2">&quot;&lt;!-- matrixeq start --&gt;\n&quot;</span><span class="p">;</span>
    <span class="nx">new_equation</span> <span class="o">+=</span> <span class="s2">&quot;&lt;div class=&#39;matrixeq_container&#39; style=&#39;background-color: &quot;</span>
                 <span class="o">+</span> <span class="nx">background_color</span> <span class="o">+</span> <span class="s2">&quot;; color: &quot;</span> <span class="o">+</span> <span class="nx">text_color</span> <span class="o">+</span> <span class="s2">&quot;;&#39;&gt;\n&quot;</span><span class="p">;</span>

    <span class="nx">children</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">equation</span><span class="p">).</span><span class="nx">children</span><span class="p">();</span>
    <span class="nx">num_children</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>
    <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">num_children</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">num_children</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="o">&amp;&amp;</span> <span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">==</span> <span class="nx">m1</span> <span class="o">&amp;&amp;</span> <span class="nx">children</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="nx">m2</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">new_equation</span> <span class="o">+=</span> <span class="nx">result_element</span><span class="p">;</span>
          <span class="nx">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">next_element</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">outerHTML</span><span class="p">;</span>
        <span class="nx">matches</span> <span class="o">=</span> <span class="nx">next_element</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/id=&quot;(.*?)&quot;/</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">matches</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">next_element</span> <span class="o">=</span> <span class="nx">next_element</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">j</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="nx">new_equation</span> <span class="o">+=</span> <span class="nx">next_element</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">next_element</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;matrix_label&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Don&#39;t copy the buttons into this matrix equation</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Add 2 buttons to the end</span>
    <span class="nx">new_equation</span> <span class="o">+=</span> <span class="s2">&quot;&lt;span class=&#39;matrix_column&#39;&gt;&quot;</span><span class="p">;</span>
    <span class="nx">new_equation</span> <span class="o">+=</span> <span class="s2">&quot;&lt;button onclick=&#39;Matrixeq_directive(this, \&quot;reduce\&quot;);&#39;&gt;-&lt;/button&gt;&amp;nbsp&quot;</span><span class="p">;</span>
    <span class="nx">new_equation</span> <span class="o">+=</span> <span class="s2">&quot;&lt;button onclick=&#39;Matrixeq_directive(this, \&quot;delete\&quot;);&#39;&gt;X&lt;/button&gt;&quot;</span><span class="p">;</span>
    <span class="nx">new_equation</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/span&gt;&quot;</span><span class="p">;</span>

    <span class="nx">new_equation</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/div&gt;\n&quot;</span><span class="p">;</span>
    <span class="nx">new_equation</span> <span class="o">+=</span> <span class="s2">&quot;&lt;!-- matrixeq end --&gt;\n&quot;</span><span class="p">;</span>

    <span class="nx">$</span><span class="p">(</span><span class="nx">new_equation</span><span class="p">).</span><span class="nx">insertAfter</span><span class="p">(</span><span class="nx">equation</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_reduce</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">buttons_parent</span><span class="p">,</span> <span class="nx">equation</span><span class="p">,</span> <span class="nx">new_equation</span><span class="p">,</span> <span class="nx">button_children</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">num_children</span><span class="p">,</span> <span class="nx">next_element</span><span class="p">;</span>

    <span class="c1">// element is the &quot;reduce button&quot; which was clicked on.</span>

    <span class="c1">// Get the node that contains the entire equation.</span>
    <span class="nx">buttons_parent</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="nx">equation</span> <span class="o">=</span> <span class="nx">buttons_parent</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>

    <span class="nx">new_equation</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">equation</span><span class="p">).</span><span class="nx">clone</span><span class="p">();</span>

    <span class="nx">children</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">new_equation</span><span class="p">).</span><span class="nx">children</span><span class="p">();</span>
    <span class="nx">num_children</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>
    <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">num_children</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">next_element</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">next_element</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;matrix_table&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_reduceMatrixTerms</span><span class="p">(</span><span class="nx">next_element</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="c1">// Remove the &quot;reduce button&quot; from the new equation</span>
    <span class="nx">button_children</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">num_children</span><span class="o">-</span><span class="mi">1</span><span class="p">]).</span><span class="nx">children</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">button_children</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">remove</span><span class="p">();</span>

    <span class="nx">$</span><span class="p">(</span><span class="nx">new_equation</span><span class="p">).</span><span class="nx">insertAfter</span><span class="p">(</span><span class="nx">equation</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="c1">// Calculate the entire left and right side of the equation.</span>
  <span class="kd">function</span> <span class="nx">_assignment</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">equation</span><span class="p">,</span> <span class="nx">new_equation</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">num_children</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">op</span><span class="p">,</span> <span class="nx">op_type</span><span class="p">,</span> <span class="nx">m1</span><span class="p">,</span> <span class="nx">m2</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">result_element</span><span class="p">,</span> <span class="nx">matrix_element</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">last_child</span><span class="p">,</span> <span class="nx">delete_button</span><span class="p">;</span>

    <span class="nx">equation</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>

    <span class="c1">// Create a new equation to perform the calculations on.</span>
    <span class="nx">new_equation</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">equation</span><span class="p">).</span><span class="nx">clone</span><span class="p">();</span>
    <span class="nx">children</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">new_equation</span><span class="p">).</span><span class="nx">children</span><span class="p">();</span>
    <span class="nx">num_children</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>

    <span class="c1">// Make sure we have at least two matrices and one operator</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">num_children</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">num_children</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">op</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">op</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;matrix_operator&#39;</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">op_type</span> <span class="o">=</span> <span class="nx">op</span><span class="p">.</span><span class="nx">innerText</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">op_type</span> <span class="o">===</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;matrix_table&#39;</span> <span class="o">&amp;&amp;</span>
              <span class="nx">$</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;matrix_table&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">m1</span> <span class="o">=</span> <span class="nx">_getMatrix</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
            <span class="nx">m2</span> <span class="o">=</span> <span class="nx">_getMatrix</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">_matrixMultiply</span><span class="p">(</span><span class="nx">m1</span><span class="p">,</span> <span class="nx">m2</span><span class="p">);</span>
            <span class="nx">result_element</span> <span class="o">=</span> <span class="nx">_buildHTMLmatrix</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">);</span>
            <span class="nx">matrix_element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseHTML</span><span class="p">(</span><span class="nx">result_element</span><span class="p">);</span>
            <span class="nx">_reduceMatrixTerms</span><span class="p">(</span><span class="nx">matrix_element</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

            <span class="nx">$</span><span class="p">(</span><span class="nx">matrix_element</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">insertAfter</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>

            <span class="nx">$</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]).</span><span class="nx">remove</span><span class="p">();</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">]).</span><span class="nx">remove</span><span class="p">();</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]).</span><span class="nx">remove</span><span class="p">();</span>

            <span class="nx">j</span> <span class="o">=</span> <span class="nx">j</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="nx">children</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">new_equation</span><span class="p">).</span><span class="nx">children</span><span class="p">();</span>
            <span class="nx">num_children</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">j</span> <span class="o">=</span> <span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="nx">last_child</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">num_children</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">last_child</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;matrix_column&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Add delete button to the end</span>
      <span class="nx">delete_button</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseHTML</span><span class="p">(</span><span class="s2">&quot;&lt;span class=&#39;matrix_column&#39;&gt;&quot;</span> <span class="o">+</span>
                                  <span class="s2">&quot;&lt;button onclick=&#39;Matrixeq_directive(this, \&quot;delete\&quot;);&#39;&gt;X&lt;/button&gt;&quot;</span> <span class="o">+</span>
                                  <span class="s2">&quot;&lt;/span&gt;&quot;</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">delete_button</span><span class="p">).</span><span class="nx">insertAfter</span><span class="p">(</span><span class="nx">last_child</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">$</span><span class="p">(</span><span class="nx">new_equation</span><span class="p">).</span><span class="nx">insertAfter</span><span class="p">(</span><span class="nx">equation</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">operators</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;^&#39;</span><span class="p">];</span>
  <span class="kd">let</span> <span class="nx">precedence</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span> <span class="p">];</span>

  <span class="cm">/** ---------------------------------------------------------------------</span>
<span class="cm">   * Given an array of tokens from an expression, find the minus signs that</span>
<span class="cm">   * were parsed as operators and reattach them to the number or symbol they</span>
<span class="cm">   * should be related to.</span>
<span class="cm">   * @param tokens {Array} an array of tokens parsed from an arithmetic expression</span>
<span class="cm">   * @return new_tokens {Array} an array of tokens parsed from an arithmetic expression</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_fixMinusSigns</span><span class="p">(</span><span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">new_tokens</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span>
            <span class="nx">tokens</span><span class="p">[</span><span class="nx">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;(&#39;</span> <span class="o">||</span>
            <span class="nx">operators</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Treat this minus sign as a unary operator</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">new_tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;-1&quot;</span><span class="p">);</span>
            <span class="nx">new_tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">);</span>
            <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">new_tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_negative</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]));</span>
            <span class="nx">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// The negative sign is an operator</span>
          <span class="nx">new_tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
          <span class="nx">j</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Not a minus sign</span>
        <span class="nx">new_tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
        <span class="nx">j</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">new_tokens</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/** ---------------------------------------------------------------------</span>
<span class="cm">   * Convert an arithmetic expression in infix format to a postfix format.</span>
<span class="cm">   * Modified from: https://github.com/miguelmota/infix-to-postfix/blob/master/infix-to-postfix.js</span>
<span class="cm">   * @param ex {string} a string that contains the expression.</span>
<span class="cm">   * @returns {Array} the arithmetic expression as an array of operands and operators</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_infixToPostfix</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">let</span> <span class="nx">stack</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">let</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">op_index</span><span class="p">,</span> <span class="nx">op_precedence</span><span class="p">,</span> <span class="nx">stack_op</span><span class="p">,</span> <span class="nx">stack_precedence</span><span class="p">,</span> <span class="nx">index</span><span class="p">;</span>
    <span class="c1">// parsing tokens         operator--     function(call)----   number-----------------   variable--------------------</span>
    <span class="kd">let</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/(?:[()+\-*/^])|(?:[A-Za-z]+\(-?\w*\))|(-?(?:\d+\.?\d*|-?\.\d*))|(-?([A-Za-z][A-Za-z0-9_\/\&#39;]*))/gi</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">containsInvalidChars</span> <span class="o">=</span> <span class="sr">/[^()+\-*/^0-9.A-Za-z_\&#39;\s]/gi</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">containsInvalidChars</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Expression contains invalid characters: &quot;</span><span class="p">,</span> <span class="nx">ex</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">ex</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">tokens</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// Fix the unary minus signs; all negative signs were initially parsed as operators</span>
      <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">_fixMinusSigns</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span>

        <span class="nx">op_index</span> <span class="o">=</span> <span class="nx">operators</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">op_index</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">op_precedence</span> <span class="o">=</span> <span class="nx">precedence</span><span class="p">[</span><span class="nx">op_index</span><span class="p">];</span>
          <span class="k">while</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">stack_op</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
            <span class="nx">index</span> <span class="o">=</span> <span class="nx">operators</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">stack_op</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// found a ( or )</span>

            <span class="nx">stack_precedence</span> <span class="o">=</span> <span class="nx">precedence</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">op_precedence</span> <span class="o">&gt;</span> <span class="nx">stack_precedence</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

            <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
          <span class="p">}</span>
          <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">operator</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
          <span class="k">while</span> <span class="p">(</span><span class="nx">operator</span> <span class="o">!==</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">operator</span><span class="p">);</span>
            <span class="nx">operator</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
          <span class="p">}</span>

        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/** ---------------------------------------------------------------------</span>
<span class="cm">   * @param str {string} the string to test</span>
<span class="cm">   * @returns {boolean} TRUE if the string can be converted to a number</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">str</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="cm">/** ---------------------------------------------------------------------</span>
<span class="cm">   * @param str {string} the string to convert</span>
<span class="cm">   * @returns {string} a string where the value is made negative</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_negative</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_isNumber</span><span class="p">(</span><span class="nx">str</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">str</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">trim</span><span class="p">());</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">str</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/** ---------------------------------------------------------------------</span>
<span class="cm">   * Given a number, convert it to a string.</span>
<span class="cm">   * @param num {number}</span>
<span class="cm">   * @returns {string}</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_toNumberString</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">num</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;0&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">num</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/** ---------------------------------------------------------------------</span>
<span class="cm">   * Add two values together, either symbolically or numerically.</span>
<span class="cm">   * @param a {string} first operand</span>
<span class="cm">   * @param b {string} second operand</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; + &quot;</span> <span class="o">+</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>  <span class="c1">// default answer</span>
    <span class="kd">let</span> <span class="nx">a_is_numeric</span> <span class="o">=</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">b_is_numeric</span> <span class="o">=</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">a_is_numeric</span> <span class="o">&amp;&amp;</span> <span class="nx">b_is_numeric</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">_toNumberString</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a_is_numeric</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b_is_numeric</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/** ---------------------------------------------------------------------</span>
<span class="cm">   * Subtract two values together, either symbolically or numerically.</span>
<span class="cm">   * @param a {string} first operand</span>
<span class="cm">   * @param b {string} second operand</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_subtract</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>  <span class="c1">// default answer</span>
    <span class="kd">let</span> <span class="nx">a_is_numeric</span> <span class="o">=</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">b_is_numeric</span> <span class="o">=</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">a_is_numeric</span> <span class="o">&amp;&amp;</span> <span class="nx">b_is_numeric</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">_toNumberString</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a_is_numeric</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">_negative</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b_is_numeric</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/** ---------------------------------------------------------------------</span>
<span class="cm">   * Multiply two values together, either symbolically or numerically.</span>
<span class="cm">   * @param a {string} first operand</span>
<span class="cm">   * @param b {string} second operand</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_multiply</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>  <span class="c1">// default answer</span>
    <span class="kd">let</span> <span class="nx">a_is_numeric</span> <span class="o">=</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">b_is_numeric</span> <span class="o">=</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">a_is_numeric</span> <span class="o">&amp;&amp;</span> <span class="nx">b_is_numeric</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">_toNumberString</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a_is_numeric</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;-1&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">_negative</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b_is_numeric</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;-1&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">_negative</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/** ---------------------------------------------------------------------</span>
<span class="cm">   * Divide two values, either symbolically or numerically.</span>
<span class="cm">   * @param a {string} first operand</span>
<span class="cm">   * @param b {string} second operand</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_divide</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>  <span class="c1">// default answer</span>
    <span class="kd">let</span> <span class="nx">a_is_numeric</span> <span class="o">=</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">b_is_numeric</span> <span class="o">=</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">a_is_numeric</span> <span class="o">&amp;&amp;</span> <span class="nx">b_is_numeric</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">_toNumberString</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a_is_numeric</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">){</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b_is_numeric</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;infinity&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;-1&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">_negative</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/** ---------------------------------------------------------------------</span>
<span class="cm">   * Raise a number to a power, either symbolically or numerically.</span>
<span class="cm">   * @param a {string} first operand</span>
<span class="cm">   * @param b {string} second operand</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_power</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>  <span class="c1">// default answer</span>
    <span class="kd">let</span> <span class="nx">a_is_numeric</span> <span class="o">=</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">b_is_numeric</span> <span class="o">=</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">a_is_numeric</span> <span class="o">&amp;&amp;</span> <span class="nx">b_is_numeric</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">b</span><span class="p">));</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">_toNumberString</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a_is_numeric</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b_is_numeric</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/** ---------------------------------------------------------------------</span>
<span class="cm">   * Evaluate an arithmetic expression that is in postfix format.</span>
<span class="cm">   * @param postfix {Array} an arithmetic expression in postfix format.</span>
<span class="cm">   * @returns {string}</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_evalPostfix</span><span class="p">(</span><span class="nx">postfix</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">let</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">operator</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">postfix</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">operators</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">postfix</span><span class="p">[</span><span class="nx">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">operator</span> <span class="o">=</span> <span class="nx">postfix</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
        <span class="c1">// try to perform the operation</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_isNumber</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">switch</span> <span class="p">(</span><span class="nx">operator</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s2">&quot;+&quot;</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>     <span class="nx">_add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;-&#39;</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_subtract</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_multiply</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;/&#39;</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>  <span class="nx">_divide</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;^&#39;</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>   <span class="nx">_power</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">a</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="nx">operator</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// One or both of the operands are symbolic</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;+&#39;</span> <span class="o">||</span> <span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">operator</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">operator</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">+</span> <span class="nx">operator</span> <span class="o">+</span> <span class="nx">_createTerm</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// the value is an operand, so push it on the stack</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">postfix</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;error in &#39;&quot;</span> <span class="o">+</span> <span class="nx">postfix</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_removeParentheses</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_reduceTerm</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// The &quot;t&quot; might contain HTML code like &lt;sup&gt;. Replace with a unique place holder.</span>
    <span class="kd">let</span> <span class="nx">t_new</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;sup&gt;(.*?)&lt;\/sup&gt;/g</span><span class="p">,</span> <span class="s2">&quot;qqqq&quot;</span><span class="p">);</span>

    <span class="c1">// Remove any &quot;new line&quot;, &lt;br&gt; tags.</span>
    <span class="nx">t_new</span> <span class="o">=</span> <span class="nx">t_new</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;br&gt;/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>

    <span class="c1">//console.log(&quot;t = &quot;, t);</span>
    <span class="c1">//console.log(&quot;t_new = &quot;, t_new);</span>

    <span class="c1">// Convert the string expression to a array of tokens in postfix order.</span>
    <span class="kd">let</span> <span class="nx">postfix</span> <span class="o">=</span> <span class="nx">_infixToPostfix</span><span class="p">(</span><span class="nx">t_new</span><span class="p">);</span>
    <span class="c1">//console.log(&quot;postfix = &quot;, postfix);</span>

    <span class="c1">// Evaluate the expression and return a simplified string expression.</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">_evalPostfix</span><span class="p">(</span><span class="nx">postfix</span><span class="p">);</span>
    <span class="c1">//console.log(&quot;result  = &quot;, result);</span>

    <span class="c1">// Replace the &quot;qqqq&quot; place holder with a superscript.</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/qqqq/g</span><span class="p">,</span> <span class="s2">&quot;&lt;sup&gt;-1&lt;/sup&gt;&quot;</span><span class="p">);</span>
    <span class="c1">//console.log(&quot;result = &quot;, result);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="c1">// m is an HTML element that contains a matrix</span>
  <span class="kd">function</span> <span class="nx">_reduceMatrixTerms</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">columns</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">new_text</span><span class="p">;</span>

    <span class="nx">columns</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">m</span><span class="p">).</span><span class="nx">children</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">columns</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span> <span class="nx">c</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">row</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">columns</span><span class="p">[</span><span class="nx">c</span><span class="p">]).</span><span class="nx">children</span><span class="p">();</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">r</span> <span class="o">&lt;</span> <span class="nx">row</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span> <span class="nx">r</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">new_text</span> <span class="o">=</span> <span class="nx">_reduceTerm</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">row</span><span class="p">[</span><span class="nx">r</span><span class="p">]).</span><span class="nx">html</span><span class="p">());</span>
        <span class="c1">//console.log(&#39;reduce: &#39;, $(row[r]).text(), &#39; to &#39;, new_text);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">r</span> <span class="o">&lt;</span> <span class="nx">row</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">new_text</span> <span class="o">+=</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">row</span><span class="p">[</span><span class="nx">r</span><span class="p">]).</span><span class="nx">html</span><span class="p">(</span><span class="nx">new_text</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_reduceTerms</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">span</span><span class="p">,</span> <span class="nx">equation</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">num_children</span><span class="p">,</span> <span class="nx">j</span><span class="p">;</span>

    <span class="nx">span</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="nx">equation</span> <span class="o">=</span> <span class="nx">span</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>

    <span class="nx">children</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">equation</span><span class="p">).</span><span class="nx">children</span><span class="p">();</span>
    <span class="nx">num_children</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">num_children</span><span class="p">;</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">]).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;matrix_table&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_reduceMatrixTerms</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_deleteEquation</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">span</span><span class="p">,</span> <span class="nx">equation</span><span class="p">;</span>

    <span class="nx">span</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="nx">equation</span> <span class="o">=</span> <span class="nx">span</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">equation</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="c1">// console.log(element);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">operator</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">innerText</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_multiplyMatrix</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;=&#39;</span> <span class="o">||</span> <span class="nx">operator</span> <span class="o">===</span> <span class="s1">&#39;!=&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_assignment</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">===</span> <span class="s2">&quot;reduce&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_reduce</span><span class="p">();</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span> <span class="c1">// the reduce button</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">===</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_deleteEquation</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="c1">// end Matrixeq_directive</span>

<span class="c1">//=========================================================================</span>
<span class="kd">function</span> <span class="nx">Matrixeq_show</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">highlight</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">let</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">column</span><span class="p">,</span> <span class="nx">column_children</span><span class="p">,</span> <span class="nx">all_columns</span><span class="p">,</span> <span class="nx">equation</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">matches</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">id1</span><span class="p">,</span> <span class="nx">id2</span><span class="p">,</span> <span class="nx">all_columns1</span><span class="p">,</span> <span class="nx">all_columns2</span><span class="p">,</span> <span class="nx">rows</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">background_color_left</span><span class="p">,</span> <span class="nx">background_color_right</span><span class="p">;</span>

  <span class="c1">// Determine which row the element is on</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="nx">column</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
  <span class="nx">column_children</span> <span class="o">=</span> <span class="nx">column</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">column_children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">column_children</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">===</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">r</span> <span class="o">=</span> <span class="nx">j</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Determine which column the element is on</span>
  <span class="nx">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="nx">equation</span> <span class="o">=</span> <span class="nx">column</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
  <span class="nx">all_columns</span> <span class="o">=</span> <span class="nx">equation</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">all_columns</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">all_columns</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">===</span> <span class="nx">column</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">j</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Get the two original matrices that were multiplies for this matrix</span>
  <span class="nx">content</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">equation</span><span class="p">).</span><span class="nx">html</span><span class="p">();</span>
  <span class="nx">matches</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;!-- (.*?)\*(.*?) --&gt;/</span><span class="p">);</span>
  <span class="nx">id1</span> <span class="o">=</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>  <span class="c1">// highlight row</span>
  <span class="nx">id2</span> <span class="o">=</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>  <span class="c1">// highlight column</span>

  <span class="nx">left</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id1</span><span class="p">);</span>
  <span class="nx">right</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id2</span><span class="p">);</span>

  <span class="nx">background_color_left</span> <span class="o">=</span> <span class="nx">left</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;background-color&#39;</span><span class="p">);</span>
  <span class="nx">background_color_right</span> <span class="o">=</span> <span class="nx">right</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;background-color&#39;</span><span class="p">);</span>

  <span class="nx">all_columns1</span> <span class="o">=</span> <span class="nx">left</span><span class="p">.</span><span class="nx">children</span><span class="p">();</span>
  <span class="nx">all_columns2</span> <span class="o">=</span> <span class="nx">right</span><span class="p">.</span><span class="nx">children</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">highlight</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">all_columns1</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rows</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">all_columns1</span><span class="p">[</span><span class="nx">j</span><span class="p">]).</span><span class="nx">children</span><span class="p">();</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">rows</span><span class="p">[</span><span class="nx">r</span><span class="p">]).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span> <span class="s2">&quot;LightBlue&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">all_columns2</span><span class="p">[</span><span class="nx">c</span><span class="p">]).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span> <span class="s2">&quot;LightBlue&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">all_columns1</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rows</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">all_columns1</span><span class="p">[</span><span class="nx">j</span><span class="p">]).</span><span class="nx">children</span><span class="p">();</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">rows</span><span class="p">[</span><span class="nx">r</span><span class="p">]).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span> <span class="nx">background_color_left</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">all_columns2</span><span class="p">[</span><span class="nx">c</span><span class="p">]).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span> <span class="nx">background_color_right</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</body>
</html>
