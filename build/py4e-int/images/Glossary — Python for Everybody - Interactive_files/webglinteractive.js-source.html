<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title><title><no title></title></title>
  <meta http-equiv="content-type" content="text/html; charset=None">
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css">
</head>
<body>
<h2><title><no title></title></h2>

<div class="highlight"><pre><span></span><span class="c1">// webglinteractive.js - By: Dr. Wayne Brown, Fall 2017</span>
<span class="c1">// Description: functions and event handlers for the webglinteractive directive</span>

<span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

<span class="c1">//=========================================================================</span>
<span class="cm">/**</span>
<span class="cm"> * An object to handle webglinteractive directive functionality.</span>
<span class="cm"> * An instance of this object is created for each unique webglinteractive directive.</span>
<span class="cm"> * @param id - the runestone ID of the webglinteractive directive</span>
<span class="cm"> * @constructor</span>
<span class="cm"> */</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">WebglInteractive_directive</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">let</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="c1">// textarea DOM objects that are the placeholders for the CodeMirror editor panes</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">textareas</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="c1">// CodeMirror objects for code editing</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">file_names</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">code_mirrors</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="kd">let</span> <span class="nx">download_scene_name</span> <span class="o">=</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;_program&#39;</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">link_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="c1">// Set the height of the webgl_editors div so that it is the same height</span>
  <span class="c1">// as the HTML panel to its right.</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">set_height_of_webgl_editors</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">tabs_height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;_tab&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">();</span>

    <span class="c1">// Make the editor windows the same height as the canvas area</span>
    <span class="kd">let</span> <span class="nx">right_pane</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;_webgl_canvas&#39;</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">right_pane_height</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">right_pane</span><span class="p">).</span><span class="nx">height</span><span class="p">();</span>

    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;_webgl_row2&quot;</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="nx">right_pane_height</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">left_pane</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;_webgl_editors&#39;</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">left_pane</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="nx">right_pane_height</span><span class="p">);</span>

    <span class="c1">// The height of the editor window must subtract the height of the tabs</span>
    <span class="kd">let</span> <span class="nx">editor_height</span> <span class="o">=</span> <span class="nx">right_pane_height</span> <span class="o">-</span> <span class="nx">tabs_height</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">code_mirrors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">code_mirrors</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">setSize</span><span class="p">(</span><span class="s2">&quot;100%&quot;</span><span class="p">,</span> <span class="nx">editor_height</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">left_pane</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.CodeMirror-scroll&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;max-height&#39;</span><span class="p">,</span> <span class="s2">&quot;100em&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.CodeMirror&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;margin-bottom&quot;</span><span class="p">,</span><span class="s2">&quot;0&quot;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">bring_first_editor_to_front</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">list_id</span><span class="p">,</span> <span class="nx">tab_list_children</span><span class="p">,</span> <span class="nx">links</span><span class="p">;</span>
    <span class="nx">list_id</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;_tab&#39;</span><span class="p">;</span>
    <span class="nx">tab_list_children</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">list_id</span><span class="p">).</span><span class="nx">children</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tab_list_children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">links</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">tab_list_children</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">children</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">links</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">links</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="c1">// Load a data file. After it is loaded, the data is passed to the</span>
  <span class="c1">// appropriate codemirror HTML element.</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">createCodeMirrorEditor</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">file_name</span><span class="p">,</span> <span class="nx">file_extension</span><span class="p">,</span> <span class="nx">read_only</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">search_id</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;_textarea&quot;</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">my_text_area</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">search_id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">my_text_area</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">search_id</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>

      <span class="kd">let</span> <span class="nx">editor_options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">lineNumbers</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">lineWrapping</span><span class="o">:</span> <span class="kc">false</span>
      <span class="p">};</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">file_extension</span> <span class="o">===</span> <span class="s1">&#39;js&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">editor_options</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;javascript&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">file_extension</span> <span class="o">===</span> <span class="s1">&#39;html&#39;</span> <span class="o">||</span> <span class="nx">file_extension</span> <span class="o">===</span> <span class="s1">&#39;htm&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">editor_options</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;htmlmixed&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">file_extension</span> <span class="o">===</span> <span class="s1">&#39;css&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">editor_options</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;css&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">file_extension</span> <span class="o">===</span> <span class="s1">&#39;obj&#39;</span> <span class="o">||</span> <span class="nx">file_extension</span> <span class="o">===</span> <span class="s1">&#39;mtl&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">editor_options</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">editor_options</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;javascript&quot;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">read_only</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">editor_options</span><span class="p">[</span><span class="s1">&#39;readOnly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">let</span> <span class="nx">myCodeMirror</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">fromTextArea</span><span class="p">(</span><span class="nx">my_text_area</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">editor_options</span><span class="p">);</span>
      <span class="nx">myCodeMirror</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">file_names</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">file_name</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">code_mirrors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">myCodeMirror</span><span class="p">);</span>

      <span class="kd">let</span> <span class="nx">line_options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">readOnly</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">className</span><span class="o">:</span> <span class="s2">&quot;webgl_editor_highlight&quot;</span> <span class="p">};</span>

      <span class="c1">// Limit the lines in a HTML file that can be edited</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">read_only</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">myCodeMirror</span><span class="p">.</span><span class="nx">getDoc</span><span class="p">();</span>
        <span class="kd">let</span> <span class="nx">arrayOfLines</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">last_line</span> <span class="o">=</span> <span class="nx">arrayOfLines</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">markText</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">last_line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">arrayOfLines</span><span class="p">[</span><span class="nx">last_line</span><span class="p">].</span><span class="nx">length</span><span class="p">},</span> <span class="nx">line_options</span><span class="p">);</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">file_extension</span> <span class="o">===</span> <span class="s1">&#39;html&#39;</span> <span class="o">||</span> <span class="nx">file_extension</span> <span class="o">===</span> <span class="s1">&#39;htm&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Only allow editing of the HTML body code that contains page layout</span>
        <span class="c1">// Separate the html code into lines.</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r\n/g</span><span class="p">,</span> <span class="s2">&quot;\n&quot;</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">arrayOfLines</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">bodyStartLine</span><span class="p">,</span> <span class="nx">lastOfBodyLine</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">arrayOfLines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">arrayOfLines</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;&lt;body&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">bodyStartLine</span> <span class="o">=</span> <span class="nx">j</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">arrayOfLines</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;&lt;!-- Load the JavaScript libraries&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">lastOfBodyLine</span> <span class="o">=</span> <span class="nx">j</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// Get the document of the CodeMirror object</span>
        <span class="kd">let</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">myCodeMirror</span><span class="p">.</span><span class="nx">getDoc</span><span class="p">();</span>

        <span class="kd">let</span> <span class="nx">data_beginning</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
        <span class="kd">let</span> <span class="nx">data_body_start</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">bodyStartLine</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">arrayOfLines</span><span class="p">[</span><span class="nx">bodyStartLine</span><span class="p">].</span><span class="nx">length</span><span class="p">};</span>

        <span class="kd">let</span> <span class="nx">data_body_end</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lastOfBodyLine</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
        <span class="kd">let</span> <span class="nx">data_end</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">arrayOfLines</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">arrayOfLines</span><span class="p">[</span><span class="nx">arrayOfLines</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span><span class="p">};</span>

        <span class="c1">// Mark the lines that are readonly</span>
        <span class="kd">let</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">markText</span><span class="p">(</span><span class="nx">data_beginning</span><span class="p">,</span> <span class="nx">data_body_start</span><span class="p">,</span> <span class="nx">line_options</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">m2</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">markText</span><span class="p">(</span><span class="nx">data_body_end</span><span class="p">,</span> <span class="nx">data_end</span><span class="p">,</span> <span class="nx">line_options</span><span class="p">);</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">file_extension</span> <span class="o">===</span> <span class="s1">&#39;obj&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Don&#39;t allow editing of references to MTL files</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r\n/g</span><span class="p">,</span> <span class="s2">&quot;\n&quot;</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">arrayOfLines</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">myCodeMirror</span><span class="p">.</span><span class="nx">getDoc</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">arrayOfLines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">arrayOfLines</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;mtllib&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">doc</span><span class="p">.</span><span class="nx">markText</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">arrayOfLines</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">length</span><span class="p">},</span> <span class="nx">line_options</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">file_extension</span> <span class="o">===</span> <span class="s1">&#39;mtl&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Don&#39;t allow editing of texture map image references</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r\n/g</span><span class="p">,</span> <span class="s2">&quot;\n&quot;</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">arrayOfLines</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">myCodeMirror</span><span class="p">.</span><span class="nx">getDoc</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">arrayOfLines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">arrayOfLines</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;map_Kd&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">doc</span><span class="p">.</span><span class="nx">markText</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">arrayOfLines</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">length</span><span class="p">},</span> <span class="nx">line_options</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

    <span class="p">}</span>
  <span class="p">};</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">show_webgl</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">whichSection</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">myCheckboxId</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">words</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">myCodeId</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_webgl_editors&#39;</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">myCanvasId</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_webgl_canvas&#39;</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">myOutputId</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_webgl_output&#39;</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">myCodeCheckBox</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_show_code&#39;</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">myCanvasCheckBox</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_show_canvas&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">myCheckboxId</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;checked&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// Checkbox was just checked - so show</span>
      <span class="k">switch</span> <span class="p">(</span><span class="nx">whichSection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="c1">// show code</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">myCodeId</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">myCanvasId</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;:visible&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">myCodeId</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="s1">&#39;50%&#39;</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">myCanvasId</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="s2">&quot;50%&quot;</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">myCodeId</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="s2">&quot;100%&quot;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="c1">// show canvas</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">myCanvasId</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">myCodeId</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;:visible&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">myCodeId</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="s2">&quot;50%&quot;</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">myCanvasId</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="s2">&quot;50%&quot;</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">myCanvasId</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="s2">&quot;100%&quot;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="c1">// show text output</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">myOutputId</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Checkbox was unchecked - so hide</span>
      <span class="k">switch</span> <span class="p">(</span><span class="nx">whichSection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="c1">// hide code</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">myCodeId</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">myCanvasId</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="s2">&quot;100%&quot;</span><span class="p">);</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">myCanvasCheckBox</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;checked&#39;</span><span class="p">,</span> <span class="s1">&#39;checked&#39;</span><span class="p">);</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">myCanvasId</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="c1">// hide canvas</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">myCanvasId</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">myCodeId</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="s2">&quot;100%&quot;</span><span class="p">);</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">myCodeCheckBox</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;checked&#39;</span><span class="p">,</span><span class="s1">&#39;checked&#39;</span><span class="p">);</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">myCodeId</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">myOutputId</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_updateHTML</span><span class="p">(</span><span class="nx">file_name</span><span class="p">,</span> <span class="nx">code_mirror</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">start_pos</span><span class="p">,</span> <span class="nx">end_pos</span><span class="p">,</span> <span class="nx">str_length</span><span class="p">;</span>

    <span class="c1">// Get the text from the codemirror editor</span>
    <span class="nx">text</span> <span class="o">=</span> <span class="nx">code_mirror</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>

    <span class="c1">//   # Extract only the body of the HTML code</span>
    <span class="nx">start_pos</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;&lt;body&#39;</span><span class="p">);</span>
    <span class="nx">start_pos</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="nx">start_pos</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">end_pos</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;&lt;/body&gt;&quot;</span><span class="p">,</span> <span class="nx">start_pos</span><span class="p">);</span>
    <span class="nx">str_length</span> <span class="o">=</span> <span class="nx">end_pos</span> <span class="o">-</span> <span class="nx">start_pos</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">start_pos</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="nx">str_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">start_pos</span><span class="p">,</span><span class="nx">str_length</span><span class="p">);</span>

      <span class="c1">// Don&#39;t reload any scripts, so remove them from the text</span>
      <span class="c1">// Remove single line &lt;scripts&gt; first</span>
      <span class="kd">let</span> <span class="nx">regexp</span> <span class="o">=</span> <span class="sr">/&lt;script.*script&gt;\n/gi</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">matches_array</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">regexp</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span> <span class="nx">matches_array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">matches_array</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Remove multiple line &lt;scripts&gt; now</span>
      <span class="nx">regexp</span> <span class="o">=</span> <span class="sr">/&lt;script(.|\n)*script&gt;\n/gi</span><span class="p">;</span>
      <span class="nx">matches_array</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">regexp</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span> <span class="nx">matches_array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">matches_array</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Put the text into the web page</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;_webgl_canvas&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_updateOBJ</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">file_name</span><span class="p">,</span> <span class="nx">code_mirror</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">text</span><span class="p">;</span>

    <span class="c1">// Get the text from the codemirror editor</span>
    <span class="nx">text</span> <span class="o">=</span> <span class="nx">code_mirror</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>

    <span class="c1">// Update the model data definitions</span>
    <span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">download</span><span class="p">.</span><span class="nx">parseFilename</span><span class="p">(</span><span class="nx">file_name</span><span class="p">).</span><span class="nx">filename</span><span class="p">;</span>
    <span class="nx">download</span><span class="p">.</span><span class="nx">model_data_dictionary</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_updatePLY</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">file_name</span><span class="p">,</span> <span class="nx">code_mirror</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">text</span><span class="p">;</span>

    <span class="c1">// Get the text from the codemirror editor</span>
    <span class="nx">text</span> <span class="o">=</span> <span class="nx">code_mirror</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>

    <span class="c1">// Update the model data definitions</span>
    <span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">download</span><span class="p">.</span><span class="nx">parseFilename</span><span class="p">(</span><span class="nx">file_name</span><span class="p">).</span><span class="nx">filename</span><span class="p">;</span>
    <span class="nx">download</span><span class="p">.</span><span class="nx">model_data_dictionary</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_updateMTL</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">file_name</span><span class="p">,</span> <span class="nx">code_mirror</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">text</span><span class="p">;</span>

    <span class="c1">// Get the text from the codemirror editor</span>
    <span class="nx">text</span> <span class="o">=</span> <span class="nx">code_mirror</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>

    <span class="c1">// Update the material data definition</span>
    <span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">download</span><span class="p">.</span><span class="nx">parseFilename</span><span class="p">(</span><span class="nx">file_name</span><span class="p">).</span><span class="nx">filename</span><span class="p">;</span>
    <span class="nx">download</span><span class="p">.</span><span class="nx">materials_data_dictionary</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>

    <span class="c1">// Update the material objects based on the changed MTL file data.</span>
    <span class="nx">CreateObjModelMaterials</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">download</span><span class="p">.</span><span class="nx">materials_dictionary</span><span class="p">[</span><span class="nx">name</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_updateShader</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">file_name</span><span class="p">,</span> <span class="nx">file_extension</span><span class="p">,</span> <span class="nx">code_mirror</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">text</span><span class="p">;</span>

    <span class="c1">// Get the text from the codemirror editor</span>
    <span class="nx">text</span> <span class="o">=</span> <span class="nx">code_mirror</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>

    <span class="c1">// Update the shader data definitions</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">file_extension</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;vert&#39;</span><span class="o">:</span>
        <span class="nx">download</span><span class="p">.</span><span class="nx">vshaders</span><span class="p">[</span><span class="nx">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;frag&#39;</span><span class="o">:</span>
        <span class="nx">download</span><span class="p">.</span><span class="nx">fshaders</span><span class="p">[</span><span class="nx">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_updateJavaScript</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">code_mirror</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">text</span><span class="p">;</span>

    <span class="c1">// Get the text from the codemirror editor</span>
    <span class="nx">text</span> <span class="o">=</span> <span class="nx">code_mirror</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>

    <span class="c1">// Evaluate the text in the global context. This will replace any</span>
    <span class="c1">// existing code with matching names.</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;try { &quot;</span> <span class="o">+</span> <span class="nx">text</span> <span class="o">+</span> <span class="s2">&quot;} catch(e) { console.log(&#39;test&#39;, e) }&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">download</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">displayError</span><span class="p">(</span><span class="s1">&#39;Error reloading &#39;</span> <span class="o">+</span> <span class="nx">filename</span> <span class="o">+</span> <span class="s1">&#39;.js&#39;</span><span class="p">);</span>
      <span class="nx">download</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">displayError</span><span class="p">(</span><span class="s1">&#39;Error: &quot;&#39;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;&quot; &#39;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_display_error</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">download</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">displayError</span><span class="p">(</span><span class="s2">&quot;Error: &quot;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">restart</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Get the SceneDownload object for this scene</span>
    <span class="kd">let</span> <span class="nx">download</span><span class="p">,</span> <span class="nx">filename_parts</span><span class="p">;</span>

    <span class="nx">download</span> <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="nx">download_scene_name</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">download</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Clear all of the messages in the output window</span>
      <span class="nx">download</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">clearMessages</span><span class="p">();</span>

      <span class="c1">// Delete all shaders and vob&#39;s for all models for the scene</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">download</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="k">delete</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_display_error</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Get data from the editor buffers and put the new definitions</span>
      <span class="c1">// in appropriate places.</span>
      <span class="kd">let</span> <span class="nx">file_extension</span><span class="p">,</span> <span class="nx">file_name</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">code_mirrors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">filename_parts</span> <span class="o">=</span> <span class="nx">download</span><span class="p">.</span><span class="nx">parseFilename</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">file_names</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
        <span class="nx">file_name</span> <span class="o">=</span> <span class="nx">filename_parts</span><span class="p">.</span><span class="nx">filename</span><span class="p">;</span>
        <span class="nx">file_extension</span> <span class="o">=</span> <span class="nx">filename_parts</span><span class="p">.</span><span class="nx">extension</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="nx">file_extension</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">case</span> <span class="s2">&quot;html&quot;</span><span class="o">:</span>
            <span class="nx">_updateHTML</span><span class="p">(</span><span class="nx">file_name</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">code_mirrors</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
            <span class="nx">download</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">displayInfo</span><span class="p">(</span><span class="s2">&quot;Updated definition of html code &#39;&quot;</span> <span class="o">+</span> <span class="nx">file_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s2">&quot;js&quot;</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_updateJavaScript</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">file_name</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">code_mirrors</span><span class="p">[</span><span class="nx">j</span><span class="p">]))</span> <span class="p">{</span>
              <span class="nx">download</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">displayInfo</span><span class="p">(</span><span class="s2">&quot;Updated definition of javascript code &#39;&quot;</span> <span class="o">+</span> <span class="nx">file_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s2">&quot;obj&quot;</span><span class="o">:</span>
            <span class="nx">_updateOBJ</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">file_name</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">code_mirrors</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
            <span class="nx">download</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">displayInfo</span><span class="p">(</span><span class="s2">&quot;Updated definition of model &#39;&quot;</span> <span class="o">+</span> <span class="nx">file_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">file_extension</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s2">&quot;ply&quot;</span><span class="o">:</span>
            <span class="nx">_updatePLY</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">file_name</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">code_mirrors</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
            <span class="nx">download</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">displayInfo</span><span class="p">(</span><span class="s2">&quot;Updated definition of model &#39;&quot;</span> <span class="o">+</span> <span class="nx">file_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">file_extension</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s2">&quot;mtl&quot;</span><span class="o">:</span>
            <span class="nx">_updateMTL</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">file_name</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">code_mirrors</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
            <span class="nx">download</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">displayInfo</span><span class="p">(</span><span class="s2">&quot;Updated definition of model material &#39;&quot;</span> <span class="o">+</span> <span class="nx">file_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">file_extension</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s2">&quot;vert&quot;</span><span class="o">:</span>
          <span class="k">case</span> <span class="s2">&quot;frag&quot;</span><span class="o">:</span>
            <span class="nx">_updateShader</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">file_name</span><span class="p">,</span> <span class="nx">file_extension</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">code_mirrors</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
            <span class="nx">download</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">displayInfo</span><span class="p">(</span><span class="s2">&quot;Updated definition of shader &#39;&quot;</span> <span class="o">+</span> <span class="nx">file_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">file_extension</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">default</span><span class="o">:</span>
            <span class="nx">download</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">displayError</span><span class="p">(</span><span class="s2">&quot;Unrecognized file type for &#39;&quot;</span> <span class="o">+</span> <span class="nx">file_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">file_extension</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// Restart the WebGL program with its new data.</span>
      <span class="nx">download</span><span class="p">.</span><span class="nx">initializeRendering</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_display_error</span><span class="p">(</span><span class="nx">download</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">};</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="cm">/* function _escapeData(str) {</span>
<span class="cm">    return str</span>
<span class="cm">      .replace(/\n/g, &#39;%0A&#39;)</span>
<span class="cm">      .replace(/ /g, &#39;%20&#39;)</span>
<span class="cm">      .replace(/,/g, &#39;%2C&#39;)</span>
<span class="cm">      .replace(/&#39;/g, &#39;%27&#39;)</span>
<span class="cm">      .replace(/&quot;/g, &#39;%22&#39;);</span>
<span class="cm">  } */</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="cm">/**</span>
<span class="cm">   * Download one file to the clients download folder.</span>
<span class="cm">   * @param url The URL to the file to download</span>
<span class="cm">   */</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">downloadOneFile</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">url</span> <span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Create a unique id for the link that will hold the data</span>
    <span class="nx">link_counter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">link_id</span> <span class="o">=</span> <span class="s1">&#39;id_&#39;</span> <span class="o">+</span> <span class="nx">link_counter</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>

    <span class="c1">// Create a link to the file. The download will make it save the</span>
    <span class="c1">// file to the client&#39;s disk.</span>
    <span class="kd">let</span> <span class="nx">link</span> <span class="o">=</span> <span class="s1">&#39;&lt;a id=&quot;&#39;</span> <span class="o">+</span> <span class="nx">link_id</span> <span class="o">+</span> <span class="s1">&#39;&quot; href=&quot;&#39;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;&quot; download&gt;&lt;span&gt;temp&lt;/span&gt;&lt;/a&gt;&#39;</span><span class="p">;</span>

    <span class="c1">// Add the link element to the DOM body</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">link</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">);</span>

    <span class="c1">// Make the link execute</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">link_id</span> <span class="o">+</span> <span class="s2">&quot; span&quot;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">);</span>

    <span class="c1">// Remove the link. It&#39;s only purpose was to set up the download</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">link_id</span><span class="p">).</span><span class="nx">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">saveEditorData</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">my_blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">data</span><span class="p">],</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;text/plain&quot;</span> <span class="p">}</span> <span class="p">);</span>
    <span class="nx">saveAs</span><span class="p">(</span> <span class="nx">my_blob</span><span class="p">,</span> <span class="nx">fileName</span> <span class="p">);</span>
  <span class="p">};</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="cm">/**</span>
<span class="cm">   * Given a URL that is a relative reference, convert it to an absolute reference.</span>
<span class="cm">   * @param url</span>
<span class="cm">   * @returns String that contains an absolute URL to the resource.</span>
<span class="cm">   * @private</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">_qualifyURL</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">el</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">innerHTML</span><span class="o">=</span> <span class="s1">&#39;&lt;a href=&quot;&#39;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;x&lt;/a&gt;&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">el</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="kd">function</span> <span class="nx">_get_download_file_names</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">all_filenames</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">file_url</span><span class="p">;</span>

    <span class="c1">// Get the name of the HTML file that is stored in a hidden &lt;span&gt;</span>
    <span class="c1">// under the id + &quot;_webgl_canvas&quot; &lt;div&gt;</span>
    <span class="kd">let</span> <span class="nx">canvas_div</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;_webgl_canvas&quot;</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">html_filename</span> <span class="o">=</span> <span class="nx">canvas_div</span><span class="p">.</span><span class="nx">children</span><span class="p">()[</span><span class="mi">0</span><span class="p">].</span><span class="nx">textContent</span><span class="p">;</span>
    <span class="nx">all_filenames</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">html_filename</span><span class="p">);</span>

    <span class="c1">// Get the src file names of all the &lt;script&gt; tags</span>
    <span class="kd">let</span> <span class="nx">all_scripts</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;_webgl_canvas &gt; script&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span> <span class="nx">all_scripts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">file_url</span> <span class="o">=</span> <span class="nx">all_scripts</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">src</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">file_url</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">all_filenames</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">file_url</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">all_filenames</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">downloadAllFiles</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">all_filenames</span> <span class="o">=</span> <span class="nx">_get_download_file_names</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">all_filenames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">downloadOneFile</span><span class="p">(</span><span class="nx">all_filenames</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="c1">//-----------------------------------------------------------------------</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">downloadEditedFiles</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">file_names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">saveEditorData</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">code_mirrors</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">getValue</span><span class="p">(),</span> <span class="nx">self</span><span class="p">.</span><span class="nx">file_names</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">};</span>

<span class="p">};</span> <span class="c1">// end WebglInteractive_directive</span>
</pre></div>
</body>
</html>
